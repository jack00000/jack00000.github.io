<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.6" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.6">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.6" color="#222">














<meta name="description" content="//有edit权限  查出来 却为false123Login login = ActionFunc.getLogin(req);PmChecker pChecker = login.getPmChecker();Boolean edit = pChecker.check(ztj_id, ResOper.EDIT.getOperId()); Boolean view = pChecker.check">
<meta property="og:type" content="article">
<meta property="og:title" content="遇到的问题">
<meta property="og:url" content="http://yoursite.com/2019/01/17/现阶段遇到的问题/index.html">
<meta property="og:site_name" content="HEXO">
<meta property="og:description" content="//有edit权限  查出来 却为false123Login login = ActionFunc.getLogin(req);PmChecker pChecker = login.getPmChecker();Boolean edit = pChecker.check(ztj_id, ResOper.EDIT.getOperId()); Boolean view = pChecker.check">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-01-17T08:14:46.832Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="遇到的问题">
<meta name="twitter:description" content="//有edit权限  查出来 却为false123Login login = ActionFunc.getLogin(req);PmChecker pChecker = login.getPmChecker();Boolean edit = pChecker.check(ztj_id, ResOper.EDIT.getOperId()); Boolean view = pChecker.check">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.6',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: 'undefined',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/01/17/现阶段遇到的问题/"/>





  <title>遇到的问题 | HEXO</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HEXO</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
            Schedule
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
            Sitemap
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/17/现阶段遇到的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="DEMO">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/18373908?s=400&u=026b7daa8652066dead5a989dd5e14fca44ee5dd&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HEXO">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">遇到的问题</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-17T20:13:10+08:00">
                2019-01-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/亿信华辰/" itemprop="url" rel="index">
                    <span itemprop="name">亿信华辰</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/17/现阶段遇到的问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/01/17/现阶段遇到的问题/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>//有edit权限  查出来 却为false<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Login login = ActionFunc.getLogin(req);</span><br><span class="line">PmChecker pChecker = login.getPmChecker();</span><br><span class="line">Boolean edit = pChecker.check(ztj_id, ResOper.EDIT.getOperId());</span><br></pre></td></tr></table></figure></p>
<pre><code>Boolean view = pChecker.check(ztj_id, ResOper.VIEW.getOperId());
          Boolean viewchild = pChecker.check(ztj_id, ResOper.VIEWCHILD.getOperId());
          Boolean mana=pChecker.check(ztj_id, ResOper.MANAGE.getOperId());
          Boolean authorize=pChecker.check(ztj_id, ResOper.AUTHORIZE.getOperId());
          Boolean denyauthorize=pChecker.check(ztj_id, ResOper.AUTHORIZE.getOperId());
          Boolean edit = pChecker.check(ztj_id, ResOper.EDIT.getOperId());
          Boolean add = pChecker.check(ztj_id, ResOper.ADD.getOperId());
          Boolean del = pChecker.check(ztj_id, ResOper.DELETE.getOperId());
</code></pre><h1 id="应用1-完全控制-应用2-查看-编辑-应用3-查看"><a href="#应用1-完全控制-应用2-查看-编辑-应用3-查看" class="headerlink" title="应用1:完全控制   应用2.查看 编辑 应用3.查看"></a>应用1:完全控制   应用2.查看 编辑 应用3.查看</h1><p>{“id”:”EBI$7$CYKR67IYIOPZK2ZYYYWM99YRL3YOFZY1”,”name”:”应用1”,”view”:true,”viewchild”:true,”mana”:true,”authorize”:true,”denyauthorize”:true,”del”:true,”add”:true,”edit”:true}<br>{“id”:”EBI$7$I6KIN7LRVSA7MU76AUZYIU9UEL69RC5M”,”name”:”应用2”,”view”:true,”viewchild”:true,”mana”:false,”authorize”:false,”denyauthorize”:false,”del”:false,”add”:false,”edit”:false}<br>{“id”:”EBI$7$3FCTFME0ELSPQFPFQQULWIIOLXFLATIY”,”name”:”应用3”,”view”:true,”viewchild”:true,”mana”:false,”authorize”:false,”denyauthorize”:false,”del”:false,”add”:false,”edit”:false}</p>
<p>package com.esen.bi.jsp.action.user.rptcooldsn;</p>
<p>import java.io.BufferedReader;<br>import java.io.File;<br>import java.io.FileInputStream;<br>import java.io.IOException;<br>import java.io.InputStream;<br>import java.io.InputStreamReader;<br>import java.io.OutputStream;<br>import java.io.UnsupportedEncodingException;<br>import java.util.ArrayList;<br>import java.util.Arrays;<br>import java.util.Comparator;<br>import java.util.HashMap;<br>import java.util.List;<br>import java.util.Map;<br>import java.util.UUID;</p>
<p>import javax.servlet.http.HttpServletRequest;<br>import javax.servlet.http.HttpServletResponse;</p>
<p>import org.apache.commons.fileupload.FileItem;<br>import org.json.JSONArray;<br>import org.json.JSONException;<br>import org.json.JSONObject;<br>import org.springframework.stereotype.Controller;<br>import org.springframework.web.bind.annotation.RequestMapping;<br>import org.w3c.dom.DOMException;<br>import org.w3c.dom.Document;<br>import org.w3c.dom.Element;<br>import org.w3c.dom.Node;<br>import org.w3c.dom.NodeList;</p>
<p>import com.esen.bi.dw.meta.DWMgr;<br>import com.esen.bi.dw.meta.DWSubjectSet;<br>import com.esen.bi.jsp.action.user.fact.ActionTaskMgr;<br>import com.esen.bi.jsp.util.ActionFunc4BI;<br>import com.esen.bi.reportcool.base.CWidgetUtil;<br>import com.esen.bi.reportcool.base.cwidget.CWHtmlContentMgr;<br>import com.esen.bi.reportcool.syshtml.CWidgetHtmlConfCache;<br>import com.esen.bi.reportcool.syshtml.CoolSysWidgetMgr;<br>import com.esen.bi.server.ClusterMgrBI;<br>import com.esen.exception.Exception4I18N;<br>import com.esen.irpt.login.Login4BI;<br>import com.esen.irpt.security3.PermissionChecker;</p>
<p>import com.esen.irpt.server.ResourceId4BI;<br>import com.esen.irpt.server.ResourceIdTypes;<br>import com.esen.irpt.server.Server;<br>import com.esen.platform.action.util.ActionFunc;<br>import com.esen.platform.login.Login;<br>import com.esen.platform.resource.ReleasableObj;<br>import com.esen.platform.resource.ResOper;<br>import com.esen.platform.resource.ResourceId;<br>import com.esen.platform.security.PmChecker;<br>import com.esen.platform.security.PmCheckerFactory;<br>import com.esen.platform.server.EsenServer;<br>import com.esen.util.ArrayFunc;<br>import com.esen.util.ExceptionHandler;<br>import com.esen.util.FileFunc;<br>import com.esen.util.StrFunc;<br>import com.esen.util.XmlFunc;<br>import com.esen.util.cluster.ClusterMessage;<br>import com.esen.util.cluster.ClusterMessageFactory;<br>import com.esen.util.i18n.I18N;<br>import com.esen.util.tmpfile.DefaultTempFileFactory;<br>import com.esen.vfs2.Vfs2;<br>import com.esen.vfs2.VfsException;<br>import com.esen.vfs2.VfsFile2;<br>import com.esen.weblib.ClientResult;<br>import com.esen.weblib.action.Action_Js;<br>import com.esen.weblib.download.HttpDownloadCacher;<br>import com.esen.weblib.upload.HttpServletRequestEx;<br>import com.esen.weblib.util.ServletFunc;<br>import com.esen.zip.ZipEntry;<br>import com.esen.zip.ZipOutputStream;<br>import com.google.gson.JsonObject;</p>
<p>/**</p>
<ul>
<li>此类负责，HTML组件的管理，增删改查等操作<br>*</li>
<li>接口说明： 调用方式如:edithtmlwidget.do?action=xxx<br>*</li>
<li>@author zqj</li>
<li><p>@date 2017.12.13<br>*/<br>@Controller<br>@RequestMapping(“/edithtmlwidget”)<br>public class ActionEditHtmlWidget extends Action_Js {</p>
<p> /**</p>
<ul>
<li><p>html组件的编辑界面<br>*/<br>private static final String HTMLEDITOR = “/ebi/user/coolrptdsn/htmlwidgeteditor/chtmleditor”;</p>
<p>/**</p>
</li>
<li>html组件的预览界面<br>*/<br>private static final String HTMLSHOW = “/ebi/user/coolrptdsn/htmlwidgeteditor/htmlwidgetshow/chtmlshow”;<br>private static final String HTMLSHOWFORSAVE = “/ebi/user/coolrptdsn/htmlwidgeteditor/htmlwidgetshow/chtmlshowforsave”;<br>/**</li>
<li><p>编辑界面工具栏存放的位置<br>*/<br>private static final String UICONFIG_PATH_PRE = “ebi/user/coolrptdsn/htmlwidgeteditor/“;</p>
<p>private static final String SYSWIDGETDIR = CWidgetUtil.SYSWIDGETDIR;<br>private static final String USERWIDGETDIR = CWidgetUtil.USERWIDGETDIR;<br>private static final String PREVIEWPAGE = “coolwidgetimg”;</p>
<p>private static final String CONF_PROP_ID = CWidgetUtil.CONF_PROP_ID;<br>private static final String CONF_PROP_CAP = “caption”;<br>private static final String CONF_PROP_IMG = “img”;<br>/**</p>
</li>
<li>存属性列表的标签名<br>*/<br>private static final String CONF_PROP_COMMATTR = “comattr”;<br>/**</li>
<li><p>属性中的默认值标签名<br>*/<br>private static final String CONF_PROP_NAME = “name”;<br>private static final String CONF_PROP_DEFATTR = “defattr”;</p>
<p>@Override<br>public String jsexecute(HttpServletRequest req, HttpServletResponse res,</p>
<pre><code>ClientResult result) throws Exception {
</code></pre><p> // 检查是否登录<br> Login4BI login = ActionFunc4BI.getLogin(req);<br> login.checkLogined();</p>
<p> // 参数<br> String action = req.getParameter(“action”);<br> try {</p>
<pre><code>if (StrFunc.isNull(action)
        || &quot;showeditpage&quot;.equalsIgnoreCase(action)) {
    // 跳转到组件编辑界面的ftl
    return showEditPage(req, res);
} else if (&quot;showpreviewpage&quot;.equalsIgnoreCase(action)) {
    // 跳转到组件预览界面的ftl
    return showPreviewPage(req, res);
} else if (&quot;getwidgetjson&quot;.equalsIgnoreCase(action)) {
    // 获得组件的json格式
    getWidgetJson(req, result);
} else if (&quot;savewidget&quot;.equalsIgnoreCase(action)) {
    // 保存组件
    saveWidget(req, result);
} else if (&quot;deletewidget&quot;.equalsIgnoreCase(action)) {
    // 删除组件
    deleteWidget(req, result);
} else if (&quot;clonewidget&quot;.equalsIgnoreCase(action)) {
    // 克隆组件
    cloneWidget(req, result);
} else if (&quot;exportwidget&quot;.equalsIgnoreCase(action)) {
    export(req, res, result);
} else if (&quot;refreshsys&quot;.equalsIgnoreCase(action)) {
    refreshSysHtml(req, result);
} else if (&quot;import&quot;.equalsIgnoreCase(action)) {
    HttpServletRequestEx hsr = new HttpServletRequestEx(req);
    importZip(res, req, result, hsr);
} else if (&quot;newfolder&quot;.equalsIgnoreCase(action)) {
    // 新建分组
    newFolder(req, result);
} else if (&quot;delfolder&quot;.equalsIgnoreCase(action)) {
    // 删除分组
    deleteFolder(req, result);
} else if (&quot;renamefolder&quot;.equalsIgnoreCase(action)) {
    // 重命名分组
    renameFolder(req, result);
} else if (&quot;renamewidget&quot;.equalsIgnoreCase(action)) {
    // 重命名组件
    renameWidget(req, result);
} else if (&quot;list&quot;.equalsIgnoreCase(action)) {
    // 罗列分组下的分组和组件列表
    doList(req, result);
} else if (&quot;showpreviewpageForSave&quot;.equalsIgnoreCase(action)) {
    // 跳转到组件预览界面的ftl
    return showPreviewPageForSave(req, res);
} else if (&quot;reload&quot;.equalsIgnoreCase(action)) {
    // 重新加载酷屏HTML组件缓存（移除额外的分组配置缓存、移除HTML组件JSON缓存）
    this.reload(req);
} else if (&quot;delSeletes&quot;.equalsIgnoreCase(action)) {
    // 删除选中的组件和分组
    delSeletes(req, result);
} else if (&quot;moveTo&quot;.equalsIgnoreCase(action)) {
    // 移动选中的组件和分组
    moveTo(req, result);
} else if (&quot;getRoles&quot;.equalsIgnoreCase(action)){
    getRoles(req, res, result);
}
</code></pre><p> } catch (Exception ex) {</p>
<pre><code>ExceptionHandler.rethrowRuntimeException(ex);
</code></pre><p> }<br> return null;<br>}</p>
<p>/**</p>
</li>
<li>移动到指定分组<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li>@throws Exception4I18N</li>
<li><p>@throws DOMException<br>*/<br>private void moveTo(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws DOMException, Exception4I18N {
</code></pre><p> String basepath = req.getParameter(“basepath”);<br> String floderName = req.getParameter(“aimdir”);<br> String ids = req.getParameter(“ids”);<br> String items[] = ids.split(“,”);<br> List<string> widgetList = filterRepetition(items, false);</string></p>
<p> // 对路径做处理<br> String groups[] = floderName.split(“/“);<br> List<string> newGroups = new ArrayList<string>();<br> for (int i = 0, len = groups.length; i &lt; len; i++) {</string></string></p>
<pre><code>if (!StrFunc.isNull(groups[i]))
    newGroups.add(groups[i]);
</code></pre><p> }<br> if (newGroups.size() != 0) {</p>
<pre><code>floderName = StrFunc.ensureStartWith(
        ArrayFunc.list2Str(newGroups, &quot;/&quot;), &quot;/&quot;);
</code></pre><p> } else {</p>
<pre><code>floderName = &quot;/&quot;;
</code></pre><p> }<br> // CWidgetUtil.getWidgetConfCache(basepath.substring(0,basepath.lastIndexOf(“/“))).moveTo(floderName,<br> // widgetList);<br> CWidgetUtil.getWidgetConfCache(</p>
<pre><code>basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;))).moveTo(
floderName, widgetList, basepath);
</code></pre><p> result.getWriter().write(“ok”);<br>}</p>
<p>/**</p>
</li>
<li>删除选中的组件和分组<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li><p>@throws Exception<br>*/<br>private void delSeletes(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> // 用户自定义分组，删除自己和下面所有的分组和文件<br> String path = req.getParameter(“path”);<br> String basepath = req.getParameter(“basepath”);<br> if (StrFunc.isNull(path)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackpath&quot;,
        &quot;参数path没有指定.&quot;);
</code></pre><p> }<br> String paths[] = path.split(“,”);<br> List<string> widgetAndFloderPaths = filterRepetition(paths, false);<br> // 存放删除组件的信息的JSONArray对象,用于修改xml<br> JSONArray array = new JSONArray();<br> JSONObject json;<br> boolean isGroup = false;<br> String delPath;<br> for (int i = 0, len = widgetAndFloderPaths.size(); i &lt; len; i++) {</string></p>
<pre><code>String name = FileFunc.extractFileName(widgetAndFloderPaths.get(i));
// 单个组件直接删除
if (widgetAndFloderPaths.get(i).endsWith(&quot;.json&quot;)) {
    name = FileFunc.excludeFileExt(name);
    // 删除缓存和vfs文件
    delPath = widgetAndFloderPaths.get(i);
} else {
    isGroup = true;
    // 分组的话要拿到所有组件和分组节点删除，返回所有组件的id
    delPath = widgetAndFloderPaths.get(i).substring(0,
            widgetAndFloderPaths.get(i).lastIndexOf(&quot;/&quot;));
}
json = new JSONObject();
json.put(&quot;isGroup&quot;, isGroup);
json.put(&quot;name&quot;, name);
json.put(&quot;path&quot;, delPath);
array.put(json);
isGroup = false;
</code></pre><p> }</p>
<p> // 删除缓存，然后拿到返回的id，删除vfs上的资源<br> List<string> allWidgets = CWidgetUtil.getWidgetConfCache(</string></p>
<pre><code>basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;))).delSelets(
array);
</code></pre><p> if (allWidgets != null &amp;&amp; allWidgets.size() != 0) {</p>
<pre><code>for (int j = 0; j &lt; allWidgets.size(); j++) {
    CWHtmlContentMgr.getInstance().delete(basepath,
            allWidgets.get(j));
}
</code></pre><p> }</p>
<p> if (allWidgets.size() != 0) {</p>
<pre><code>deletePreviewImg(basepath, allWidgets.toArray(new String[0]));
// 把删除的组件id串传给前台
result.getWriter().write(ArrayFunc.list2Str(allWidgets, &quot;,&quot;));
</code></pre><p> } else {</p>
<pre><code>result.getWriter().write(&quot;ok&quot;);
</code></pre><p> }<br>}</p>
<p>/*</p>
</li>
<li><p>重新加载<br>*/<br>private void reload(HttpServletRequest req) {<br> // 移除酷屏HTML组件JSON缓存<br> CWHtmlContentMgr.getInstance().clear();<br> // 移除酷屏HTML组件自定义分组配置缓存<br> String basePath = req.getParameter(“basepath”);<br> basePath = StrFunc.ensureNotEndWith(basePath, “/“);<br> if (!StrFunc.isNull(basePath)) {</p>
<pre><code>CWidgetHtmlConfCache widgetConfCache = CWidgetUtil
        .getWidgetConfCache(basePath);
if (widgetConfCache != null) {
    widgetConfCache.reload();
}
</code></pre><p> }<br> this.doCluster_sync_reload(basePath);<br>}</p>
<p>/*</p>
</li>
<li><p>集群下发送清除全部HTML组件缓存-重新加载（刷新）消息<br>*/<br>private void doCluster_sync_reload(String basePath) {<br> if (!EsenServer.isCluster()) {</p>
<pre><code>return;
</code></pre><p> }<br> String vfsFilePath = basePath;<br> String resourceId = ResourceId4BI.BI_MODULEID</p>
<pre><code>+ ResourceId4BI.DEFAULT_DELIMETER
+ ResourceIdTypes.RES_VFS_FILE
+ ResourceId4BI.DEFAULT_DELIMETER + vfsFilePath;
</code></pre><p> ClusterMessageFactory clusterMessageFactory = ClusterMgrBI</p>
<pre><code>.getBiMessageFactory();
</code></pre><p> ClusterMessage csMsg = clusterMessageFactory.createClusterSyncMessage(</p>
<pre><code>ReleasableObj.RES_OPER_EDIT, resourceId, vfsFilePath,
&quot;COOLWIDGETHTML_CACHE_RELOAD&quot;, basePath);
</code></pre><p> ClusterMgrBI.getBiMessageSender().sendMessage(csMsg);<br>}</p>
<p>private String showPreviewPageForSave(HttpServletRequest req,</p>
<pre><code>HttpServletResponse res) throws UnsupportedEncodingException {
</code></pre><p> String path = req.getParameter(“path”);<br> /*</p>
<ul>
<li>String content = null; VfsFile2 file = EsenServer.getVfsFile(path);</li>
<li>if (file.exists()) { content = file.getAsString().trim(); }<br>*/<br>Object obj = HttpDownloadCacher.getInstance().getObj(path);<br>HttpDownloadCacher.getInstance().removeCacheObj(path);<br>req.setAttribute(“json”, obj.toString());<br>req.setCharacterEncoding(“utf-8”);<br>return HTMLSHOWFORSAVE;<br>}</li>
</ul>
<p>/**</p>
</li>
<li>获取conf.xml文件的内容返回给前台<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li><p>@throws Exception<br>*/<br>private void doList(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> String path = req.getParameter(“path”);<br> if (StrFunc.isNull(path)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackpath&quot;,
        &quot;参数path没有指定.&quot;);
</code></pre><p> }<br> Document doc = null;<br> if (path.endsWith(USERWIDGETDIR)) {</p>
<pre><code>CWidgetHtmlConfCache cache = CWidgetUtil.getWidgetConfCache(path
        .substring(0, path.lastIndexOf(&quot;/&quot;)));
doc = cache.getConfDocument();
</code></pre><p> } else {</p>
<pre><code>VfsFile2 vfs = EsenServer.getVfsFile(path + &quot;/conf.xml&quot;);
if (vfs.exists()) {
    doc = vfs.getAsXml();
}
</code></pre><p> }<br> if (doc == null) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.bi.jsp.action.user.rptcooldsn.ActionEditHtmlWidget.java.lackdoc&quot;,
        &quot;配置文件被删除！&quot;);
</code></pre><p> }<br> result.setContentType(“text/xml; charset=UTF-8”);<br> XmlFunc.saveDocument(doc, result.getOutputStream(), StrFunc.UTF8);<br>}</p>
<p>/**</p>
</li>
<li>新建分组<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li><p>@throws Exception<br>*/<br>private void newFolder(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> String folderPath = req.getParameter(“path”);<br> String name = req.getParameter(“name”);<br> if (!CWidgetUtil.getWidgetConfCache(</p>
<pre><code>    folderPath.substring(0,
            folderPath.lastIndexOf(USERWIDGETDIR) - 1)).checkName(
    folderPath, name)) {
throw new Exception4I18N(
        &quot;com.esen.bi.jsp.action.user.rptcooldsn.ActionEditHtmlWidget.java.exists&quot;,
        &quot;分组已经存在！&quot;);
</code></pre><p> }<br> CWidgetUtil.getWidgetConfCache(</p>
<pre><code>folderPath.substring(0,
        folderPath.lastIndexOf(USERWIDGETDIR) - 1)).newFolder(
folderPath, name);
</code></pre><p> result.getWriter().write(“ok”);<br>}</p>
<p>/**</p>
</li>
<li>删除分组<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li><p>@throws Exception<br>*/<br>private void deleteFolder(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> // 用户自定义分组，删除自己和下面所有的分组和文件<br> String path = req.getParameter(“path”);<br> String basepath = req.getParameter(“basepath”);<br> if (StrFunc.isNull(path)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackpath&quot;,
        &quot;参数path没有指定.&quot;);
</code></pre><p> }<br> String name = path.substring(path.lastIndexOf(“/“) + 1, path.length());<br> String parentPath = path.substring(0, path.lastIndexOf(“/“));<br> List<string> widgets = CWidgetUtil.getWidgetConfCache(</string></p>
<pre><code>basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;))).deleteFolder(
name, parentPath);
</code></pre><p> if (widgets != null &amp;&amp; widgets.size() != 0) {</p>
<pre><code>for (int i = 0; i &lt; widgets.size(); i++) {
    String widget = basepath + &quot;/&quot; + widgets.get(i) + &quot;.json&quot;;
    VfsFile2 file = EsenServer.getVfsFile(widget);
    file.remove();
}
// 如果该分组下有组件，就删除组件的预览图
if (!widgets.isEmpty()) {
    deletePreviewImg(basepath, widgets.toArray(new String[0]));
}
// 把删除的组件id串传给前台
result.getWriter().write(ArrayFunc.list2Str(widgets, &quot;,&quot;));
</code></pre><p> } else {</p>
<pre><code>result.getWriter().write(&quot;ok&quot;);
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>重命名分组<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li><p>@throws Exception<br>*/<br>private void renameFolder(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> // 用户自定义分组，重命名分组需要vfs修改文件名字<br> String path = req.getParameter(“path”);<br> String srcName = path.substring(path.lastIndexOf(“/“) + 1);<br> String parPath = path.substring(0, path.lastIndexOf(“/“));<br> String newname = req.getParameter(“name”);<br> if (StrFunc.isNull(path)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackpath&quot;,
        &quot;参数path没有指定.&quot;);
</code></pre><p> }</p>
<p> if (!CWidgetUtil.getWidgetConfCache(</p>
<pre><code>    path.substring(0, path.lastIndexOf(USERWIDGETDIR) - 1))
    .checkName(parPath, newname)) {
throw new Exception4I18N(
        &quot;com.esen.bi.jsp.action.user.rptcooldsn.ActionEditHtmlWidget.java.exists&quot;,
        &quot;分组已经存在！&quot;);
</code></pre><p> }<br> CWidgetUtil.getWidgetConfCache(</p>
<pre><code>path.substring(0, path.lastIndexOf(USERWIDGETDIR) - 1))
.renameFolder(srcName, newname, parPath);
</code></pre><p> result.getWriter().write(“ok”);<br>}</p>
<p>/**</p>
</li>
<li>重命名组件 name=新的名字</li>
<li>path=/root/products/ebi/sys/coolrpt/cooluserwidget/其他组件123</li>
<li>/CHtmlWidgetSLZJBT.json<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li><p>@throws Exception<br>*/<br>private void renameWidget(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> // 自定义组件重命名<br> String path = req.getParameter(“path”);<br> String newname = req.getParameter(“name”);<br> if (StrFunc.isNull(path)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackpath&quot;,
        &quot;参数path没有指定.&quot;);
</code></pre><p> }<br> String basepath = path.substring(0, path.lastIndexOf(USERWIDGETDIR))</p>
<pre><code>+ USERWIDGETDIR;
</code></pre><p> // 组件cap判断<br> if (CWidgetUtil.getWidgetConfCache(</p>
<pre><code>    basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;)))
    .checkWidgetByCap(newname, null)) {
throw new Exception4I18N(
        &quot;com.esen.bi.jsp.action.user.rptcooldsn.ActionEditHtmlWidget.java.widgetexists&quot;,
        &quot;组件名已经存在，请重新命名！&quot;);
</code></pre><p> }</p>
<p> VfsFile2 file = EsenServer.getVfsFile(basepath</p>
<pre><code>+ path.substring(path.lastIndexOf(&quot;/&quot;)));
</code></pre><p> if (!file.exists()) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.bi.jsp.action.user.rptcooldsn.ActionEditHtmlWidget.java.noexists&quot;,
        &quot;选中的组件已经被删除！&quot;);
</code></pre><p> }<br> JSONObject obj = new JSONObject(file.getAsString().trim());<br> alterOnCaptionChange(obj, newname);<br> file.saveAsString(obj.toString(4), StrFunc.UTF8);<br> CWidgetUtil.getWidgetConfCache(</p>
<pre><code>basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;)))
.renameWidget(
        path,
        newname,
        path.substring(path.lastIndexOf(&quot;/&quot;) + 1,
                path.lastIndexOf(&quot;.&quot;)));
</code></pre><p> result.getWriter().write(“ok”);<br>}</p>
<p>/**</p>
</li>
<li>当组件重命名或克隆后，需要更新json文件中的caption属性，和标题属性的默认值<br>*</li>
<li>@param fileobj</li>
<li>@param newCaptoin</li>
<li><p>@throws JSONException<br>*/<br>private void alterOnCaptionChange(JSONObject fileobj, String newCaptoin)</p>
<pre><code>throws JSONException {
</code></pre><p> fileobj.put(CONF_PROP_CAP, newCaptoin);<br> // 当更新了组件的标题时，<br> JSONArray attrs = fileobj.optJSONArray(CONF_PROP_COMMATTR);<br> // 组件的第2个属性是标题属性<br> JSONObject capCfg = attrs.getJSONObject(1);<br> if (CONF_PROP_CAP.equalsIgnoreCase(capCfg.optString(CONF_PROP_NAME))) {</p>
<pre><code>capCfg.put(CONF_PROP_DEFATTR, newCaptoin);
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>导入zip文件 zip文件中可能存在多个html组件<br>*</li>
<li>@param hsr</li>
<li>@param result</li>
<li>@param req</li>
<li>@param res</li>
<li><p>@throws Exception<br><em>
</em>/<br>private void importZip(HttpServletResponse res, HttpServletRequest req,</p>
<pre><code>ClientResult result, HttpServletRequestEx hsr) throws Exception {
</code></pre><p> String path = req.getParameter(“path”);<br> if (StrFunc.isNull(path)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackbasepath&quot;,
        &quot;参数basepath没有指定&quot;);
</code></pre><p> }<br> path = StrFunc.decoding2UTF8(path);<br> FileItem item = hsr.getFiles()[0];<br> String tempfile = null;<br> InputStream in = item.getInputStream();<br> try {</p>
<pre><code>tempfile = FileFunc.stm2Tempfile(in, null);
</code></pre><p> } finally {</p>
<pre><code>in.close();
// 导入后删除
item.delete();
</code></pre><p> }<br> Map&lt;String, String&gt; map = getWidgetOrFloder(req, tempfile, path);<br> if (map.size() != 0) {</p>
<pre><code>JSONObject obj = new JSONObject(map);
res.getWriter().print(obj);
</code></pre><p> } else {</p>
<pre><code>result.getWriter().write(&quot;ok&quot;);
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>导入html组件<br>*</li>
<li>@param req</li>
<li>@param files</li>
<li>@param path</li>
<li>@param map</li>
<li>@param previewMap</li>
<li>@param importMap</li>
<li><p>@throws Exception<br>*/<br>private void importWidget(HttpServletRequest req, File file, String path,</p>
<pre><code>Map&lt;String, String&gt; map, Map&lt;String, File&gt; previewMap,
Map&lt;String, JSONObject&gt; importMap) throws Exception {
</code></pre><p> String filePath = file.getAbsolutePath();<br> String fileName = filePath.substring(filePath</p>
<pre><code>.lastIndexOf(File.separator) + 1);
</code></pre><p> String widgetId = FileFunc.excludeFileExt(fileName);<br> String basePath = path.substring(0, path.lastIndexOf(USERWIDGETDIR))</p>
<pre><code>+ USERWIDGETDIR;
</code></pre><p> VfsFile2 vfsfile = EsenServer.getVfsFile(basePath);<br> JSONObject jsonfile;<br> InputStream in = new FileInputStream(file);</p>
<p> // 获取路径中的有效路径<br> String effectivePath = getWidgetDir(filePath);<br> // 记录json内容<br> String content;<br> try {</p>
<pre><code>// 如果存在且覆盖，那么直接覆盖文件即可
boolean isCover = checkName(req, fileName);
if (isCover) {
    vfsfile.importStm(in, fileName);
    content = EsenServer.getVfsFile(basePath + &quot;/&quot; + fileName)
            .getAsString().trim();
    jsonfile = new JSONObject(content);
    importPreview(widgetId, null, previewMap, basePath);
} else {
    // id不唯一时，证明对应的.json文件已经存在
    String oldId = widgetId;
    if (!isUniqueId(basePath, widgetId)) {
        widgetId = getNewHtmlId(basePath);
        fileName = widgetId + &quot;.json&quot;;
    }
    vfsfile.importStm(in, fileName);
    // 获取该html组件的caption
    content = EsenServer.getVfsFile(basePath + &quot;/&quot; + fileName)
            .getAsString().trim();
    jsonfile = new JSONObject(content);
    jsonfile.put(CONF_PROP_ID, widgetId);
    importPreview(oldId, widgetId, previewMap, basePath);
}
path = path + &quot;/&quot; + effectivePath;
String caption = jsonfile.getString(&quot;caption&quot;);

// 判断是否存在同分组重名组件，存在就重命名改组件
if (!isCover) {
    CWidgetHtmlConfCache confCache = CWidgetUtil
            .getWidgetConfCache(basePath.substring(0,
                    basePath.lastIndexOf(&quot;/&quot;)));
    while (confCache.checkWidgetByCap(caption, null)) {
        caption = caption + (int) (Math.random() * 1000);
    }
    jsonfile.put(CONF_PROP_CAP, caption);
    content = jsonfile.toString();
}
map.put(widgetId, content);

importMap.put(path, jsonfile);
// 更新组件缓存
CWHtmlContentMgr.getInstance().put(basePath, widgetId, jsonfile);
</code></pre><p> } finally {</p>
<pre><code>in.close();
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>导出预览图<br>*</li>
<li>@param basePath</li>
<li>@param list</li>
<li>@param zipout</li>
<li>@throws IOException</li>
<li><p>@throws VfsException<br>*/<br>private void exportPreview(ZipOutputStream zipout, List<string> list,</string></p>
<pre><code>String basePath) throws VfsException, IOException {
</code></pre><p> if (list.size() == 0)</p>
<pre><code>return;
</code></pre><p> String widgetName; // 组件id<br> String imgPath; // 预览图在vfs中的路径<br> VfsFile2 imgFile; // 预览图的vfs文件<br> String fileName; // 导出的文件名</p>
<p> for (int i = 0; i &lt; list.size(); i++) {</p>
<pre><code>widgetName = FileFunc.excludeFileExt(list.get(i));
if (widgetName.contains(&quot;/&quot;)) {
    widgetName = FileFunc.extractFileName(widgetName);
}
imgPath = basePath.substring(0, basePath.lastIndexOf(&quot;/&quot;) + 1)
        + PREVIEWPAGE + &quot;/&quot; + widgetName + &quot;.png&quot;;
imgFile = EsenServer.getVfsFile(imgPath);
fileName = PREVIEWPAGE + &quot;/&quot; + widgetName + &quot;.png&quot;;
if (imgFile.exists()) {
    zipout.putNextEntry(new ZipEntry(fileName));
    zipout.write(imgFile.getAsBytes());
}
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>导入预览图<br>*</li>
<li>@param previewMap</li>
<li>@param newId</li>
<li>@param oldId</li>
<li>@param basePath</li>
<li><p>@throws IOException<br>*/<br>private void importPreview(String oldId, String newId,</p>
<pre><code>Map&lt;String, File&gt; previewMap, String basePath) throws IOException {
</code></pre><p> if (previewMap.size() == 0)</p>
<pre><code>return;
</code></pre><p> String id = oldId;<br> if (!StrFunc.isNull(newId)) {</p>
<pre><code>id = newId;
</code></pre><p> }<br> File file = previewMap.get(oldId);<br> if (file == null)</p>
<pre><code>return;
</code></pre><p> InputStream in = new FileInputStream(file);<br> String path = basePath.substring(0, basePath.lastIndexOf(“/“) + 1)</p>
<pre><code>+ PREVIEWPAGE;
</code></pre><p> VfsFile2 vfsfile = EsenServer.getVfsFile(path);<br> String name = id + “.png”;<br> try {</p>
<pre><code>vfsfile.importStm(in, name);
</code></pre><p> } finally {</p>
<pre><code>in.close();
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>跟临时文件路径获取有效路径<br>*</li>
<li>@param filePath</li>
<li><p>@return<br>*/<br>private String getWidgetDir(String filePath) {<br> String pathArray[] = filePath.split(“importHtmlWidget_”);<br> String dirPath = pathArray[1].substring(pathArray[1]</p>
<pre><code>.indexOf(File.separator) + 1);
</code></pre><p> dirPath = dirPath.replaceAll(“\\“, “/“);<br> return dirPath;<br>}</p>
<p>/**</p>
</li>
<li>获取解压后的分组和组件,并导入文件<br>*</li>
<li>@param req</li>
<li>@param tempfile</li>
<li>@param path</li>
<li>@return</li>
<li><p>@throws Exception<br>*/<br>private Map&lt;String, String&gt; getWidgetOrFloder(HttpServletRequest req,</p>
<pre><code>String tempfile, String path) throws Exception {
</code></pre><p> // 解压文件<br> File file = new File(tempfile);<br> String absolutePath = file.getAbsolutePath();<br> FileInputStream in = new FileInputStream(absolutePath);<br> try {</p>
<pre><code>String tempDir = DefaultTempFileFactory.getInstance()
        .createTempDir(&quot;importHtmlWidget&quot;).getAbsolutePath();
try {
    FileFunc.unzip(in, tempDir);
    // 用来存放组件的集合
    List&lt;File&gt; widgetFiles = new ArrayList&lt;File&gt;();
    // 用来存放预览图文件的map集合
    Map&lt;String, File&gt; previewMap = new HashMap&lt;String, File&gt;();
    getHtmlList(widgetFiles, previewMap, new File(tempDir));
    // 用来存放组件id和组件内容的map集合
    Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;();
    // 用来存放所有path和json的map
    Map&lt;String, JSONObject&gt; importMap = new HashMap&lt;String, JSONObject&gt;();
    for (int i = 0; i &lt; widgetFiles.size(); i++) {
        importWidget(req, widgetFiles.get(i), path, map,
                previewMap, importMap);
    }
    String basePath = path.substring(0,
            path.lastIndexOf(USERWIDGETDIR))
            + USERWIDGETDIR;
    // 写目录结构和组件到xml.conf文件
    CWidgetUtil.getWidgetConfCache(
            basePath.substring(0, basePath.lastIndexOf(&quot;/&quot;)))
            .importAllWidget(importMap);
    return map;
} finally {
    FileFunc.remove(tempDir);
}
</code></pre><p> } finally {</p>
<pre><code>in.close();
FileFunc.remove(file);
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>遍历临时目录，获取导入的分组和组件<br>*</li>
<li>@param previewMap</li>
<li>@param list</li>
<li><p>@param tempDir<br>*/<br>private void getHtmlList(List<file> widgets, Map&lt;String, File&gt; previewMap,</file></p>
<pre><code>File file) {
</code></pre><p> if (file.isDirectory()) {</p>
<pre><code>File[] files = file.listFiles();
for (int i = 0; i &lt; files.length; i++) {
    getHtmlList(widgets, previewMap, files[i]);
}
</code></pre><p> } else if (file.getName().endsWith(“.json”)) {</p>
<pre><code>widgets.add(file);
</code></pre><p> } else if (file.getName().endsWith(“.png”)) {</p>
<pre><code>String id = FileFunc.excludeFileExt(file.getName());
previewMap.put(id, file);
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>检查文件名字是否存在于自定义组件中，判断是否为存在且直接覆盖<br>*</li>
<li>@param req</li>
<li>@param widgetId</li>
<li><p>@return<br>*/<br>private boolean checkName(HttpServletRequest req, String name) {<br> String path = req.getParameter(“path”);<br> String isCover = req.getParameter(“isCover”);<br> VfsFile2 vfsfile = EsenServer.getVfsFile(path.substring(0,</p>
<pre><code>path.lastIndexOf(USERWIDGETDIR) - 1)
+ &quot;/&quot; + USERWIDGETDIR + &quot;/&quot; + name);
</code></pre><p> if (vfsfile.exists() &amp;&amp; “true”.equalsIgnoreCase(isCover)) {</p>
<pre><code>return true;
</code></pre><p> }<br> return false;<br>}</p>
<p>/**</p>
</li>
<li>导出html组件的json<br>*</li>
<li>@param req</li>
<li>@param res</li>
<li>@param result</li>
<li>@throws Exception4I18N</li>
<li><p>@throws IOException<br>*/<br>private void export(HttpServletRequest req, HttpServletResponse res,</p>
<pre><code>ClientResult result) throws Exception4I18N, IOException {
</code></pre><p> String basepath = req.getParameter(“basepath”);<br> String items = req.getParameter(“items”);<br> String isMutliSelets = req.getParameter(“ismutliselets”);<br> String filename;<br> if (StrFunc.compareStrIgnoreCase(isMutliSelets, “true”) || isDir(items)) {</p>
<pre><code>filename = I18N
        .getString(
                &quot;com.esen.platform.action.portal.actionportalmgr.htmlwidget&quot;,
                &quot;HTML组件&quot;)
        + &quot;(&quot; + StrFunc.formatDate(&quot;yyyyMMdd_HHmmss&quot;) + &quot;).zip&quot;;
</code></pre><p> } else {</p>
<pre><code>filename = FileFunc.excludeFileExt(items) + &quot;.zip&quot;;
</code></pre><p> }<br> List<string> ids = getExportWidget(items, basepath, isMutliSelets);<br> if (ids.isEmpty()) {</string></p>
<pre><code>result.getWriter()
        .write(I18N
                .getString(
                        &quot;com.esen.bi.jsp.action.user.rptcooldsn.ActionEditHtmlWidget.java.noexists&quot;,
                        &quot;选中的组件已经被删除！&quot;));
</code></pre><p> } else {</p>
<pre><code>ServletFunc.setDownloadHeader(result.getHttpServletResponse(),
        null, StrFunc.UTF8, null, filename);
OutputStream osm = res.getOutputStream();
ZipOutputStream zipout = new ZipOutputStream(osm);
zipout.setEncoding(StrFunc.GBK);
try {
    addToStream(zipout, ids, basepath, isMutliSelets);
    zipout.finish();
} finally {
    zipout.close();
}
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>将选中的组件和分组遍历出来，依次写入到压缩流中<br>*</li>
<li>@param zipout</li>
<li>@param ids</li>
<li>@param basePath</li>
<li>@param isMutliSelets2</li>
<li>@throws IOException</li>
<li><p>@throws Exception4I18N<br>*/<br>private void addToStream(ZipOutputStream zipout, List<string> ids,</string></p>
<pre><code>String basePath, String isMutliSelets) throws IOException,
Exception4I18N {
</code></pre><p> for (int i = 0, len = ids.size(); i &lt; len; i++) {</p>
<pre><code>String id = ids.get(i);
zipout.putNextEntry(new ZipEntry(id));
if (id.contains(&quot;/&quot;)) {
    zipout.write(EsenServer.getVfsFile(
            basePath + id.substring(id.lastIndexOf(&quot;/&quot;)))
            .getAsBytes());
} else {
    zipout.write(EsenServer.getVfsFile(basePath + &quot;/&quot; + id)
            .getAsBytes());
}
</code></pre><p> }<br> exportPreview(zipout, ids, basePath);<br>}</p>
<p>/**</p>
</li>
<li>过滤掉重复的内容和单容器等不需要导出的容器<br>*</li>
<li>@param items</li>
<li>@param needExtractFileName</li>
<li><p>@return<br>*/<br>private List<string> filterRepetition(String[] items,</string></p>
<pre><code>boolean needExtractFileName) {
</code></pre><p> // 排序，将分组放到组件的前面<br> Comparator comparator = new Comparator<string>() {</string></p>
<pre><code>public int compare(String o1, String o2) {
    if (isDir(o1) &amp;&amp; !isDir(o2)) {
        return -1;
    } else if (!isDir(o1) &amp;&amp; isDir(o2)) {
        return 1;
    } else {
        return 0;
    }
}
</code></pre><p> };<br> Arrays.sort(items, comparator);<br> // 遍历是否存在包含关系的组件或分组<br> List<string> list = Arrays.asList(items);<br> List<string> itemsList = new ArrayList<string>(list);<br> for (int i = 0, len = items.length; i &lt; len; i++) {</string></string></string></p>
<pre><code>for (int j = 0, length = items.length; j &lt; length; j++) {
    if (items[i].contains(items[j])
            &amp;&amp; !StrFunc.compareStrIgnoreCase(items[i], items[j])) {
        itemsList.remove(items[i]);
        break;
    }
}
</code></pre><p> }</p>
<p> if (needExtractFileName) {</p>
<pre><code>// 去掉组件前面的路径，方便与目录中的组件进行比较
for (int i = 0, len = itemsList.size(); i &lt; len; i++) {
    String item = itemsList.get(i);
    if (item.endsWith(&quot;.json&quot;)
            &amp;&amp; (FileFunc.excludeFileExt(item).length() == 32 || item
                    .startsWith(&quot;CHtmlWidget&quot;))) {
        itemsList.set(i, item.substring(item.lastIndexOf(&quot;/&quot;) + 1));
    }
    ;
}
</code></pre><p> }<br> return itemsList;<br>}</p>
<p>/**</p>
</li>
<li>获取导出的所有存在的组件的id<br>*</li>
<li>@param isMutliSelets</li>
<li>@param items</li>
<li><p>@throws Exception4I18N<br>*/<br>private List<string> getExportWidget(String widgets, String basePath,</string></p>
<pre><code>String isMutliSelets) throws Exception4I18N {
</code></pre><p> // 用来存放存在的组件的id<br> List<string> ids = new ArrayList<string>();<br> // 判断是否是多选<br> if (isMutliSelets.equalsIgnoreCase(“true”)) {</string></string></p>
<pre><code>String items[] = widgets.split(&quot;,&quot;);
// 用来存放过滤后的path
List&lt;String&gt; widgetList = filterRepetition(items, true);
String path;
String fileName;
for (int i = 0; i &lt; widgetList.size(); i++) {
    path = widgetList.get(i);
    if (isDir(path)
            &amp;&amp; !FileFunc.extractFileName(path).startsWith(&quot;elem_&quot;)) {
        ids.addAll(getExistWigByGroup(basePath, path));
    } else {
        fileName = FileFunc.extractFileName(path);
        if (EsenServer.getVfsFile(basePath + &quot;/&quot; + fileName)
                .exists()) {
            ids.add(fileName);
        }
    }
}
</code></pre><p> } else {</p>
<pre><code>if (isDir(widgets)) {
    ids.addAll(getExistWigByGroup(basePath, widgets));
} else {
    if (EsenServer.getVfsFile(basePath + &quot;/&quot; + widgets).exists()) {
        ids.add(widgets);
    }
}
</code></pre><p> }<br> return ids;<br>}</p>
<p>/**</p>
</li>
<li>根据分组路径获取旗下存在的组件的文件名<br>*</li>
<li>@param basePath</li>
<li>@param id</li>
<li>@return</li>
<li><p>@throws Exception4I18N<br>*/<br>private List<string> getExistWigByGroup(String basePath, String id)</string></p>
<pre><code>throws Exception4I18N {
</code></pre><p> List<string> list = new ArrayList<string>();<br> List<string> ids = new ArrayList<string>();<br> if (basePath.contains(“cooluserwidget”)) {</string></string></string></string></p>
<pre><code>list = CWidgetUtil.getWidgetConfCache(
        basePath.substring(0, basePath.lastIndexOf(&quot;/&quot;)))
        .listChildren(id);
</code></pre><p> } else {</p>
<pre><code>list = listWidgetsBySysGroup(id, basePath);
</code></pre><p> }<br> String fileName;<br> for (int j = 0; j &lt; list.size(); j++) {</p>
<pre><code>String widget = list.get(j);
fileName = FileFunc.extractFileName(widget);
if (EsenServer.getVfsFile(basePath + &quot;/&quot; + fileName).exists()) {
    ids.add(widget);
}
</code></pre><p> }<br> return ids;<br>}</p>
<p>/**</p>
</li>
<li>根据系统内置组件分组列出所有字节点<br>*</li>
<li>@param path</li>
<li>@param basePath</li>
<li><p>@return<br>*/<br>private List<string> listWidgetsBySysGroup(String path, String basePath) {<br> VfsFile2 vfs = EsenServer.getVfsFile(basePath + “/conf.xml”);<br> if (vfs.exists()) {</string></p>
<pre><code>Document doc = vfs.getAsXml();
Element parentEle = getParentEle(path, doc);
List&lt;String&gt; list = new ArrayList&lt;String&gt;();
return listChildren(parentEle, parentEle.getAttribute(&quot;caption&quot;),
        list);
</code></pre><p> }<br> return null;<br>}</p>
<p>/**</p>
</li>
<li>列出给定路径的系统内置组件的文件和分组列表<br>*</li>
<li>@param parentEle</li>
<li>@param caption</li>
<li><p>@param list<br>*/<br>private List<string> listChildren(Element parentEle, String caption,</string></p>
<pre><code>List&lt;String&gt; list) {
</code></pre><p> NodeList allChild = parentEle.getChildNodes();<br> for (int i = 0, len = allChild.getLength(); i &lt; len; i++) {</p>
<pre><code>Node node = allChild.item(i);
if (node.getNodeName().equalsIgnoreCase(&quot;group&quot;)) {
    Element ele = (Element) node;
    listChildren(ele, caption + &quot;/&quot; + ele.getAttribute(&quot;caption&quot;),
            list);
} else if (node.getNodeName().equalsIgnoreCase(&quot;widget&quot;)) {
    Element ele = (Element) node;
    list.add(caption + &quot;/&quot; + ele.getAttribute(&quot;id&quot;) + &quot;.json&quot;);
}
</code></pre><p> }<br> return list;</p>
<p>}</p>
<p>/**</p>
</li>
<li>根据路径，获得父节点<br>*</li>
<li>@param path</li>
<li>路径,用于获取组件的父节点</li>
<li>@param doc</li>
<li><p>@return<br>*/<br>public Element getParentEle(String path, Document doc) {<br> path = path.substring(path.indexOf(“coolsyswidget”));<br> if (path.endsWith(“.json”)) {</p>
<pre><code>path = path.substring(0, path.lastIndexOf(&quot;/&quot;));
</code></pre><p> }<br> Element parentele = (Element) doc.getElementsByTagName(“coolsyswidget”)</p>
<pre><code>.item(0);
</code></pre><p> String[] groups = path.split(“/“);</p>
<p> for (int i = 0, len = groups.length - 1; i &lt; len; i++) {</p>
<pre><code>parentele = getGroupNodeByCaption(parentele, groups[i + 1]);
if (parentele == null)
    return null;
</code></pre><p> }<br> return parentele;</p>
<p>}</p>
<p>/**</p>
</li>
<li>得到指定子节点<br>*</li>
<li>@param parentEle</li>
<li>父节点</li>
<li>@param caption</li>
<li>目标节点的caption属性值</li>
<li><p>@return<br>*/<br>private Element getGroupNodeByCaption(Element parentEle, String caption) {<br> List<element> list = XmlFunc.getChildElements(parentEle);<br> for (int i = 0, len = list.size(); i &lt; len; i++) {</element></p>
<pre><code>Element ele = list.get(i);
if (ele.getNodeName().equalsIgnoreCase(&quot;group&quot;)
        &amp;&amp; ele.getAttribute(&quot;caption&quot;).equalsIgnoreCase(caption)) {
    return ele;
}
</code></pre><p> }<br> return null;<br>}</p>
<p>/**</p>
</li>
<li>判断是否是目录<br>*</li>
<li>@param widgetId</li>
<li><p>@return<br>*/<br>private boolean isDir(String widgetId) {<br> if (!widgetId.endsWith(“.json”)) {</p>
<pre><code>return true;
</code></pre><p> }<br> return false;<br>}</p>
<p>/**</p>
</li>
<li>重置内置html组件<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li><p>@throws Exception<br>*/<br>private void refreshSysHtml(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> String basepath = req.getParameter(“basepath”);<br> if (StrFunc.isNull(basepath)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackpath&quot;,
        &quot;参数path没有指定.&quot;);
</code></pre><p> }<br> // 移除酷屏HTML组件JSON缓存<br> CWHtmlContentMgr.getInstance().clear();<br> this.doCluster_sync_reload(basepath.substring(0,</p>
<pre><code>basepath.lastIndexOf(&quot;/&quot;)));
</code></pre><p> CoolSysWidgetMgr mgr = new CoolSysWidgetMgr();<br> Document content = null;<br> if (basepath.startsWith(mgr.VFS_COOL_PATH)) {</p>
<pre><code>// 酷屏
content = mgr.initSysHtmlForRpt(true);
</code></pre><p> } else {</p>
<pre><code>// 酷屏门户
content = mgr.initSysHtmlForPortal(true);
</code></pre><p> }</p>
<p> result.setContentType(“text/xml; charset=UTF-8”);<br> XmlFunc.saveDocument(content, result.getOutputStream(), StrFunc.UTF8);<br> CWidgetUtil.getWidgetConfCache(</p>
<pre><code>basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;))).reload();
</code></pre><p>}</p>
<p>/**</p>
</li>
<li>编辑界面<br>*</li>
<li>@param req</li>
<li>@param res</li>
<li><p>@return<br>*/<br>private String showEditPage(HttpServletRequest req, HttpServletResponse res) {</p>
<p> // 工具栏的xml配置的路径<br> req.setAttribute(</p>
<pre><code>&quot;uiconfig&quot;,
UICONFIG_PATH_PRE
        + I18N.getString(&quot;chtmleditor.xml&quot;,
                &quot;chtmleditor_zh_CN.xml&quot;));
</code></pre><p> // 编辑的组件的路径，新建的为空<br> String basepath = req.getParameter(“basepath”);<br> req.setAttribute(“basepath”, basepath);<br> // 新建的需要分组名,编辑为空<br> String widgetId = req.getParameter(“widgetId”);<br> req.setAttribute(“widgetId”, widgetId);<br> // if(path != null){<br> // VfsFile2 file = EsenServer.getVfsFile(path);<br> // if (file.exists()) {<br> // String content = file.getAsString().trim();<br> // req.setAttribute(“widgetjson”, content);<br> // }<br> // }<br> try {</p>
<pre><code>String path = basepath + &quot;/&quot; + widgetId + &quot;.json&quot;;
String content = null;
VfsFile2 file = EsenServer.getVfsFile(path);
if (file.exists()) {
    content = file.getAsString().trim();
}
req.setAttribute(&quot;widgetjson&quot;, content);
</code></pre><p> } catch (Exception e) {</p>
<pre><code>ExceptionHandler
        .rethrowRuntimeException(
                e,
                &quot;com.esen.bi.jsp.action.user.rptcooldsn.actionedithtmlwidget.getresultjson&quot;,
                &quot;获取结果表HTML组件{0}的JSON时出现异常：{1}。&quot;, new String[] {
                        widgetId, e.getMessage() });
</code></pre><p> }</p>
<p> // 是否是查看，true-查看（内置的组件）；false-编辑（自定义的组件）<br> req.setAttribute(“isshow”, req.getParameter(“isshow”));</p>
<p> return HTMLEDITOR;<br>}</p>
<p>/**</p>
</li>
<li>预览界面<br>*</li>
<li>@param req</li>
<li>@param res</li>
<li><p>@return<br>*/<br>private String showPreviewPage(HttpServletRequest req,</p>
<pre><code>HttpServletResponse res) {
</code></pre><p> return HTMLSHOW;<br>}</p>
<p>/**</p>
</li>
<li>获得组件json格式<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li><p>@throws JSONException<br>*/<br>private void getWidgetJson(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws JSONException {
</code></pre><p> String basepath = req.getParameter(“basepath”);<br> String widgetId = req.getParameter(“widgetId”);<br> String path = CWidgetUtil.findWidgetPathById(basepath, widgetId);<br> try {</p>
<pre><code>JSONObject jsonContent = CWHtmlContentMgr.getInstance().get(
        basepath, widgetId);
if (jsonContent != null) {
    String content = jsonContent.toString(4);
    if (!StrFunc.isNull(content)) {
        result.getWriter().write(content);
    }
}
</code></pre><p> } catch (Exception e) {</p>
<pre><code>ExceptionHandler
        .rethrowRuntimeException(
                e,
                &quot;com.esen.bi.jsp.action.user.rptcooldsn.actionedithtmlwidget.getresultjson&quot;,
                &quot;获取HTML组件{0}的JSON时出现异常：{1}。&quot;, new String[] { path,
                        e.getMessage() });
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>保存组件<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li><p>@throws Exception<br>*/<br>private void saveWidget(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> // 参数两种情况1：basepath与widgetId(编辑组件保存) 2.foldpath:在分组下新建或另存为<br> String widgetId = req.getParameter(“widgetId”);<br> String widgetpath = req.getParameter(“widgetpath”);<br> String basepath = req.getParameter(“basepath”);<br> String foldpath = req.getParameter(“foldpath”);<br> String json = req.getParameter(“definejson”);<br> if (StrFunc.isNull(basepath) &amp;&amp; StrFunc.isNull(foldpath)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackpath&quot;,
        &quot;参数path没有指定.&quot;);
</code></pre><p> }</p>
<p> JSONObject defineJson = new JSONObject(json);</p>
<p> if (!StrFunc.isNull(foldpath)) {</p>
<pre><code>// 组件cap判断
if (CWidgetUtil
        .getWidgetConfCache(
                basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;)))
        .checkWidgetByCap(defineJson.getString(CONF_PROP_CAP), null)) {
    throw new Exception4I18N(
            &quot;com.esen.bi.jsp.action.user.rptcooldsn.ActionEditHtmlWidget.java.widgetexists&quot;,
            &quot;组件名已经存在，请重新命名！&quot;);
}
// 是新建或另存为的组件，后台生成维一组件id
// widgetId = getNewHtmlId(basepath,
// defineJson.getString(CONF_PROP_CAP));
widgetId = getNewHtmlId(basepath);
defineJson.put(CONF_PROP_ID, widgetId);
widgetpath = foldpath + &quot;/&quot; + widgetId + &quot;.json&quot;;
</code></pre><p> }<br> // 更新缓存，并保存组件<br> CWHtmlContentMgr.getInstance().put(basepath, widgetId, defineJson);<br> if (!StrFunc.isNull(foldpath)) {</p>
<pre><code>// 处理xml文件,放在保存组件后做，以防保存时出现异常，但是xml中却生成节点
CWidgetUtil.getWidgetConfCache(
        basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;)))
        .saveWidget(widgetId, defineJson.getString(&quot;caption&quot;), &quot;&quot;,
                widgetpath);
</code></pre><p> }<br> result.getWriter().write(widgetId);<br>}</p>
<p>/**</p>
</li>
<li>组件id：CHtmlWidget+cap拼音 + 加随机数<br>*</li>
<li>@param basepath</li>
<li>: basepath即组件json的保存路径</li>
<li>@param cap</li>
<li>@return</li>
<li><p>@throws JSONException<br>*/<br>private String getNewHtmlId(String basepath) throws JSONException {<br> String id = UUID.randomUUID().toString().replace(“-“, “”);<br> while (!isUniqueId(basepath, id)) {</p>
<pre><code>id = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);
</code></pre><p> }<br> return id;<br>}</p>
<p>/**</p>
</li>
<li>判断id是否唯一<br>*</li>
<li>@param basepath</li>
<li>@param id</li>
<li>@return</li>
<li><p>@throws JSONException<br>*/<br>private boolean isUniqueId(String basepath, String id) throws JSONException {<br> boolean user = CWidgetUtil.getWidgetConfCache(</p>
<pre><code>basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;))).checkId(id);
</code></pre><p> if (!user)</p>
<pre><code>return false;
</code></pre><p> VfsFile2 vfs = EsenServer.getVfsFile(basepath.substring(0,</p>
<pre><code>basepath.lastIndexOf(&quot;/&quot;) + 1)
+ SYSWIDGETDIR + &quot;/conf.xml&quot;);
</code></pre><p> if (vfs.exists()) {</p>
<pre><code>Document doc = vfs.getAsXml();
NodeList list = doc.getElementsByTagName(&quot;widget&quot;);
for (int i = 0; i &lt; list.getLength(); i++) {
    Element ele = (Element) list.item(i);
    if (ele.getAttribute(&quot;id&quot;).equalsIgnoreCase(id)) {
        return false;
    }
}
</code></pre><p> }<br> return true;<br>}</p>
<p>/**</p>
</li>
<li>删除组件<br>*</li>
<li>@param req</li>
<li>@param result</li>
<li>@throws JSONException</li>
<li><p>@throws VfsException<br>*/<br>private void deleteWidget(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> String id = req.getParameter(“widgetId”);<br> String path = req.getParameter(“path”);<br> String basepath = req.getParameter(“basepath”);<br> if (StrFunc.isNull(path)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackpath&quot;,
        &quot;参数path没有指定.&quot;);
</code></pre><p> }<br> // 删除缓存和vfs文件<br> CWHtmlContentMgr.getInstance().delete(basepath, id);<br> CWidgetUtil.getWidgetConfCache(</p>
<pre><code>basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;))).deleteWidget(
id, path);
</code></pre><p> // 删除预览图<br> deletePreviewImg(basepath, new String[] { id });<br> result.getWriter().write(“ok”);<br>}</p>
<p>/**</p>
</li>
<li>删除组件的预览图,存在就删除<br>*</li>
<li>@param basepath</li>
<li><p>@param ids<br>*/<br>private void deletePreviewImg(String basepath, String[] ids) {<br> String imgPath;<br> VfsFile2 img;<br> for (int i = 0; i &lt; ids.length; i++) {</p>
<pre><code>imgPath = basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;) + 1)
        + PREVIEWPAGE + &quot;/&quot; + ids[i] + &quot;.png&quot;;
img = EsenServer.getVfsFile(imgPath);
if (img.exists()) {
    img.remove();
}
</code></pre><p> }<br>}</p>
<p>/**</p>
</li>
<li>克隆组件,暂时把克隆的组件放在最下边<br>*</li>
<li>@param req</li>
<li>path:被克隆组件的路径；包括分组信息的</li>
<li>basepath:被克隆组件所在的位置：eg/root/products/../cooluserwidget</li>
<li>caption:克隆组件的名称</li>
<li>@param result</li>
<li><p>@throws Exception<br>*/<br>private void cloneWidget(HttpServletRequest req, ClientResult result)</p>
<pre><code>throws Exception {
</code></pre><p> String path = req.getParameter(“path”);<br> String basepath = req.getParameter(“basepath”);<br> if (StrFunc.isNull(path)) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.platform.action.portal.actionportalmgr.lackpath&quot;,
        &quot;参数path没有指定.&quot;);
</code></pre><p> }<br> String oldId = path.substring(path.lastIndexOf(“/“) + 1,</p>
<pre><code>path.lastIndexOf(&quot;.&quot;));
</code></pre><p> // 读取被克隆组件<br> int lastSlash = path.lastIndexOf(“/“);<br> String parentPath = path.substring(0, lastSlash);<br> String name = path.substring(lastSlash + 1, path.length());<br> VfsFile2 file = EsenServer.getVfsFile(basepath + “/“ + name);<br> if (!file.exists()) {</p>
<pre><code>throw new Exception4I18N(
        &quot;com.esen.bi.jsp.action.user.rptcooldsn.ActionEditHtmlWidget.java.noexists&quot;,
        &quot;选中的组件已经被删除！&quot;);
</code></pre><p> }<br> JSONObject clonedObj = new JSONObject(file.getAsString());<br> // 生成克隆内容<br> String origcap = req.getParameter(“caption”);<br> String id = getNewHtmlId(basepath);<br> clonedObj.put(CONF_PROP_ID, id);</p>
<p> // 保存：自定义组件克隆放在统一文件夹下；内置组件克隆放在自定义组件根目录下<br> boolean isSys = basepath.endsWith(SYSWIDGETDIR);<br> if (isSys) {</p>
<pre><code>basepath = basepath.replaceFirst(SYSWIDGETDIR, USERWIDGETDIR);
parentPath = basepath;
</code></pre><p> }<br> path = basepath + “/“ + id + “.json”;<br> String cap = getCloneWidgetCaption(basepath, parentPath, origcap);<br> alterOnCaptionChange(clonedObj, cap);<br> String img = clonedObj.optString(CONF_PROP_IMG, “”);<br> // 更新缓存，并保存组件<br> CWHtmlContentMgr.getInstance().put(basepath, id, clonedObj);<br> // 修改配置<br> CWidgetUtil.getWidgetConfCache(</p>
<pre><code>basepath.substring(0, basepath.lastIndexOf(&quot;/&quot;))).saveWidget(
id, cap, img, parentPath);
</code></pre><p> // 克隆预览图,如果存在，才克隆<br> String previewImgPath = basepath.substring(0,</p>
<pre><code>basepath.lastIndexOf(&quot;/&quot;) + 1)
+ &quot;coolwidgetimg&quot;
+ &quot;/&quot;
+ oldId
+ &quot;.png&quot;;
</code></pre><p> VfsFile2 previewImg = EsenServer.getVfsFile(previewImgPath);<br> if (previewImg.exists()) {</p>
<pre><code>String dirPath = basepath.substring(0,
        basepath.lastIndexOf(&quot;/&quot;) + 1) + &quot;coolwidgetimg&quot;;
previewImg
        .copyTo(EsenServer.getVfsFile(dirPath), id + &quot;.png&quot;, true);
</code></pre><p> }</p>
<p> // 克隆组件的id和cap传回前台<br> JSONObject newInfo = new JSONObject();<br> newInfo.put(“id”, id);<br> newInfo.put(“cap”, cap);<br> result.getWriter().write(newInfo.toString());<br>}</p>
<p>/**</p>
</li>
<li>克隆时生成的名字 保证在同一个分组下不存在重名<br>*</li>
<li>@param basepath</li>
<li>@param parentPath</li>
<li>@param origcap</li>
<li>被克隆组件的名称</li>
<li>@return</li>
<li>@throws Exception4I18N<br>*/<br>private String getCloneWidgetCaption(String basepath, String parentPath,<pre><code>String origcap) throws Exception4I18N {
</code></pre> String newCap = origcap<pre><code>+ I18N.getString(
        &quot;com.esen.bi.jsp.action.user.rptcooldsn.ActionEditHtmlWidget.copy&quot;,
        &quot;_副本&quot;);
</code></pre> String resultCap = newCap;<br> int n = 0;<br> CWidgetHtmlConfCache widgetConfCache = CWidgetUtil<pre><code>.getWidgetConfCache(basepath.substring(0,
        basepath.lastIndexOf(&quot;/&quot;)));
</code></pre> // while(widgetConfCache.checkIdByGroup(resultCap, parentPath)){<br> while (widgetConfCache.checkWidgetByCap(resultCap, null)) {<pre><code>resultCap = newCap + &quot;_&quot; + n;
n++;
</code></pre> }<br> return resultCap;<br>}</li>
</ul>
</li>
</ul>
<pre><code>/**
 * 从文件读取 并转换成 主题集(及其控件)的角色  的json对象 数组
 * @param req
 * @param res
 * @param result
 * @return
 * @throws IOException
 */
public String getRoles(HttpServletRequest req,HttpServletResponse res, ClientResult result) throws IOException {
    // 1.获取存储在vfs的主题集的文件名
            // 1.1从VFS读数据文件
            Server svr = Server.getInstance();
            Vfs2 vfs = svr.getVfs();
            // 1.2获取文件InputStream对象 VfsFile2InputStream
            // 自定义组件 配置文件路径 /root/products/ebi/sys/coolrpt/colluserwidget/conf.xml
            VfsFile2 file = vfs.getVfsFile(
                    &quot;/root/products/ebi/sys/coolrpt/cooluserwidget/conf.xml&quot;,
                    ActionFunc.getLogin(req));
            InputStream in = file.getInputStream();
            // 1.3将文件解析得到有用信息并存入list数组
            // 主题集名称+控件id
            List&lt;List&gt; pmlist = ActionEditHtmlWidget.file2list(in);
            // 1.4 获得主题集名称
            List&lt;String&gt; ztjList = pmlist.get(0);
            // 主题集权限json对象(包括操作json对象)集合,根据文件名获取id 最终得到ztjLimitObjects
            // 需要根据req获取login对象
            PermissionChecker pChecker = ActionFunc4BI.getPermissionChecker(req);
            List&lt;JsonObject&gt; ztjLimitObjects = new ArrayList&lt;JsonObject&gt;();
            //2.获得前端的itemid 并查出8中权限 有哪几种
            for (String ztj : ztjList) {
                DWSubjectSet dwSubjectSet = DWMgr.getInstance()
                        .getDWSubjectSetByCaption(ztj);
                String ztj_id =&quot;EBI$7$&quot;+ dwSubjectSet.getServerId();

                //CYKR67IYIOPZK2ZYYYWM99YRL3YOFZY1
                Boolean view = pChecker.check(ztj_id, ResOper.VIEW.getOperId());
                //Boolean viewchild = pChecker.check(ztj_id, ResOper.VIEWCHILD.getOperId());
                //完全控制权限
                Boolean mana=pChecker.check(ztj_id, ResOper.MANAGE.getOperId());
                //Boolean authorize=pChecker.check(ztj_id, ResOper.AUTHORIZE.getOperId());
                //Boolean denyauthorize=pChecker.check(ztj_id, ResOper.AUTHORIZE.getOperId());
                Boolean edit = pChecker.check(dwSubjectSet, ResOper.EDIT.getOperId());
                //Boolean add = pChecker.check(ztj_id, ResOper.ADD.getOperId());
                //Boolean del = pChecker.check(ztj_id, ResOper.DELETE.getOperId());


                JsonObject zjLimit = new JsonObject();
                zjLimit.addProperty(&quot;id&quot;, ztj_id);
                zjLimit.addProperty(&quot;name&quot;, ztj);
                zjLimit.addProperty(&quot;view&quot;, view);
                //zjLimit.addProperty(&quot;viewchild&quot;, viewchild);
                zjLimit.addProperty(&quot;mana&quot;, mana);
                //zjLimit.addProperty(&quot;authorize&quot;, authorize);
                //zjLimit.addProperty(&quot;denyauthorize&quot;, denyauthorize);
                //zjLimit.addProperty(&quot;del&quot;, del);
                //zjLimit.addProperty(&quot;add&quot;, add);
                zjLimit.addProperty(&quot;edit&quot;, edit);
                    //根据zjLimit 获取权限
                JsonObject role=new JsonObject();
                //存入主题集名称(即id) 和对应角色
                //System.out.println(zjLimit.toString());
                role.addProperty(&quot;itemId&quot;, ztj);
                role.addProperty(&quot;role&quot;, getRole(zjLimit));
                ztjLimitObjects.add(role);

            }
            result.getWriter().print(ztjLimitObjects.toString());
            return null;
}


/**
 * 将文件的inputStream对象的有用信息(ztj主题集名称)存到2个list数组中 并存在一个json对象中
 *
 * @param in
 * @return
 * @throws IOException
 */
public static List&lt;List&gt; file2list(InputStream in) throws IOException {
    JsonObject data = new JsonObject();
    List&lt;String&gt; ztjlist = new ArrayList&lt;String&gt;();
    List&lt;String&gt; widgetlist = new ArrayList&lt;String&gt;();
    if (in != null) {
        try {
            BufferedReader br = new BufferedReader(new InputStreamReader(
                    in, &quot;UTF-8&quot;));
            try {
                String line = br.readLine();
                while (line != null) {
                    if (line.contains(&quot;&lt;group caption&quot;)) {
                        String[] fileds = line.split(&quot;\&quot;&quot;);
                        ztjlist.add(fileds[1]);
                    }
                    if (line.contains(&quot;widget caption&quot;)) {
                        String[] fileds = line.split(&quot;\&quot;&quot;);
                        widgetlist.add(fileds[3]);
                    }

                    line = br.readLine();
                    // System.out.println(line);
                }

            } finally {
                br.close();
            }
        } finally {
            in.close();
        }
    }
    List&lt;List&gt; ztj_widgetlist = new ArrayList&lt;List&gt;();
    ztj_widgetlist.add(ztjlist);
    ztj_widgetlist.add(widgetlist);
    return ztj_widgetlist;
}
/**
 * 传入一个list权限集合 返回四种类型的一种
 * 1.通过判断是否拥有“完全控制”权限，来判断是否是拥有者，如果不是
 * 2.通过判断是否拥有“编辑”权限，来判断是否是管理者，如果不是
 * 3.通过判断是否拥有“查看”权限，来判断是否是只读者，如果不是
 * 4.没有对应权限
 */
public static String getRole(JsonObject limits) {
    if(limits.get(&quot;mana&quot;).getAsBoolean())  {
        return &quot;owner&quot;;
    }else if(limits.get(&quot;edit&quot;).getAsBoolean()){
        return &quot;manager&quot;;
    }else if(limits.get(&quot;view&quot;).getAsBoolean()){
        return &quot;reader&quot;;
    }else{
        return &quot;nopm&quot;;
    }

}
</code></pre><p>}</p>
<p>if (role == “owner”) {<br>                // 0.新建html组件，1.新建分组，2..删除、3重命名、4.导入5.导出 6.刷新 7 移动到<br>                menu.getXMenuItem(0).setVisible(true);<br>                menu.getXMenuItem(1).setVisible(true);<br>                menu.getXMenuItem(2).setVisible(false);<br>                menu.getXMenuItem(3).setVisible(false);<br>                menu.getXMenuItem(4).setVisible(true);<br>                menu.getXMenuItem(5).setVisible(true);<br>                menu.getXMenuItem(6).setVisible(false);<br>                menu.getXMenuItem(7).setVisible(false);</p>
<pre><code>      }
      if (role == &quot;manager&quot;) {
          menu.getXMenuItem(0).setVisible(true);
          menu.getXMenuItem(1).setVisible(true);
          menu.getXMenuItem(2).setVisible(false);
          menu.getXMenuItem(3).setVisible(false);
          menu.getXMenuItem(4).setVisible(true);
          menu.getXMenuItem(5).setVisible(true);
          menu.getXMenuItem(6).setVisible(false);
          menu.getXMenuItem(7).setVisible(false);
      }
      if (role == &quot;reader&quot;) {
          menu.getXMenuItem(0).setVisible(false);
          menu.getXMenuItem(1).setVisible(false);
          menu.getXMenuItem(2).setVisible(false);
          menu.getXMenuItem(3).setVisible(false);
          menu.getXMenuItem(4).setVisible(false);
          menu.getXMenuItem(5).setVisible(true);
          menu.getXMenuItem(6).setVisible(false);
          menu.getXMenuItem(7).setVisible(false);

      }
      if (role == &quot;nopm&quot;) {
          menu.getXMenuItem(0).setVisible(false);
          menu.getXMenuItem(1).setVisible(false);
          menu.getXMenuItem(2).setVisible(false);
          menu.getXMenuItem(3).setVisible(false);
          menu.getXMenuItem(4).setVisible(false);
          menu.getXMenuItem(5).setVisible(true);
          menu.getXMenuItem(6).setVisible(false);
          menu.getXMenuItem(7).setVisible(false);
      }


if (role == &quot;owner&quot;) {
                // 0.查看 1.删除、2.重命名、3.克隆4.导出 5移动到
                menu.getXMenuItem(0).setVisible(true);
                menu.getXMenuItem(1).setVisible(false);
                menu.getXMenuItem(2).setVisible(true);
                menu.getXMenuItem(3).setVisible(true);
                menu.getXMenuItem(4).setVisible(true);
                menu.getXMenuItem(5).setVisible(false);

            }
            if (role == &quot;manager&quot;) {
                menu.getXMenuItem(0).setVisible(true);
                menu.getXMenuItem(1).setVisible(false);
                menu.getXMenuItem(2).setVisible(true);
                menu.getXMenuItem(3).setVisible(true);
                menu.getXMenuItem(4).setVisible(true);
                menu.getXMenuItem(5).setVisible(false);
            }
            if (role == &quot;reader&quot;) {
                menu.getXMenuItem(0).setVisible(true);
                menu.getXMenuItem(1).setVisible(false);
                menu.getXMenuItem(2).setVisible(false);
                menu.getXMenuItem(3).setVisible(true);
                menu.getXMenuItem(4).setVisible(true);
                menu.getXMenuItem(5).setVisible(false);


            }
            if (role == &quot;nopm&quot;) {
                menu.getXMenuItem(0).setVisible(true);
                menu.getXMenuItem(1).setVisible(false);
                menu.getXMenuItem(2).setVisible(false);
                menu.getXMenuItem(3).setVisible(true);
                menu.getXMenuItem(4).setVisible(true);
                menu.getXMenuItem(5).setVisible(false);

            }
</code></pre>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/08/eclipse多开/" rel="next" title="eclipse多开">
                <i class="fa fa-chevron-left"></i> eclipse多开
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/18/任务/" rel="prev" title="">
                 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars1.githubusercontent.com/u/18373908?s=400&u=026b7daa8652066dead5a989dd5e14fca44ee5dd&v=4"
                alt="DEMO" />
            
              <p class="site-author-name" itemprop="name">DEMO</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">352</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jack00000" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#应用1-完全控制-应用2-查看-编辑-应用3-查看"><span class="nav-number">1.</span> <span class="nav-text">应用1:完全控制   应用2.查看 编辑 应用3.查看</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DEMO</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v6.0.6</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
  







  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.6"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.6"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.6"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.6"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'oE8EtVBE3BRVVm3BrVTOfvEa-gzGzoHsz',
        appKey: 'q0zNeBPiVHGUwVwXEsSwWxmn',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=6.0.6"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=6.0.6"></script>


  

</body>
</html>
