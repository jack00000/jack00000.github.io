<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.6" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.6">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.6">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.6" color="#222">














<meta name="description" content="2019-1-201.代码比较啦一下  又全改啦 不小心 点啦全局的source format (应该选择编辑的区域-&amp;gt;source-&amp;gt;format) 解决方法 replace  with head version-2.测试生成 其他 主题集 的代码 现在连接的数据库已经创建  需求1.owner manager 一级目录 去掉删除 移动的2.owner manager  二级目录 编">
<meta property="og:type" content="article">
<meta property="og:title" content="现阶段要解决的问题">
<meta property="og:url" content="http://yoursite.com/2019/01/20/现阶段要解决的问题/index.html">
<meta property="og:site_name" content="HEXO">
<meta property="og:description" content="2019-1-201.代码比较啦一下  又全改啦 不小心 点啦全局的source format (应该选择编辑的区域-&amp;gt;source-&amp;gt;format) 解决方法 replace  with head version-2.测试生成 其他 主题集 的代码 现在连接的数据库已经创建  需求1.owner manager 一级目录 去掉删除 移动的2.owner manager  二级目录 编">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-01-24T01:17:23.405Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="现阶段要解决的问题">
<meta name="twitter:description" content="2019-1-201.代码比较啦一下  又全改啦 不小心 点啦全局的source format (应该选择编辑的区域-&amp;gt;source-&amp;gt;format) 解决方法 replace  with head version-2.测试生成 其他 主题集 的代码 现在连接的数据库已经创建  需求1.owner manager 一级目录 去掉删除 移动的2.owner manager  二级目录 编">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.6',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: 'undefined',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/01/20/现阶段要解决的问题/"/>





  <title>现阶段要解决的问题 | HEXO</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HEXO</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule/" rel="section">
            
            Schedule
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
            Sitemap
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/20/现阶段要解决的问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="DEMO">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars1.githubusercontent.com/u/18373908?s=400&u=026b7daa8652066dead5a989dd5e14fca44ee5dd&v=4">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HEXO">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">现阶段要解决的问题</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-01-20T20:13:10+08:00">
                2019-01-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/亿信华辰/" itemprop="url" rel="index">
                    <span itemprop="name">亿信华辰</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/20/现阶段要解决的问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/01/20/现阶段要解决的问题/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="2019-1-20"><a href="#2019-1-20" class="headerlink" title="2019-1-20"></a>2019-1-20</h1><h2 id="1-代码比较啦一下-又全改啦"><a href="#1-代码比较啦一下-又全改啦" class="headerlink" title="1.代码比较啦一下  又全改啦"></a>1.代码比较啦一下  又全改啦</h2><ul>
<li>不小心 点啦全局的source format (应该选择编辑的区域-&gt;source-&gt;format)</li>
<li>解决方法 replace  with head version<br>-<h2 id="2-测试生成-其他-主题集-的代码"><a href="#2-测试生成-其他-主题集-的代码" class="headerlink" title="2.测试生成 其他 主题集 的代码"></a>2.测试生成 其他 主题集 的代码</h2></li>
<li>现在连接的数据库已经创建</li>
</ul>
<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>1.owner manager 一级目录 去掉删除 移动的<br>2.owner manager  二级目录 编辑 有删除 移动到<br>3.owner manager 组件 查看改编辑 有删除 移动到<br>3.其他文件夹 一，二级目录 只有导出  组件 查看 克隆 导出   </p>
<h2 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a>需求</h2><ol>
<li>系统启动创建 用户资源vfs/root/products/ebi/sys/userresource创建“其他”文件夹</li>
<li>创建主题集 应用1时 在vfs/root/products/ebi/sys/userresource 创建应用1 文件夹</li>
<li>为第二项模拟请求：<a href="http://localhost:8083/bi/taskmgr.do?action=createtask&amp;name=应用5&amp;appid=dcdcnd" target="_blank" rel="noopener">http://localhost:8083/bi/taskmgr.do?action=createtask&amp;name=应用5&amp;appid=dcdcnd</a></li>
</ol>
<h2 id="需求-2"><a href="#需求-2" class="headerlink" title="需求"></a>需求</h2><p>1.移动到只有应用1和下属文件夹 其他都过滤掉</p>
<p>/**</p>
<ul>
<li>酷屏左侧面板<br>*</li>
<li>@param wnd</li>
<li>@param parentElement</li>
<li>@param width</li>
<li>@param height</li>
<li>@returns<br>*/<br>function CoolTabPanel(wnd, parentElement, width, height) {<br> XTabCtrl.call(this, {<pre><code>wnd : wnd || window,
parentElement : parentElement,
width : width,
height : height,
enableclosed : false,
style : &quot;gray&quot;
</code></pre> });<br> this.pnode = parentElement;<br> this.getBodyContainer().style.padding = “0”;<br> this._panels = {<pre><code>cnt : 0
</code></pre> };<br> // 自定义控件主题集（及其控件）的角色<br> this.roles;<br> //为啦不对已有代码造成影响 把自定义组件中的主题集角色(owner manager..)json集合赋值给全局wnd<br> this.wnd.roles;<br>}</li>
</ul>
<p>extendClass(CoolTabPanel, XTabCtrl, “CoolTabPanel”);</p>
<p>CoolTabPanel.WIDGET = “CoolWidgetPanel”; // 组件<br>CoolTabPanel.OUTLINE = “CoolOutlinePanel”; // 组件结构<br>CoolTabPanel.SOURCE = “CoolSourcePanel”; // 数据源</p>
<p>CoolTabPanel.prototype.init = function(xmlnode) {<br>    if (!this.wnd[“XAccordionPanel”]) {// 引入js文件<br>        sys.lib.include(“xui/ctrls/xaccordionpanel.js”);<br>    }</p>
<pre><code>var node = xmlnode.firstChild;
var i = 0;
var active = -1;
while (node) {
    if (node.tagName == &quot;panel&quot;) {
        this.add(node.getAttribute(&apos;caption&apos;), null);
        if (parseBool(node.getAttribute(&apos;active&apos;), false) === true) {
            active = i;
        }
        var pdom = this.getBodyDom(i);
        var obj = createObjectByXmlNode(pdom, node);
        this.addPanel(obj, node);
        i++;
    }
    node = node.nextSibling;
}
this._initBtns();
if (active &gt;= 0) {
    this.setActivePanel(active);
}
</code></pre><p>};</p>
<p>CoolTabPanel.prototype._initBtns = function() {<br>    var lefthead = this.getHeaderContainer();<br>    var span = lefthead.appendChild(this.doc.createElement(“span”));<br>    g_dsn.layout.addPinBtn(span, “west”);<br>    span = lefthead.appendChild(this.doc.createElement(“span”));<br>    g_dsn.layout.addCloseBtn(span, “west”);<br>};</p>
<p>CoolTabPanel.prototype.getTabCount = function() {<br>    return this._panels.cnt;<br>};</p>
<p>CoolTabPanel.prototype.getPanel = function(index) {<br>    return this._panels[index];<br>};<br>/**</p>
<ul>
<li>返回html组件所在的面板对象<br>*</li>
<li>@returns<br>*/<br>CoolTabPanel.prototype.getHtmlWidgetPanel = function() {<br> return this.getPanel(0).htmlWidgetPanel;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>获得数据源面板对象<br>*</li>
<li>@returns<br>*/<br>CoolTabPanel.prototype.getDataSourcePanel = function() {<br> return this[“panel” + CoolTabPanel.SOURCE];<br>};</li>
</ul>
<p>CoolTabPanel.prototype.setDataSourceVisible = function(show) {<br>    var dsobj = this[“panel” + CoolTabPanel.SOURCE];<br>    if (!dsobj)<br>        return;<br>    var idx = dsobj.tabindex;<br>    this.setTabVisible(idx, parseBool(show, true));<br>};</p>
<p>CoolTabPanel.prototype.getOutlinePanel = function() {<br>    return this[“panel” + CoolTabPanel.OUTLINE];<br>};<br>CoolTabPanel.prototype.setOutlineVisible = function(show) {<br>    var idx = this[“panel” + CoolTabPanel.OUTLINE].tabindex;<br>    this.setTabVisible(idx, parseBool(show, true));<br>};</p>
<p>CoolTabPanel.prototype.getWidgetPanel = function() {<br>    return this[“panel” + CoolTabPanel.WIDGET];<br>};</p>
<p>CoolTabPanel.prototype.setWidgetPanelVisible = function(show) {<br>    var idx = this[“panel” + CoolTabPanel.WIDGET].tabindex;<br>    this.setTabVisible(idx, parseBool(show, true));<br>};</p>
<p>/**</p>
<ul>
<li>根据面板的对象类型<br>*</li>
<li>@param clsName</li>
<li>@returns<br>*/<br>CoolTabPanel.prototype.getPanelByClass = function(clsName) {<br> for ( var i = 0, len = this._panels.cnt; i &lt; len; i++) {<pre><code>var panel = this.getPanel(i);
// ESENBI-10928:IE浏览器panel.constructor.name为undefined
if (panel.constructor.name === clsName
        || panel instanceof eval(clsName)) {
    return panel;
}
</code></pre> }<br>};</li>
</ul>
<p>CoolTabPanel.prototype.addPanel = function(panel, node) {<br>    var i = this._panels.cnt;<br>    this._panels[i] = panel;<br>    this._panels.cnt++;</p>
<pre><code>this[&quot;panel&quot; + node.getAttribute(&quot;object&quot;)] = panel;
panel.tabindex = i;
</code></pre><p>};</p>
<p>CoolTabPanel.prototype.getActivePanel = function() {<br>    return this.getPanel(this.getActiveIndex());<br>};</p>
<p>CoolTabPanel.prototype.setActivePanel = function(index) {<br>    this.setActive(index);<br>};</p>
<p>CoolTabPanel.prototype.dispose = function() {<br>    // if (this.getIndex(1) !== -1) {<br>    // $(this.getBodyDom(1).firstChild).draggable(“destroy”);<br>    // }<br>    // 销毁自己的对象<br>    for ( var i = 0; i &lt; this._panels.cnt; i++) {<br>        var obj = this._panels[i];<br>        if (obj &amp;&amp; obj.dispose)<br>            obj.dispose();<br>    }<br>    this._panels = null;<br>    // 销毁父类对象<br>    XTabCtrl.prototype.dispose.call(this);<br>};</p>
<p>function CoolWidgetPanel(wnd, parentElement, width, height) {<br>    this.wnd = wnd || window;<br>    this.doc = this.wnd.document;<br>    this.pnode = parentElement;<br>    parentElement.style.overflow = “hidden”;<br>    this.acpanel = new window<a href="this.wnd, parentElement,
            width, height">“XAccordionPanel”</a>;<br>    this.acpanel.container.style.height = “100%”;<br>    this.isMaxExpanded = true;<br>}</p>
<p>CoolWidgetPanel.prototype._bindEvent = function() {<br>    var self = this;<br>    $(this.pnode).bind(“resize”, function() {<br>        this.doLayout();<br>    }.bind(this));<br>    $(this.acpanel.container).bind(“mouseover”, this.onHover.bind(this));<br>    $(this.acpanel.container).bind(“mouseout”, function() {<br>        if (self.htmlWidgetPanel._timer) {<br>            clearTimeout(self.htmlWidgetPanel._timer);<br>        }<br>        if (self.htmlWidgetPanel.previewpanel) {<br>            self.htmlWidgetPanel.previewpanel.style.display = “none”;<br>        }<br>    });// 清除鼠标悬浮未1s执行的动作<br>    $(this.acpanel.container).bind(“mousedown.left”,<br>            this.onDragSatrt.bind(this));<br>};</p>
<p>CoolWidgetPanel.prototype.doLayout = function() {<br>    if (!isCSS1Compat || this.pnode.clientHeight === 0) {<br>        return;<br>    }<br>    this.acpanel.relayout();<br>};</p>
<p>CoolWidgetPanel.prototype.onDragSatrt = function(evt) {<br>    if (this.htmlWidgetPanel.previewpanel) {<br>        this.htmlWidgetPanel.previewpanel.style.display = “none”;<br>    }<br>    if (evt.which === 3) {<br>        return;<br>    }<br>    var design = g_dsn.getDesign();<br>    if (design &amp;&amp; design.isVisible()) {<br>        design.dragStart(evt);<br>    }<br>};</p>
<p>CoolWidgetPanel.prototype._unbindEvent = function() {<br>    $(this.pnode).unbind(“resize mousedown”);<br>    $(this.acpanel.container).unbind(“mousedown.left”);<br>};</p>
<p>/**</p>
<ul>
<li>获取一个临时的dom<br>*</li>
<li>@returns<br>*/<br>CoolWidgetPanel.prototype._getTempDiv = function() {<br> if (!this.dom4clone) {<pre><code>/*
 * 为了少创建克隆节点把他放到此处
 */
var dom4clone = this.doc.createElement(&quot;div&quot;);
var DEFAULT_IMAGE_SIZE = 16;
dom4clone.innerHTML = &apos;&lt;div style=&quot;position: absolute; left: 6px; width: &apos;
        + DEFAULT_IMAGE_SIZE
        + &apos;px; height: &apos;
        + DEFAULT_IMAGE_SIZE
        + &apos;px; margin: 0; background-color: #FFF; background-position: center; background-repeat: no-repeat&quot;&gt;&lt;/div&gt;&apos;
        + &apos;&lt;div style=&quot;position: absolute; left: &apos;
        + (DEFAULT_IMAGE_SIZE + 10)
        + &apos;px; right: 2px; line-height: &apos;
        + DEFAULT_IMAGE_SIZE
        + &apos;px; height: &apos;
        + (DEFAULT_IMAGE_SIZE + 2)
        + &apos;px; border: 1px dotted transparent; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis&quot;&gt;&lt;/div&gt;&apos;;
dom4clone.style.cssText += &apos;; position: relative; height: &apos;
        + (DEFAULT_IMAGE_SIZE + 2)
        + &apos;px; cursor: pointer; border: 1px dotted transparent; margin: 5px 0 0 5px;&apos;;
this.dom4clone = dom4clone;
</code></pre> }<br> return this.dom4clone;<br>};</li>
</ul>
<p>CoolWidgetPanel.prototype.init = function(xmlnode) {<br>    var dom4clone = this._getTempDiv();<br>    this.chart = parseBool(_initItemMenu(8), true);<br>    var node = xmlnode.firstChild;<br>    var jsarray = [];<br>    this.vfsjs = [];// vfs中js,必须单独加载，不能批量加载，而且又可能依赖之前js，所以需要最后加载<br>    while (node) {<br>        if (node.tagName == ‘group’) {<br>            jsarray = jsarray.concat(this._initGroup(node, dom4clone));<br>        }<br>        node = node.nextSibling;<br>    }<br>    this._bindEvent();</p>
<p>};</p>
<p>CoolWidgetPanel.prototype._initGroup = function(xmlnode, dom4clone) {<br>    var caption = xmlnode.getAttribute(‘caption’);<br>    var path = xmlnode.getAttribute(‘path’);<br>    var id = xmlnode.getAttribute(“id”);<br>    var expanded = xmlnode.getAttribute(“expanded”);<br>    // html和统计图<br>    var subpanel = this.acpanel.addSubPanel(caption, null, null);<br>    subpanel.setId(id);<br>    subpanel.setUndocBtnVisible(false);<br>    subpanel.setDeleteBtnVisible(false);<br>    if (expanded === “false”) {<br>        subpanel.setCollapsed();<br>    } else {<br>        subpanel.setExpanded();<br>    }<br>    if (id === “customhtml”) {<br>        // html组件单独组件<br>        this._initCustomHtml(subpanel, xmlnode);<br>        return;<br>    }<br>    var subpaneldom = subpanel.getContentDom();<br>    var node = xmlnode.firstChild;<br>    var jsicls = [];// war包中js<br>    this.vfsjs = [];// vfs中的js<br>    while (node) {<br>        if (node.tagName === ‘cwidget’) {<br>            var icl = this<br>                    ._createWidget(subpaneldom, node, dom4clone, path, id);<br>            if (icl &amp;&amp; icl.indexOf(‘/vfs/‘) &gt; -1) {<br>                // 如果是vfs路径要单独处理,不能跟war包中路径一起加载<br>                if (this.vfsjs.indexOf(icl) === -1)<br>                    this.vfsjs.push(icl);<br>            } else {<br>                if (jsicls.indexOf(icl) === -1)<br>                    jsicls.push(icl);<br>            }<br>        }<br>        node = node.nextSibling;<br>    }<br>    return jsicls;<br>};</p>
<p>CoolWidgetPanel.prototype._initCustomHtml = function(subpanel, xmlnode) {<br>    var htmlpanel = new CoolHTMLWidgetSubPanel(subpanel);<br>    htmlpanel.init(xmlnode);<br>    this.htmlWidgetPanel = htmlpanel;<br>};</p>
<p>/**</p>
<ul>
<li>创建单个组件的节点<br>*</li>
<li>@param pnode</li>
<li>@param xmlnode</li>
<li>@param dom4clone</li>
<li>@param path<br>*/<br>CoolWidgetPanel.prototype._createWidget = function(pnode, xmlnode, dom4clone,<pre><code>path, pid) {
</code></pre> var obj = {};<br> var atts = xmlnode.attributes;<br> for ( var i = 0; i &lt; atts.length; i++) {<pre><code>obj[atts[i].name] = atts[i].value;
</code></pre> }<br> var objname = obj[“jsobject”] || obj[“object”];<br> if (this.chart === false) {<pre><code>// 没有统计图权限
if (&quot;CWidgetGrid&quot; != objname)
    return;
</code></pre> }<br> var objpath = obj[“path”];<br> var jspath = (objpath || path || “ebi/user/coolrptdsn/widget/“)<pre><code>+ objname.toLowerCase() + &quot;.js&quot;;
</code></pre> var widgetobj = pnode.appendChild(dom4clone.cloneNode(true));<br> widgetobj.id = obj[“id”];<br> widgetobj.firstChild.setAttribute(“dragparam”, JSON.stringify(obj));<br> widgetobj.title = obj[“caption”];<br> widgetobj.lastChild.innerHTML = obj[“caption”];<br> widgetobj.firstChild.style.backgroundImage = ‘url(‘ + (obj[“img”]) + ‘)’;<br> if (pid === “elem”) {<pre><code>widgetobj.setAttribute(&quot;dragtype&quot;, pid);
</code></pre> } else {<pre><code>widgetobj.setAttribute(&quot;dragtype&quot;, &quot;cwidget&quot;);
</code></pre> }<br> return jspath;<br>};</li>
</ul>
<p>CoolWidgetPanel.prototype.dispose = function() {<br>    if (this.dom4clone) {<br>        this.dom4clone = null;<br>    }<br>    this._unbindEvent();<br>};</p>
<p>/**</p>
<ul>
<li>html组件面板<br>*/<br>function CoolHTMLWidgetSubPanel(subpanel) {<br> this.panel = subpanel;<br> this.owner = subpanel.owner;<br> this.wnd = this.owner.wnd;<br> this.doc = this.owner.doc;<br>}</li>
</ul>
<p>CoolHTMLWidgetSubPanel.prototype.dispose = function() {<br>    if (this.searcher) {<br>        this.searcher.dispose();<br>    }<br>    if (this.contextMenu) {<br>        for ( var type in this.contextMenu) {<br>            var menu = this.contextMenu[type];<br>            menu.dispose();<br>            this.contextMenu[type] = null;<br>        }<br>    }<br>    $(panel.container).unbind(‘mousedown’);<br>    this.xtree.dispose();<br>    this.xtree = null;<br>    this.panel = null;<br>    this.owner = null;<br>    this.wnd = null;<br>    this.doc = null;<br>};</p>
<p>CoolHTMLWidgetSubPanel.ACTION_URL = “edithtmlwidget.do”;<br>CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_DIR_SYS = “ebi/user/coolrptdsn/images/widget/inner_group.png”;<br>CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_DIR_USER = “ebi/user/coolrptdsn/images/widget/customize_group.png”;<br>CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_SYS_HTML = “ebi/user/coolrptdsn/images/widget/inner.png”;<br>CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_USER_HTML = “ebi/user/coolrptdsn/images/widget/customize.png”;<br>CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_DIR = “ebi/images/lefttree/folder.gif”;</p>
<p>CoolHTMLWidgetSubPanel.prototype.init = function(xmlnode) {<br>    this.typepath = xmlnode.getAttribute(“path”);<br>    var panel = this.panel, head = panel.getTitleDom(), body = panel<br>            .getContentDom();<br>    body.style.overflow = “hidden”;<br>    // 添加功能按钮”添加”<br>    $(<br>            ‘<span id="searchhtmlwidget" class="accordionSubPanel_button icon_search"></span>‘)<br>            .appendTo(head);<br>    this._initTree(body);<br>    this._bindEvent();<br>};<br>CoolHTMLWidgetSubPanel.prototype._initTree = function(body) {<br>    this.xtree = new XTree(this.wnd, body);<br>    this.xtree.dontInsertBlankNode = true;<br>    this.xtree.setOnExpand(this._onExpandTreeItem.bind(this));<br>    this.xtree.rootItem._loaded = true;<br>    this.xtree.enableCtrlSelect(true);</p>
<pre><code>var item = this.xtree.appendChild(I18N.getString(
        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.sys&quot;, &quot;内置组件&quot;));
item.setItemImage(CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_DIR_SYS);
item.type = &quot;folder&quot;;
item.setHasChildren(true);
item.basepath = item.id = this.typepath + &quot;coolsyswidget&quot;;
item.setExpanded(true);
var item = this.xtree.appendChild(I18N.getString(
        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.user&quot;, &quot;自定义组件&quot;));
item.setItemImage(CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_DIR_USER);
item.setHasChildren(true);
item.type = &quot;folder&quot;;
item.basepath = item.id = &quot;/root/products/ebi/sys/coolrpt/&quot; + &quot;cooluserwidget&quot;;
item.setExpanded(true);
this.xtree.setOnExpand(null);
</code></pre><p>};</p>
<p>/**</p>
<ul>
<li>获取文件的请求路径<br>*</li>
<li>@param item</li>
<li>@param node<br>*/<br>CoolHTMLWidgetSubPanel.prototype.getBasePath = function(item, node) {<br> var changeitem = item, root = this.xtree.getRootItem(), basepath;<br> while (root !== changeitem) {<pre><code>basepath = changeitem.basepath;
if (basepath) {
    break;
}
changeitem = changeitem.getParentItem();
</code></pre> }<br> if (!node) {<pre><code>return basepath;
</code></pre> }<br> if (basepath) {<pre><code>var param = node.getAttribute(&quot;dragparam&quot;);
param = JSON.parse(param);
param.basepath = basepath;
node.setAttribute(&quot;dragparam&quot;, JSON.stringify(param));
</code></pre> }<br>};<br>/**</li>
<li>返回item对应的vfs文件路径<br>*</li>
<li>@param item<br>*/<br>CoolHTMLWidgetSubPanel.prototype.getHtmlTreeItemPath = function(item) {<br> var path = [], changeitem = item;<br> while (!changeitem.basepath) {<pre><code>path.splice(0, 0, changeitem.id);
changeitem = changeitem.getParentItem();
</code></pre> }<br> path.splice(0, 0, changeitem.basepath);<br> path = path.join(“/“);<br> return item.type === “widgetfile” ? (path + “.json”) : path;<br>};</li>
</ul>
<p>CoolHTMLWidgetSubPanel.prototype._onExpandTreeItem = function(item) {<br>    if (item._loaded) {<br>        return;<br>    }<br>    var map = new Map();<br>    map.put(“action”, “list”);<br>    map.put(“basepath”, this.typepath);<br>    map.put(“path”, item.id);<br>    QueryObj.create(CoolHTMLWidgetSubPanel.ACTION_URL, map, function(q) {<br>        try {<br>            q.checkResult();<br>            var xmldom = q.getResponseXML();<br>            this._loadChildNodes(xmldom, item);<br>        } catch (e) {<br>            showError(e);<br>        }<br>    }.bind(this));<br>};</p>
<p>/**</p>
<ul>
<li>根据xml文件加载item下的子节点<br>*</li>
<li>@param xmldom</li>
<li>@param item<br>*/<br>CoolHTMLWidgetSubPanel.prototype._loadChildNodes = function(xmldom, item) {<br> item._loaded = true;<br> if (!xmldom)<pre><code>return;
</code></pre> xmldom = xmldom.documentElement;// 根节点<br> var id = xmldom.getAttribute(“basepath”);<br> item.id = id;<br> item.basepath = id;<br> item.loadFromXml(xmldom, this._addChildItem.bind(this, this.isSysPath(id)));<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>加载节点<br>*</li>
<li>@param item</li>
<li>@param node<br>*/<br>CoolHTMLWidgetSubPanel.prototype._addChildItem = function(isSys, item, node) {<br> var type = node.tagName;<br> if (type === “group”) {<pre><code>this.__afterAddFolderItem(item, node.getAttribute(&quot;caption&quot;));
</code></pre> } else if (type === “widget”) {<pre><code>this.__afterAddWidgetItem(item, node.getAttribute(&quot;id&quot;), node
        .getAttribute(&quot;caption&quot;), node.getAttribute(&quot;img&quot;), isSys);
</code></pre> }<br>};</li>
</ul>
<p>CoolHTMLWidgetSubPanel.prototype.__afterAddFolderItem = function(childItem, id) {<br>    childItem.id = id;<br>    childItem.type = “folder”;<br>    childItem.setHasChildren(true);<br>    childItem._isLoaded = true;<br>    childItem.setItemImage(CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_DIR);<br>};<br>/**</p>
<ul>
<li>添加组件节点的后续处理，设置类型和拖拽参数<br>*</li>
<li>@param childItem</li>
<li>添加的节点</li>
<li>@param id</li>
<li>@param cap</li>
<li>@param img</li>
<li>@param issyswidget</li>
<li>是否是内置组件<br>*/<br>CoolHTMLWidgetSubPanel.prototype.__afterAddWidgetItem = function(childItem, id,<br>cap, img, issyswidget) {<br>childItem.id = id;<br>if (!img) {<br>img = issyswidget ? CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_SYS_HTML<br>  : CoolHTMLWidgetSubPanel.RESOURCETREE_IMG_USER_HTML;<br>}<br>childItem.setItemImage(img);<br>var dragDom = this._getDragDomByItem(childItem);<br>if (id.startsWith(“elem”)) {<br>// 特殊的容器<br>childItem.type = “elem”;<br>dragDom.setAttribute(“dragtype”, “elem”);<br>if (id === “elem_div”) {<br>dragDom<pre><code>.setAttribute(
        &quot;dragparam&quot;,
        JSON
                .stringify({
                    &quot;id&quot; : &quot;div&quot;,
                    &quot;object&quot; : &quot;CoolElemOperator&quot;,
                    &quot;caption&quot; : &quot;div&quot;,
                    &quot;droppable&quot; : &quot;true&quot;,
                    &quot;defparam&quot; : &quot;width=300px;height=170px;bgcolor=#FFFFFF;border=1px solid #D7D7D7&quot;
                }));
</code></pre>} else {<br>dragDom.setAttribute(“dragparam”, JSON.stringify({<br>  id : id,<br>  cap : cap<br>}));<br>}<br>} else {<br>childItem.type = “widgetfile”;<br>dragDom.setAttribute(“dragtype”, “chtmlwidget”);<br>dragDom.setAttribute(“dragparam”, JSON.stringify({<br>object : id,<br>cap : cap<br>}));<br>}<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>前台手动添加分组<br>*</li>
<li>@param item</li>
<li>父节点</li>
<li>@param childData</li>
<li>要添加的子分组节点 {cap:”文件夹名称”}</li>
<li>@param beforeItem</li>
<li>要插在的节点前面<br>*/<br>CoolHTMLWidgetSubPanel.prototype._addFolderItem = function(item, childData,<br>beforeItem) {<br>var childItem = !!beforeItem ? item.insertChildBefore(childData[“cap”],<br>beforeItem) : item.appendChild(childData[“cap”]);<br>this.__afterAddFolderItem(childItem, childData[“cap”]);<br>childItem.selectSelf(true, false, true, true);<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>前台手动添加组件节点<br>*</li>
<li>@param item</li>
<li>父节点</li>
<li>@param childData</li>
<li>要添加的子组件节点 {cap:”文件夹名称”, id:”CHtmlWidgetxx”, img:”可空”}</li>
<li>@param beforeItem</li>
<li>要插在的节点前面<br>*/<br>CoolHTMLWidgetSubPanel.prototype._addWidgetItem = function(item, childData,<br>beforeItem) {<br>var cap = childData[“cap”];<br>var childItem = !!beforeItem ? item.insertChildBefore(cap, beforeItem)<br>: item.appendChild(cap);<br>this<br>.__afterAddWidgetItem(childItem, childData[“id”], cap,<pre><code>childData[&quot;img&quot;]);
</code></pre>childItem.selectSelf(true, false, true, true);<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>绑定事件<br>*/<br>CoolHTMLWidgetSubPanel.prototype._bindEvent = function() {<br> var tree = this.xtree, panel = this.panel;<br> $(panel.subcontainer)<pre><code>.bind(&apos;mousedown&apos;, this.bindMDowdAfterEvent.bind(this));
</code></pre> tree.setOnContextMenu(function(item, e, tree) {<pre><code>if (!item)
    return true;
if (item.type) {
    return this.cmd_showContextMenu(e, item);
}
</code></pre> }.bind(this));<br> $(“#searchhtmlwidget”).bind(“click”, function() {<pre><code>return false;
</code></pre> });<br>};</li>
</ul>
<p>/*<em>
 </em></p>
<ul>
<li>@param evt</li>
<li>@returns {Boolean}<br>*/<br>CoolHTMLWidgetSubPanel.prototype.bindMDowdAfterEvent = function(evt) {<br> var target = evt.target, id = target.id;<br> if (id === “searchhtmlwidget”) {<pre><code>this.cmd_searchHtmlWidget(evt);
return false;
</code></pre> } else if (evt.which !== 3) {<pre><code>// 拖拽
var design = g_dsn.getDesign();
if (design &amp;&amp; design.isVisible()) {
    evt.isdraghtml = true;
    design.dragStart(evt);
}
</code></pre> }<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>组件搜索<br>*/<br>CoolHTMLWidgetSubPanel.prototype.cmd_searchHtmlWidget = function(item) {<br> var searcher = this.getSearcher();<br> searcher.toggleShow();<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>搜索的实际操作<br>*</li>
<li><p>@returns<br>*/<br>CoolHTMLWidgetSubPanel.prototype.getSearcher = function() {<br> var searchRule = function(item, value) {</p>
<pre><code>var caption = item.getItemText().toUpperCase();
return caption.indexOf(value) != -1;
</code></pre><p> }.bind(this);<br> if (!this.searcher) {</p>
<pre><code>this.searcher = (function(tree, pnode, searchRule) {
    function Finder4HtmlWidget(tree, pnode) {
        this.pnode = pnode;
        this.xtree = tree;
        _initDom.call(this);
        _bindEvt.call(this);
    }
    function _initDom() {
        this.isshow = false;
        this.basenode = $(
                &apos;&lt;div class=&quot;searchhtmlwidget&quot;&gt;&lt;input type=&quot;text&quot;/&gt;&lt;a class=&quot;icon_search&quot;&gt;&lt;/a&gt;&lt;/div&gt;&apos;)
                .prependTo(this.pnode)[0];
        this.searchInput = this.basenode.firstChild;
        this.searchButton = this.basenode.lastChild;
    }
    function _bindEvt() {
        $(this.searchInput).bind(&quot;keydown&quot;, function(e) {
            if (e.keyCode === 13) {
                this.doSearch();
                return false;
            } else {
                e.stopPropagation();
            }
        }.bind(this));
        $(this.searchButton).bind(&quot;click&quot;, function(e) {
            this.doSearch();
        }.bind(this));
    }
    function _unbindEvt() {
        $(this.searchInput).unbind(&quot;keydown&quot;);
        $(this.searchButton).unbind(&quot;click&quot;);
    }

    Finder4HtmlWidget.prototype = {
        hide : function() {
            if (this.isshow) {
                this.pnode.style.paddingTop = &quot;0px&quot;;
                this.basenode.style.display = &quot;none&quot;;
                this.isshow = false;
            }
        },
        show : function() {
            if (!this.isshow) {
                this.pnode.style.paddingTop = &quot;24px&quot;;
                this.basenode.style.display = &quot;block&quot;;
                this.searchInput.focus();
                this.isshow = true;
            }
        },
        toggleShow : function() {
            if (this.isshow) {
                this.hide();
            } else {
                this.show();
            }
        },
        setSearchRule : function(func) {
            this.searchRule = func;
        },
        doSearch : function(value) {
            var val = (value || this.searchInput.value).trim();
            if (!val)
                return;
            val = val.toUpperCase();
            var tree = this.xtree;
            tree.search(function(item, value) {
                return this.searchRule(item, value);
            }.bind(this), val, function() {
                tree.clearSelectedItems();
                tree.setFocusItem(null);
                this.doSearch();
            }.bind(this), true);
        },
        dispose : function() {
            _unbindEvt.call(this);
            this.xtree = null;
            this.pnode = null;
            this.basenode = null;
            this.searchInput = null;
            this.searchButton = null;
        }
    };

    var searchobj = new Finder4HtmlWidget(tree, pnode);
    searchobj.setSearchRule(searchRule);
    return searchobj;
})(this.xtree, this.panel.getContentDom(), searchRule);
</code></pre><p> }<br> return this.searcher;<br>};</p>
</li>
</ul>
<p>CoolHTMLWidgetSubPanel.prototype._createHTMLWidget = function(conf) {<br>    for ( var i = 0, len = conf.length; i &lt; len; i++) {<br>        var obj = conf[i];<br>        this.addHtmlWidgetDiv(obj);<br>    }<br>};</p>
<p>CoolHTMLWidgetSubPanel.prototype._getDragDomByItem = function(item) {<br>    return item.getItemDom().parentNode.firstChild;<br>};<br>CoolHTMLWidgetSubPanel.prototype.getSysRootItem = function() {<br>    return this.xtree.getRootItem().getChildItem(0);<br>};<br>CoolHTMLWidgetSubPanel.prototype.getUserRootItem = function() {<br>    return this.xtree.getRootItem().getChildItem(1);<br>};<br>/**</p>
<ul>
<li>返回组件id为widgetId的树节点<br>*</li>
<li>@param widgetId</li>
<li><p>@returns item 可能为空<br>*/<br>CoolHTMLWidgetSubPanel.prototype.getWidgetItemById = function(widgetId) {<br> var rootItem = this.xtree.getRootItem();<br> var item = getItemById.call(rootItem, widgetId);<br> return item;</p>
<p> function getItemById(id) {</p>
<pre><code>for ( var i = 0; i &lt; this.getChildrenCount(); i++) {
    var item = this.getChildItem(i);
    if (item.id === id)
        return item;
    if (item.hasChildren()) {
        var r = getItemById.call(item, id);
        if (r)
            return r;
    }
}
</code></pre><p> }<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>属性面板上会调用，返回组件id对应的组件名称<br>*</li>
<li>@param widgetId</li>
<li>@returns<br>*/<br>CoolHTMLWidgetSubPanel.prototype.getWidgetCaptionById = function(widgetId) {<br> var item = this.getWidgetItemById(widgetId);<br> if (item) {<pre><code>return item.getItemText();
</code></pre> } else {<pre><code>return I18N.getString(
        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.unknown&quot;,
        &quot;未知&quot;);
</code></pre> }<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>根据组件路径返回组件的ID<br>*/<br>CoolHTMLWidgetSubPanel.prototype.getWidgetIdByPath = function(path) {<br> return path.substring(path.lastIndexOf(“/“) + 1, path.lastIndexOf(“.json”));<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>判断是否是内置组件<br>*</li>
<li>@param path</li>
<li>@returns<br>*/<br>CoolHTMLWidgetSubPanel.prototype.isSysPath = function(path) {<br> return path.endsWith(“coolsyswidget”);<br>};</li>
</ul>
<p>CoolHTMLWidgetSubPanel.prototype.saveHtmlWidget = function(content, treeItem,<br>        basepath, htmlwidgetdlg, capdlg) {<br>    var map = new Map();<br>    map.put(“action”, “savewidget”);<br>    if (treeItem.type === “widgetfile”) {<br>        map.put(“widgetId”, treeItem.id);<br>        map.put(“widgetpath”, this.getHtmlTreeItemPath(treeItem));<br>    } else {<br>        // 新建保存，新建另存为 /编辑已有组件另存为<br>        map.put(“foldpath”, this.getHtmlTreeItemPath(treeItem));<br>    }<br>    map.put(“definejson”, JSON.stringify(content));<br>    map.put(“basepath”, basepath);<br>    QueryObj<br>            .create(<br>                    CoolHTMLWidgetSubPanel.ACTION_URL,<br>                    map,<br>                    function(q) {<br>                        try {<br>                            q.checkResult();<br>                            var res = q.getResponseText();<br>                            if (!!res) {<br>                                var wtId = res, img = content.img;<br>                                if (treeItem.type === “widgetfile”) {<br>                                    wtId = treeItem.id;<br>                                } else {<br>                                    // //新建保存，新建另存为 /编辑已有组件另存为<br>                                    content.id = wtId;<br>                                    var beforeItem = this.getBeforeItem(<br>                                            treeItem, content.caption, false);<br>                                    this._addWidgetItem(treeItem, {<br>                                        id : wtId,<br>                                        cap : content.caption,<br>                                        img : img<br>                                    }, beforeItem);<br>                                    // 新创建的组件第一次保存的时候需要保存预览图<br>                                    var param = new Map();<br>                                    param.put(“path”, JSON.stringify(content));<br>                                    param<br>                                            .put(“folderpath”, map<br>                                                    .get(“basepath”));// 不带分组名<br>                                    new QueryObj(<br>                                            sys.getContextPath()</p>
<pre><code>                                + &quot;editcoolrpt.do?action=savePreview&quot;,
                        param,
                        function(query) {
                            try {
                                query.checkResult();
                                if (query.isResultOk()) {
                                    var json = query
                                            .getResponseJSON();
                                    if (json != null
                                            &amp;&amp; json.success) {
                                        // showWaitDialogAutoHidden(1000,
                                        // I18N.getString(&quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.savesuccess&quot;,&quot;保存预览图成功！&quot;));
                                    }
                                }
                            } catch (e) {
                                showError(e);
                                hideWaitDialogWithComplete();
                            }
                        });
            }
            // 更新缓存内容
            g_dsn
                    .updateHtmlWidgetDefineCache(wtId,
                            content);
            g_dsn.updateEditAreaHtmlWidget(wtId, content);
            htmlwidgetdlg.close();
            if (capdlg)
                capdlg.close();
            // if(treeItem.type === &quot;widgetfile&quot;){
            showWaitDialogAutoHidden(
                    1000,
                    I18N
                            .getString(
                                    &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.saveok&quot;,
                                    &quot;HTML组件保存成功！&quot;));
            // }
            /*
             * else {
             * showWaitDialog(I18N.getString(&quot;billocr.js.logfun.save&quot;,
             * &quot;HTML组件保存成功,正在保存预览图!&quot;)); }
             */
        }
    } catch (e) {
        showError(e);
    }
}.bind(this));
</code></pre><p>};<br>/**</p>
<ul>
<li>在树上新添加节点时，需要返回它要加入的位置 后台是按照文件夹在前，文件在后，且名称从小到大排序<br>*</li>
<li>@param cap<br>*/<br>CoolHTMLWidgetSubPanel.prototype.getBeforeItem = function(pitem, cap, isFolder) {<br> // 添加组件 直接添加到 父节点的最下面<br> if (!isFolder) {<pre><code>return null;
</code></pre> }<br> // 添加分组 直接添加到最后一个文件夹后面，没有文件夹就添加到最前面<br> for ( var i = pitem.getChildrenCount() - 1; i &gt;= 0; i–) {<pre><code>var citem = pitem.getChildItem(i);
if (citem.type === &quot;folder&quot;) {
    if (isFolder) {
        return citem.getNextSibling();
    }
}
</code></pre> }<br> return pitem.getChildItem(0);<br> // 返回第一个顺序大于cap的item<br> // for (var i = 0, len = pitem.getChildrenCount(); i &lt; len; i++){<br> // var citem = pitem.getChildItem(i), txt = citem.getItemText();<br> // if(citem.type === “folder”){<br> // if(isFolder &amp;&amp; txt &gt; cap){<br> // return citem;<br> // }<br> // } else {<br> // if(isFolder){<br> // return citem;<br> // } else if(txt &gt; cap){<br> // return citem;<br> // }<br> // }<br> // }<br>};</li>
</ul>
<p>CoolHTMLWidgetSubPanel.prototype.cmd_previewHtmlWidget = function(e) {<br>    if (!this.previewpanel) {<br>        this.previewpanel = $(<br>                “<div class="preview_panel">&lt;iframe frameborder=’0’ width=’100%’, height=’100%’&gt;<span class="icon_delete"></span></div>“)<br>                .appendTo(this.doc.body)[0];<br>        $(this.previewpanel.lastChild).bind(‘click’, function() {<br>            this.previousSibling.src = “about:blank”;<br>            this.parentElement.style.display = “none”;<br>            return false;<br>        });<br>    }<br>    var body = this.panel.getContentDom();<br>    this.previewpanel.style.cssText += “;left:” + (body.offsetWidth + 2)</p>
<pre><code>        + &quot;px;display:block;&quot;;
var ifrm = this.previewpanel.firstChild;

// 获得组件json
var widgetPath = getXComponentByDom(e.target).id;
var cache = g_dsn.getHtmlWidgetDefineCache();
var wtjson = cache[widgetPath];
if (wtjson) {
    ifrm.src = sys.getContextPath()
            + &quot;edithtmlwidget.do?action=showpreviewpage&quot;;
    $(ifrm).bind(&quot;load&quot;, function() {
        $(ifrm).unbind(&quot;load&quot;);
        this.contentWindow.setup(wtjson);
    });
    return;
}
var map = new Map();
map.put(&quot;action&quot;, &quot;getwidgetjson&quot;);
map.put(&quot;path&quot;, widgetPath);
QueryObj.create(CoolHTMLWidgetSubPanel.ACTION_URL, map, function(q) {
    try {
        q.checkResult();
        var wtjson = q.getResponseJSON();
        cache[widgetPath] = wtjson;
        ifrm.src = sys.getContextPath() + CoolHTMLWidgetSubPanel.ACTION_URL
                + &quot;?action=showpreviewpage&quot;;
        $(ifrm).bind(&quot;load&quot;, function() {
            $(ifrm).unbind(&quot;load&quot;);
            this.contentWindow.setup(wtjson);
        });
    } catch (e) {
        showError(e);
    }
}.bind(this));
return false;
</code></pre><p>};</p>
<p>/**</p>
<ul>
<li>重置内置html组件<br>*</li>
<li>@param e<br>*/<br>CoolHTMLWidgetSubPanel.prototype.cmd_refreshSysHtml = function(e) {<br> confirmDialog(I18N.getString(“ES.COMMON.PROMPT”, “提示”), I18N.getString(<pre><code>    &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.surereset&quot;,
    &quot;确定要重置更新html组件吗？&quot;), false, null, function() {
this.doRefreshSysHtml();
</code></pre> }.bind(this));</li>
</ul>
<p>};<br>/**</p>
<ul>
<li>重置内置html组件 1.请求后台读取war包内容到vfs 2.后台返回内置组件的配置xml文件信息 3.根据xml重新加载内置组件根节点<br>*</li>
<li><p>@param e<br>*/<br>CoolHTMLWidgetSubPanel.prototype.doRefreshSysHtml = function() {</p>
<p> showWaitDialog(I18N.getString(</p>
<pre><code>&quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.upating&quot;,
&quot;正在更新，请稍等......&quot;));
</code></pre><p> var map = new Map(), self = this;<br> map.put(“action”, “refreshsys”);<br> map.put(“basepath”, this.getSysRootItem().basepath);<br> QueryObj</p>
<pre><code>.create(
        CoolHTMLWidgetSubPanel.ACTION_URL,
        map,
        function(q) {
            try {
                q.checkResult();
                var xmldom = q.getResponseXML();
                var sysItem = self.getSysRootItem();
                sysItem.clearChildren();
                self._loadChildNodes(xmldom, sysItem);
                hideWaitDialogWithComplete(
                        1000,
                        I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.resentsuccess&quot;,
                                        &quot;组件更新成功！&quot;));
            } catch (e) {
                showError(e);
                return;
            }
        });
</code></pre><p>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>导入html组件<br>*/<br>CoolHTMLWidgetSubPanel.prototype.cmd_importHtmlWidget = function(item) {<br> var wtItem = item.getOwner()._ownerItem;<br> getObjectFromRootAsync(<pre><code>&quot;HtmlWidgetUploadDialog&quot;,
&quot;_HtmlWidgetUploadDialog_&quot;,
true,
&quot;ebi/user/coolrptdsn/dlg/upload.js,xui/third/jquery/plugins/jquery.form.js&quot;,
function(dlg) {
    dlg.show();
    dlg.setBasepath(this.getHtmlTreeItemPath(wtItem));
    dlg.setOnClose(function() {
        if (dlg.flag) {
            // 缓存处理
            var map = dlg.widgetInfo;
            for ( var wtId in map) {
                var content = JSON.parse(map[wtId]);
                // 更新缓存内容
                g_dsn.updateHtmlWidgetDefineCache(wtId, content);
                g_dsn.updateEditAreaHtmlWidget(wtId, content);
            }
            var usrItem = this.getUserRootItem();
            dlg.flag = null;
            dlg.widgetInfo = null;
            this.xtree.setOnExpand(function() {
                this._onExpandTreeItem(usrItem);
            }.bind(this));
            usrItem.setExpanded(false);
            usrItem.clearChildren();
            usrItem._shouldHasChildren = true;
            usrItem._adjustExpandImg();
            usrItem._loaded = false;
            usrItem.setExpanded(true);
            this.xtree.setOnExpand(null);
        }
    }.bind(this));
}.bind(this));
</code></pre> return false;<br>};<br>/**</li>
<li><p>树的右键菜单<br>*/<br>CoolHTMLWidgetSubPanel.prototype.cmd_showContextMenu = function(evt, item) {<br> var menu = null;<br> var basepath = this.getBasePath(item), issyspath = this.isSysPath(basepath);<br> if (this.xtree.getSelectedItemCount() &gt; 1) {</p>
<pre><code>var items = this.xtree.getSelectedItems();
var isSys = this.isSysPath(this.getBasePath(items[0]));
for ( var i = 0, len = items.length; i &lt; len; i++) {
    if (this.isSysPath(this.getBasePath(items[i])) != isSys) {
        showMessage(I18N
                .getString(
                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.nosameroot&quot;,
                        &quot;不可以同时选择内置组件和自定义组件下的资源&quot;));
        return;
    } else if (!!items[i].basepath) {
        showMessage(I18N
                .getString(
                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.notsameresource&quot;,
                        &quot;所选择的资源必须是同一类型，如选择了组件或组件分组， 那么多选的资源必须都是组件或组件分组!&quot;));
    }
}
menu = this.getShowMenu(&quot;mutliSelets&quot;, isSys);
</code></pre><p> } else {</p>
<pre><code>if (item.basepath &amp;&amp; item.basepath.endsWith(&quot;coolsyswidget&quot;)) {
    // 系统内置组件跟节点
    menu = this.getShowMenu(&quot;sysfolder&quot;);
} else if (item.type === &quot;folder&quot;) {
    // 文件夹
    if (issyspath) {
        menu = this.getShowMenu(&quot;sysgroup&quot;, !!item.basepath);
    } else {
        /*menu = this.getShowMenu(item.type, !!item.basepath);*/

        // fangjun add pm----------------------------------------
        //逻辑:取出所有主题集role(owner mana..) 将酷屏当前主题集角色取出来 不是酷屏当前主题集  全部设为reader
        // 自定义组件只有刷新
        var self = this;
        //自定义组件根目录走的是 isReadOnly
        if (item.itemText == &quot;自定义组件&quot;) {
            menu = self.getShowMenu(item.type, !!item.basepath);
            // 主题集文件夹
        } else {
            //获取控件当前所在主题集名称
            var presentZtj=self.wnd.g_dwSubjectSet.caption;
            if(presentZtj==null){
                presentZtj=self.wnd.dirname;
            }
            // 1.已定义全局变量this.roles 如果为null 请求后台角色数据
            var self = this;
            //文件夹所在主题集
            var ztjItem;
            var item1=item;
            //item 可能是主题集文件夹/分组文件夹  统一变成ztjItem
            //主题集文件是第2级    分组文件夹 和 主题集文件都会走  把itemRole绑在主题集节点
            //获得文件夹父节点 getLevel获取层级 判断是否是第2级/
            if(item1.getLevel()==2){
                ztjItem=item1.getParentItem();
            }else{
                while(item1.getLevel()!=2){
                    ztjItem=item1.getParentItem();
                    item1=item1.getParentItem();
                }
            }
            if (self.roles != null) {
                var exit = false;
                var itemRole;
                for ( var i = 0; i &lt; self.roles.length; i++) {
                    if (self.roles[i].itemId == ztjItem.id) {
                        exit = true;
                        itemRole = self.roles[i].role;
                        ztjItem.role=itemRole;

                    }
                }
                // 2.如果该主题集itemId在roles里面 不请求后端数据
                if (exit) {
                    menu = self.getShowMenu(item.type, !!item.basepath,
                            ztjItem.role,item);
                } else {
                    // 3.如果该主题集itemId不在roles里面 请求后端角色数据 再显示
                    var self = this;
                    var map = new Map();
                    map.put(&quot;action&quot;, &quot;getRoles&quot;);
                    map.put(&quot;presentZtj&quot;,presentZtj);
                    var q = QueryObj.create(&quot;edithtmlwidget.do&quot;, map);
                    try {
                        q.checkResult();

                        // 四种类型owner manager reader nopm
                        self.roles = q.getResponseJSON();
                        self.wnd.roles=q.getResponseJSON();
                    } catch (e) {
                        showError(e);
                        return;
                    }
                    var itemRole;
                    for ( var i = 0; i &lt; self.roles.length; i++) {
                        if (self.roles[i].itemId == item.id) {
                            itemRole = self.roles[i].role;
                            item.role=itemRole;
                            ztjItem.role=itemRole;

                        }
                    }
                    menu = self.getShowMenu(item.type, !!item.basepath,
                            ztjItem.role,item);

                }

            } else {
                // 2.如果该roles为空 请求后端角色数据 再显示
                var mapRoles = new Map();
                mapRoles.put(&quot;action&quot;, &quot;getRoles&quot;);
                mapRoles.put(&quot;presentZtj&quot;,presentZtj);
                var q = QueryObj.create(&quot;edithtmlwidget.do&quot;, mapRoles);
                try {
                    q.checkResult();            
                    // 四种类型owner manager reader nopm
                    self.roles = q.getResponseJSON();
                    self.wnd.roles=q.getResponseJSON();
                } catch (e) {
                    showError(e);
                    return;
                }
                var itemRole;
                for ( var i = 0; i &lt; self.roles.length; i++) {
                    if (self.roles[i].itemId == item.id) {
                        itemRole = self.roles[i].role;
                        item.role=itemRole;
                        ztjItem.role=itemRole;
                    }
                }
                menu = self.getShowMenu(item.type, !!item.basepath,
                        ztjItem.role,item);

            }
</code></pre></li>
</ul>
<pre><code>            }
        }
    } else if (item.type === &quot;widgetfile&quot;) {
        //逻辑:控件是在当前酷屏编辑主题集下 判断 owner mana 有,无删除
        //控件在其他主题集下 只有reader 角色 (和系统控件一样)
        var self = this;
        //控件所在主题集
        var ztjItem;
        var item1=item;
        if(item1.getLevel()==2){
            ztjItem=item1.getParentItem();
        }else{
            while(item1.getLevel()!=2){
                ztjItem=item1.getParentItem();
                item1=item1.getParentItem();
            }
        }

        //获取控件当前所在主题集名称
        var presentZtj=self.wnd.g_dwSubjectSet.caption;     
        if(presentZtj==null){
            presentZtj=self.wnd.dirname;
        }
            // this.roles不为空 控件直接找
            if (self.roles != null) {
                // 1.如果该控件父节点主题集itemId在roles里面 不请求后端数据
                var exit = false;
                var itemRole;

                for ( var i = 0; i &lt; self.roles.length; i++) {
                    if (self.roles[i].itemId == ztjItem.id) {
                        exit = true;
                        itemRole = self.roles[i].role;
                        item.getParentItem().role=itemRole;
                        //将角色赋予主题集文件夹节点
                        ztjItem.role=itemRole;
                    }
                }
                if (exit) {
                    // 1.2 如果控件父节点在roles对象中 直接显示
                    menu = self.getShowMenu(item.type, issyspath,
                            ztjItem.role);
                } else {
                    // 1.3 如果不在,后台获取数据显示
                    // 2.如果该主题集itemId不在roles里面 请求后端角色数据 再显示

                    var self = this;
                    var map = new Map();
                    map.put(&quot;action&quot;, &quot;getRoles&quot;);
                    map.put(&quot;presentZtj&quot;,presentZtj);
                    var q = QueryObj.create(&quot;edithtmlwidget.do&quot;, map);
                    try {
                        q.checkResult();

                        // 四种类型owner manager reader nopm
                        self.roles = q.getResponseJSON();
                        self.wnd.roles=q.getResponseJSON();
                    } catch (e) {
                        showError(e);
                        return;
                    }
                    var itemRole;
                    for ( var i = 0; i &lt; self.roles.length; i++) {
                        if (self.roles[i].itemId == item.getParentItem().id) {
                            itemRole = self.roles[i].role;
                            item.getParentItem().role=itemRole;
                            //将角色赋予主题集文件夹节点
                            ztjItem.role=itemRole;
                        }
                    }
                    menu = self.getShowMenu(item.type, issyspath,
                            ztjItem.role);
                }

            } else {
                // 2.如果该主题集itemId不在roles里面 请求后端角色数据 再显示

                var self = this;
                var map = new Map();
                map.put(&quot;action&quot;, &quot;getRoles&quot;);
                map.put(&quot;presentZtj&quot;,presentZtj);
                var q = QueryObj.create(&quot;edithtmlwidget.do&quot;, map);
                try {
                    q.checkResult();

                    // 四种类型owner manager reader nopm
                    self.roles = q.getResponseJSON();
                    self.wnd.roles=q.getResponseJSON();
                } catch (e) {
                    showError(e);
                    return;
                }
                var itemRole;
                for ( var i = 0; i &lt; self.roles.length; i++) {
                    if (self.roles[i].itemId == ztjItem.id) {
                        itemRole = self.roles[i].role;
                        //将角色赋予主题集文件夹节点
                        ztjItem.role=itemRole;

                    }
                }
                menu = self.getShowMenu(item.type, issyspath, itemRole);

            }



        // 组件
        // menu = this.getShowMenu(item.type, issyspath);
    }
}
if (menu) {
    menu._ownerItem = item;
    menu.popupAtCursor(evt);
}
</code></pre><p>};</p>
<p>/**</p>
<ul>
<li>type：widgetfile,folder,sysfolder 内置组件根节点：更新内置组件 内置组件分组：无操作 内置组件：克隆、查看;</li>
<li>内置组件的特殊容器：无<br>*</li>
<li>自定义组件根节点：新建html组件，新建分组，导入 自定义组件分组：新建html组件，新建分组，导入，重命名，删除</li>
<li>自定义组件：删除、克隆、编辑、重命名、导出 fangjun新增功能: 自定义组件权限:根据权限显示用户对组件可进行的操作<br>*/<br>CoolHTMLWidgetSubPanel.prototype.getShowMenu = function(type, isReadOnly, role,item) {</li>
</ul>
<pre><code>if (!this.wnd[&quot;XPopupMenu&quot;]) {
    include(&quot;xui/ctrls/xmenu.js&quot;);
}
if (!this.contextMenu) {
    this.contextMenu = {};
}
if (!this.contextMenu[type]) {
    var menuInfo = type === &quot;sysfolder&quot; ? [ {
        icon : &quot;&quot;,
        caption : I18N
                .getString(
                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.refreshsys&quot;,
                        &quot;更新内置组件&quot;),
        cmd : this.cmd_refreshSysHtml.bind(this)
    } ]
            : type === &quot;folder&quot; ? [
                    {
                        icon : &quot;&quot;,
                        caption : I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.newwt&quot;,
                                        &quot;新建HTML组件&quot;),
                        cmd : this.cmd_editHtmlWidget.bind(this)
                    },
                    {
                        icon : &quot;&quot;,
                        caption : I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.newdir&quot;,
                                        &quot;新建分组&quot;),
                        cmd : this.cmd_newFolder.bind(this)
                    },
                    {
                        icon : &quot;&quot;,
                        caption : I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.del&quot;,
                                        &quot;删除&quot;),
                        cmd : this.cmd_delFolder.bind(this)
                    },
                    {
                        icon : &quot;&quot;,
                        caption : I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.rename&quot;,
                                        &quot;重命名&quot;),
                        cmd : this.cmd_rename.bind(this)
                    },
                    {
                        icon : &quot;&quot;,
                        caption : I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.import&quot;,
                                        &quot;导入&quot;),
                        cmd : this.cmd_importHtmlWidget.bind(this),
                    },
                    {
                        icon : &quot;&quot;,
                        caption : I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.export&quot;,
                                        &quot;导出&quot;),
                        cmd : this.cmd_exportHtmlWidget.bind(this),
                    },
                    {
                        icon : &quot;&quot;,
                        caption : I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.reload&quot;,
                                        &quot;刷新&quot;),
                        cmd : this.cmd_reload.bind(this),
                    },
                    {
                        icon : &quot;&quot;,
                        caption : I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.movetodir&quot;,
                                        &quot;移动到&quot;),
                        cmd : this.cmd_moveTo.bind(this)
                    } ]
                    : type === &quot;mutliSelets&quot; ? [
                            {
                                icon : &quot;&quot;,
                                caption : I18N
                                        .getString(
                                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.del&quot;,
                                                &quot;删除&quot;),
                                cmd : this.cmd_deleteSeletes.bind(this)
                            },
                            {
                                icon : &quot;&quot;,
                                caption : I18N
                                        .getString(
                                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.export&quot;,
                                                &quot;导出&quot;),
                                cmd : this.cmd_exportHtmlWidget.bind(this)
                            },
                            {
                                icon : &quot;&quot;,
                                caption : I18N
                                        .getString(
                                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.movetodir&quot;,
                                                &quot;移动到&quot;),
                                cmd : this.cmd_moveTo.bind(this)
                            } ]
                            : type === &quot;sysgroup&quot; ? [ {
                                icon : &quot;&quot;,
                                caption : I18N
                                        .getString(
                                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.export&quot;,
                                                &quot;导出&quot;),
                                cmd : this.cmd_exportHtmlWidget.bind(this)
                            } ]
                                    : [
                                            {
                                                icon : &quot;&quot;,
                                                caption : &quot;&quot;,
                                                cmd : this.cmd_editHtmlWidget
                                                        .bind(this)
                                            },
                                            {
                                                icon : &quot;&quot;,
                                                caption : I18N
                                                        .getString(
                                                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.del&quot;,
                                                                &quot;删除&quot;),
                                                cmd : this.cmd_delHtmlWidget
                                                        .bind(this)
                                            },
                                            {
                                                icon : &quot;&quot;,
                                                caption : I18N
                                                        .getString(
                                                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.rename&quot;,
                                                                &quot;重命名&quot;),
                                                cmd : this.cmd_rename
                                                        .bind(this)
                                            },
                                            {
                                                icon : &quot;&quot;,
                                                caption : I18N
                                                        .getString(
                                                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.clone&quot;,
                                                                &quot;克隆&quot;),
                                                cmd : this.cmd_cloneHtmlWidget
                                                        .bind(this)
                                            },
                                            {
                                                icon : &quot;&quot;,
                                                caption : I18N
                                                        .getString(
                                                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.export&quot;,
                                                                &quot;导出&quot;),
                                                cmd : this.cmd_exportHtmlWidget
                                                        .bind(this)
                                            },
                                            {
                                                icon : &quot;&quot;,
                                                caption : I18N
                                                        .getString(
                                                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.movetodir&quot;,
                                                                &quot;移动到&quot;),
                                                cmd : this.cmd_moveTo
                                                        .bind(this)
                                            } ];
    var menu = new XPopupMenu(this.wnd);
    for ( var i = 0, len = menuInfo.length; i &lt; len; i++) {
        var iteobj = menuInfo[i];
        menu.addXMenuItem(iteobj[&quot;caption&quot;], iteobj[&quot;icon&quot;], iteobj[&quot;cmd&quot;]);
    }
    this.contextMenu[type] = menu;
}

var menu;
// 多选的右键菜单
menu = this.contextMenu[type];
if (type === &quot;folder&quot;) {
    //自定义组件根目录 只有刷新  系统文件夹没有走这
    if (isReadOnly) {
        menu.getXMenuItem(2).setVisible(false);
        menu.getXMenuItem(3).setVisible(false);
        menu.getXMenuItem(5).setVisible(false);
        menu.getXMenuItem(6).setVisible(true);
        menu.getXMenuItem(7).setVisible(false);
        menu.getXMenuItem(0).setVisible(false);
        menu.getXMenuItem(1).setVisible(false);
        menu.getXMenuItem(4).setVisible(false);
        //非系统文件夹
    } else {
        /*
         * menu.getXMenuItem(2).setVisible(true);
         * menu.getXMenuItem(3).setVisible(true);
         * menu.getXMenuItem(5).setVisible(true);
         * menu.getXMenuItem(6).setVisible(false);
         * menu.getXMenuItem(7).setVisible(true);
         */
        //分组文件夹
        if(role==null){
            menu.getXMenuItem(0).setVisible(true);
            menu.getXMenuItem(1).setVisible(true);
            menu.getXMenuItem(2).setVisible(true);
            menu.getXMenuItem(3).setVisible(false);
            menu.getXMenuItem(4).setVisible(true);
            menu.getXMenuItem(5).setVisible(true);
            menu.getXMenuItem(6).setVisible(false);
            menu.getXMenuItem(7).setVisible(false);
        }


        //主题集文件夹的角色
        if (role == &quot;owner&quot;) {
            //判断是一级目录(getLevel==2)还是二,三级目录(getLevel!=2)
            if(item.getLevel()==2){
                // 0.新建html组件，1.新建分组，2..删除、3重命名、4.导入5.导出 6.刷新 7 移动到
                menu.getXMenuItem(0).setVisible(true);
                menu.getXMenuItem(1).setVisible(true);
                menu.getXMenuItem(2).setVisible(false);
                menu.getXMenuItem(3).setVisible(false);
                menu.getXMenuItem(4).setVisible(true);
                menu.getXMenuItem(5).setVisible(true);
                menu.getXMenuItem(6).setVisible(false);
                menu.getXMenuItem(7).setVisible(false);
            }else{
                // 0.新建html组件，1.新建分组，2..删除、3重命名、4.导入5.导出 6.刷新 7 移动到
                menu.getXMenuItem(0).setVisible(true);
                menu.getXMenuItem(1).setVisible(true);
                menu.getXMenuItem(2).setVisible(true);
                menu.getXMenuItem(3).setVisible(false);
                menu.getXMenuItem(4).setVisible(true);
                menu.getXMenuItem(5).setVisible(true);
                menu.getXMenuItem(6).setVisible(false);
                menu.getXMenuItem(7).setVisible(true);
            }


        }
        if (role == &quot;manager&quot;) {
            //判断是一级目录(getLevel==2)还是二,三级目录(getLevel!=2)
            if(item.getLevel()==2){
                // 0.新建html组件，1.新建分组，2..删除、3重命名、4.导入5.导出 6.刷新 7 移动到
                menu.getXMenuItem(0).setVisible(true);
                menu.getXMenuItem(1).setVisible(true);
                menu.getXMenuItem(2).setVisible(false);
                menu.getXMenuItem(3).setVisible(false);
                menu.getXMenuItem(4).setVisible(true);
                menu.getXMenuItem(5).setVisible(true);
                menu.getXMenuItem(6).setVisible(false);
                menu.getXMenuItem(7).setVisible(false);
            }else{
                // 0.新建html组件，1.新建分组，2..删除、3重命名、4.导入5.导出 6.刷新 7 移动到
                menu.getXMenuItem(0).setVisible(true);
                menu.getXMenuItem(1).setVisible(true);
                menu.getXMenuItem(2).setVisible(true);
                menu.getXMenuItem(3).setVisible(false);
                menu.getXMenuItem(4).setVisible(true);
                menu.getXMenuItem(5).setVisible(true);
                menu.getXMenuItem(6).setVisible(false);
                menu.getXMenuItem(7).setVisible(true);
            }
        }
        if (role == &quot;reader&quot;) {
            menu.getXMenuItem(0).setVisible(false);
            menu.getXMenuItem(1).setVisible(false);
            menu.getXMenuItem(2).setVisible(true);
            menu.getXMenuItem(3).setVisible(false);
            menu.getXMenuItem(4).setVisible(false);
            menu.getXMenuItem(5).setVisible(true);
            menu.getXMenuItem(6).setVisible(false);
            menu.getXMenuItem(7).setVisible(false);

        }
        if (role == &quot;nopm&quot;||role==&quot;notFound&quot;) {
            menu.getXMenuItem(0).setVisible(false);
            menu.getXMenuItem(1).setVisible(false);
            menu.getXMenuItem(2).setVisible(false);
            menu.getXMenuItem(3).setVisible(false);
            menu.getXMenuItem(4).setVisible(false);
            menu.getXMenuItem(5).setVisible(true);
            menu.getXMenuItem(6).setVisible(false);
            menu.getXMenuItem(7).setVisible(false);
        }


    }
} else if (type === &quot;widgetfile&quot;) {

    if (isReadOnly) {
        menu
                .getXMenuItem(0)
                .setCaption(
                        I18N
                                .getString(
                                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.show&quot;,
                                        &quot;查看&quot;));
        menu.getXMenuItem(1).setVisible(false);
        menu.getXMenuItem(2).setVisible(false);
        menu.getXMenuItem(5).setVisible(false);
    } else {
        // 这里添加组件的权限判断 by fangjun
        //原来是 0.编辑 1.删除、2.重命名、3.克隆4.导出 5移动到
        //下面把 0,1 换啦
</code></pre><p>//            menu<br>//                    .getXMenuItem(0)<br>//                    .setCaption(<br>//                            I18N<br>//                                    .getString(<br>//                                            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.edit”,<br>//                                            “编辑”));</p>
<pre><code>        //自定义组件之外控件 没有我写的角色  以下是默认设置
        if(role==null){
            menu
            .getXMenuItem(0)
            .setCaption(
                    I18N
                            .getString(
                                    &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.show&quot;,
                                    &quot;查看&quot;));
            menu.getXMenuItem(0).setVisible(true);
            menu.getXMenuItem(1).setVisible(false);
            menu.getXMenuItem(2).setVisible(false);
            menu.getXMenuItem(3).setVisible(true);
            menu.getXMenuItem(4).setVisible(true);
            menu.getXMenuItem(5).setVisible(false);

        }

        /*
         * menu.getXMenuItem(1).setVisible(false);
         * menu.getXMenuItem(2).setVisible(true);
         * menu.getXMenuItem(5).setVisible(true);
         */
        if (role == &quot;owner&quot;) {
            menu
            .getXMenuItem(0)
            .setCaption(
                    I18N
                            .getString(
                                    &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.edit&quot;,
                                    &quot;编辑&quot;));
            // 0.查看/编辑 1.删除、2.重命名、3.克隆4.导出 5移动到
            menu.getXMenuItem(0).setVisible(true);
            menu.getXMenuItem(1).setVisible(true);
            menu.getXMenuItem(2).setVisible(true);
            menu.getXMenuItem(3).setVisible(true);
            menu.getXMenuItem(4).setVisible(true);
            menu.getXMenuItem(5).setVisible(true);

        }
        if (role == &quot;manager&quot;) {
            menu
            .getXMenuItem(0)
            .setCaption(
                    I18N
                            .getString(
                                    &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.edit&quot;,
                                    &quot;编辑&quot;));
            menu.getXMenuItem(0).setVisible(true);
            menu.getXMenuItem(1).setVisible(false);
            menu.getXMenuItem(2).setVisible(true);
            menu.getXMenuItem(3).setVisible(true);
            menu.getXMenuItem(4).setVisible(true);
            menu.getXMenuItem(5).setVisible(true);
        }
        if (role == &quot;reader&quot;) {
            menu
            .getXMenuItem(0)
            .setCaption(
                    I18N
                            .getString(
                                    &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.show&quot;,
                                    &quot;查看&quot;));
            menu.getXMenuItem(0).setVisible(true);
            menu.getXMenuItem(1).setVisible(false);
            menu.getXMenuItem(2).setVisible(false);
            menu.getXMenuItem(3).setVisible(true);
            menu.getXMenuItem(4).setVisible(true);
            menu.getXMenuItem(5).setVisible(false);


        }
        if (role == &quot;nopm&quot;||role == &quot;notFound&quot;) {
            menu
            .getXMenuItem(0)
            .setCaption(
                    I18N
                            .getString(
                                    &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.show&quot;,
                                    &quot;查看&quot;));
            menu.getXMenuItem(0).setVisible(true);
            menu.getXMenuItem(1).setVisible(false);
            menu.getXMenuItem(2).setVisible(false);
            menu.getXMenuItem(3).setVisible(true);
            menu.getXMenuItem(4).setVisible(true);
            menu.getXMenuItem(5).setVisible(false);

        }
    }
} else if (type === &quot;mutliSelets&quot;) {
    if (isReadOnly) {
        menu.getXMenuItem(0).setVisible(false);
        menu.getXMenuItem(2).setVisible(false);
    } else {
        menu.getXMenuItem(0).setVisible(true);
        menu.getXMenuItem(2).setVisible(true);
    }
}
return menu;
</code></pre><p>};</p>
<p>/**</p>
<ul>
<li>新建分组<br>*</li>
<li>@param item</li>
<li>XMenuItem<br>*/<br>CoolHTMLWidgetSubPanel.prototype.cmd_newFolder = function(item) {<br>var treeItem = item.getOwner()._ownerItem;<br>inputDialog(<br>I18N.getString(<pre><code>&quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.foldnm&quot;,
&quot;分组名：&quot;),
</code></pre>I18N.getString(<pre><code>&quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.newdir&quot;,
&quot;新建分组&quot;),
</code></pre>function(dlg) {<br>  var cap = dlg.getValue().trim();<br>  if (!cap) {<pre><code>dlg
        .setHintCaption(I18N
                .getString(
                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.needfoldnm&quot;,
                        &quot;请输入分组名称！&quot;));
dlg.setHintVisible(true);
</code></pre>  } else if (!this._checkFolderName(treeItem, cap)) {<pre><code>dlg
        .setHintCaption(I18N
                .getString(
                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.foldexist&quot;,
                        &quot;分组名已经存在！&quot;));
dlg.setHintVisible(true);
</code></pre>  } else if (!validateFileName(cap)) {<pre><code>dlg
        .setHintCaption(I18N
                .getString(
                        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.invalidchar&quot;,
                        &quot;输入名称中有非法字符,操作失败.\r\n输入名称只能由汉字、字母或下划线组成。&quot;));
dlg.setHintVisible(true);
</code></pre>  } else {<pre><code>dlg.setHintVisible(false);
this.doNewFolder(treeItem, cap, dlg);
</code></pre>  }<br>  return false;<br>}.bind(this));<br>};<br>/**</li>
<li>判断item的子节点中是否有和cap名称一样的<br>*</li>
<li>@param item</li>
<li>@param cap<br>*/<br>CoolHTMLWidgetSubPanel.prototype._checkFolderName = function(parentItem, cap) {<br> for ( var i = 0, cnt = parentItem.getChildrenCount(); i &lt; cnt; i++) {<pre><code>var item = parentItem.getChildItem(i);
if (item.id === cap) {
    return false;
}
</code></pre> }<br> return true;<br>};</li>
</ul>
<p>/*<em>
 </em></p>
<ul>
<li>@param item</li>
<li>XTreeItem,文件夹节点</li>
<li>@param cap</li>
<li>新名字</li>
<li>@param dlg</li>
<li>新建分组对话框，分组创建成功才关闭<br>*/<br>CoolHTMLWidgetSubPanel.prototype.doNewFolder = function(item, cap, dlg) {<br>var map = new Map();<br>map.put(“action”, “newfolder”);<br>map.put(“path”, this.getHtmlTreeItemPath(item));<br>map.put(“name”, cap);<br>QueryObj<br>.create(<pre><code>CoolHTMLWidgetSubPanel.ACTION_URL,
map,
function(q) {
    try {
        q.checkResult();
        var res = q.getResponseText();
        if (res === &quot;ok&quot;) {
            var beforeItem = this.getBeforeItem(item, cap,
                    true);
            this._addFolderItem(item, {
                cap : cap
            }, beforeItem);
            dlg.close();
        } else {
            showMessage(I18N
                    .getString(
                            &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.adddirwrong&quot;,
                            &quot;添加文件夹失败，请确认该节点在资源管理器中是否被删除！&quot;));
        }
    } catch (e) {
        showError(e);
    }
}.bind(this));
</code></pre>};</li>
</ul>
<p>CoolHTMLWidgetSubPanel.prototype.cmd_delFolder = function(item) {<br>    confirmDialog(null, I18N.getString(<br>            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.suredeldir”,<br>            “删除分组后，分组下所有组件和分组都会删除，是否继续？”), false, null, function() {<br>        this.doDelFolder(item);<br>    }.bind(this));<br>};<br>CoolHTMLWidgetSubPanel.prototype.doDelFolder = function(item) {<br>    var treeItem = item.getOwner()._ownerItem;<br>    var map = new Map();<br>    map.put(“action”, “delfolder”);<br>    map.put(“basepath”, this.getBasePath(treeItem));<br>    map.put(“path”, this.getHtmlTreeItemPath(treeItem));<br>    QueryObj<br>            .create(<br>                    CoolHTMLWidgetSubPanel.ACTION_URL,<br>                    map,<br>                    function(q) {<br>                        try {<br>                            q.checkResult();<br>                            // =ok:删除空文件夹；=CWidgetHtmlaaa,CWidgetHtmlbbb:删除的组件<br>                            var res = q.getResponseText();<br>                            if (!!res) {<br>                                treeItem.remove();<br>                                if (res !== “ok”) {<br>                                    // 删除缓存<br>                                    var dels = res.split(“,”);<br>                                    for ( var i = 0, len = dels.length; i &lt; len; i++) {<br>                                        g_dsn.updateHtmlWidgetDefineCache(<br>                                                dels[i], null);<br>                                    }<br>                                }<br>                                showWaitDialogAutoHidden(<br>                                        1000,<br>                                        I18N<br>                                                .getString(<br>                                                        “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.deldirok”,<br>                                                        “文件夹删除成功！”));<br>                            }<br>                        } catch (e) {<br>                            showError(e);<br>                        }<br>                    }.bind(this));<br>};</p>
<p>/**</p>
<ul>
<li>批量删除组件和分组<br>*/<br>CoolHTMLWidgetSubPanel.prototype.cmd_deleteSeletes = function() {<br> confirmDialog(null, I18N.getString(<pre><code>    &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.suredelseletes&quot;,
    &quot;确定删除选中的组件和分组吗，该操作同时会删除分组下的组件？&quot;), false, null, function() {
this.doDelSeletes();
</code></pre> }.bind(this));<br>};</li>
</ul>
<p>CoolHTMLWidgetSubPanel.prototype.doDelSeletes = function() {<br>    var items = this.xtree.getSelectedItems();<br>    var ids = this.getSeletesItemsId(items);<br>    var map = new Map();<br>    map.put(“action”, “delSeletes”);<br>    map.put(“basepath”, this.getBasePath(items[0]));<br>    map.put(“path”, ids);<br>    QueryObj<br>            .create(<br>                    CoolHTMLWidgetSubPanel.ACTION_URL,<br>                    map,<br>                    function(q) {<br>                        try {<br>                            q.checkResult();<br>                            // =ok:删除空文件夹；=CWidgetHtmlaaa,CWidgetHtmlbbb:删除的组件<br>                            var res = q.getResponseText();<br>                            if (!!res) {<br>                                for ( var i = items.length - 1; i &gt;= 0; i–) {<br>                                    if (!!items[i]) {<br>                                        items[i].remove();<br>                                    }<br>                                }<br>                                if (res !== “ok”) {<br>                                    // 删除缓存<br>                                    var dels = res.split(“,”);<br>                                    for ( var i = 0, len = dels.length; i &lt; len; i++) {<br>                                        g_dsn.updateHtmlWidgetDefineCache(<br>                                                dels[i], null);<br>                                    }<br>                                }<br>                                showWaitDialogAutoHidden(<br>                                        1000,<br>                                        I18N<br>                                                .getString(<br>                                                        “ebi.user.coolrptdsn.reporteditor.cooltabpanel.delselets”,<br>                                                        “所选组件和分组已经删除成功！”));<br>                            }<br>                        } catch (e) {<br>                            showError(e);<br>                        }<br>                    }.bind(this));<br>};</p>
<p>/**</p>
<ul>
<li>移动功能，支持组件，分组和批量<br>*/<br>CoolHTMLWidgetSubPanel.prototype.cmd_moveTo = function() {<br> var items = this.xtree.getSelectedItems();<br> var ids = this.getSeletesItemsId(items);<br> var inputTitle = I18N.getString(<pre><code>&quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.inputtitle&quot;,
&quot;分组名格式示例：/分组1/分组2&quot;);
</code></pre> inputDialog(<pre><code>I18N.getString(
        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.foldnm&quot;,
        &quot;分组名：&quot;),
I18N
        .getString(
                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.movetodir&quot;,
                &quot;移动到&quot;),
function(dlg) {
    var cap = dlg.getValue().trim();
    if (!cap) {
        dlg
                .setHintCaption(I18N
                        .getString(
                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.needfoldnm&quot;,
                                &quot;请输入分组名称！&quot;));
        dlg.setHintVisible(true);
    } else if (!validateFileName(cap.replace(/[\/]/g, &apos;a&apos;))) {
        dlg
                .setHintCaption(I18N
                        .getString(
                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.invalidcharnoforwardslash&quot;,
                                &quot;分组或者这分组路径中不能含有&lt; &gt; * ? : | ~ $ &amp; &apos; ! = , ; + % []等字符&quot;));
        dlg.setHintVisible(true);
    } else {
        dlg.setHintVisible(false);
        var basepath = this.getBasePath(items[0]);
        this.doMove(ids, cap, basepath, dlg);
    }
    return false;
}.bind(this), &quot;&quot;, &quot;&quot;, &quot;&quot;, {
    &quot;input_text&quot; : inputTitle
});
</code></pre></li>
</ul>
<p>};</p>
<p>/**</p>
<ul>
<li>移动到<br>*/<br>CoolHTMLWidgetSubPanel.prototype.doMove = function(ids, aimdir, basepath, dlg) {<br> var map = new Map();<br> map.put(“action”, “moveTo”);<br> map.put(“aimdir”, aimdir);<br> map.put(“basepath”, basepath);<br> map.put(“ids”, ids);<br> QueryObj<pre><code>.create(
        CoolHTMLWidgetSubPanel.ACTION_URL,
        map,
        function(q) {
            try {
                q.checkResult();
                // =ok:删除空文件夹；=CWidgetHtmlaaa,CWidgetHtmlbbb:删除的组件
                var res = q.getResponseText();
                if (res == &quot;ok&quot;) {
                    var usrItem = this.getUserRootItem();
                    this.xtree.setOnExpand(function() {
                        this._onExpandTreeItem(usrItem);
                    }.bind(this));
                    usrItem.setExpanded(false);
                    usrItem.clearChildren();
                    usrItem._shouldHasChildren = true;
                    usrItem._adjustExpandImg();
                    usrItem._loaded = false;
                    usrItem.setExpanded(true);
                    this.xtree.setOnExpand(null);
                } else {
                    showWaitDialogAutoHidden(
                            1000,
                            I18N
                                    .getString(
                                            &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.movefail&quot;,
                                            &quot;移动失败！&quot;));
                }
                dlg.close();
            } catch (e) {
                showError(e);
            }
        }.bind(this));
</code></pre>};</li>
</ul>
<p>/**</p>
<ul>
<li>获取左树选中的资源的id<br>*/<br>CoolHTMLWidgetSubPanel.prototype.getSeletesItemsId = function(items) {<br> var ids = “”;<br> for ( var i = 0, len = items.length; i &lt; len; i++) {<pre><code>ids += this.getHtmlTreeItemPath(items[i]) + &quot;,&quot;;
;
</code></pre> }<br> return ids;<br>};</li>
</ul>
<p>CoolHTMLWidgetSubPanel.prototype.cmd_rename = function(item) {<br>    var isFolder = false;<br>    var treeItem = item.getOwner()._ownerItem;<br>    if (treeItem.type === “folder”) {<br>        isFolder = true;<br>    }<br>    var title = isFolder ? I18N.getString(<br>            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.foldnm”, “分组名：”)<br>            : I18N.getString(<br>                    “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.wtname”,<br>                    “组件名：”);<br>    var hint = isFolder ? I18N.getString(<br>            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.needfoldnm”,<br>            “请输入分组名称！”) : I18N.getString(<br>            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.needwtnm”,<br>            “请输入组件名称！”);<br>    inputDialog(<br>            title,<br>            I18N.getString(<br>                    “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.rename”,<br>                    “重命名”),<br>            function(dlg) {<br>                var cap = dlg.getValue().trim();<br>                if (!cap) {<br>                    dlg.setHintCaption(hint);<br>                    dlg.setHintVisible(true);<br>                } else if (cap === treeItem.itemText) {<br>                    dlg.close();<br>                } else if (isFolder<br>                        &amp;&amp; !this<br>                                ._checkFolderName(treeItem.getParentItem(), cap)) {<br>                    dlg<br>                            .setHintCaption(I18N<br>                                    .getString(<br>                                            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.foldexist”,<br>                                            “分组名已经存在！”));<br>                    dlg.setHintVisible(true);<br>                } else if (!validateFileName(cap)) {<br>                    dlg<br>                            .setHintCaption(I18N<br>                                    .getString(<br>                                            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.invalidchar”,<br>                                            “输入名称中有非法字符,操作失败.\r\n输入名称只能由汉字、字母或下划线组成。”));<br>                    dlg.setHintVisible(true);<br>                } else {<br>                    dlg.setHintVisible(false);<br>                    this.doRename(treeItem, cap, dlg, isFolder);<br>                }<br>                return false;<br>            }.bind(this), treeItem.getItemText());</p>
<p>};</p>
<p>CoolHTMLWidgetSubPanel.prototype.doRename = function(treeItem, cap, dlg,<br>        isFolder) {<br>    var map = new Map();<br>    map.put(“action”, isFolder ? “renamefolder” : “renamewidget”);<br>    map.put(“path”, this.getHtmlTreeItemPath(treeItem));<br>    map.put(“name”, cap);<br>    QueryObj<br>            .create(<br>                    CoolHTMLWidgetSubPanel.ACTION_URL,<br>                    map,<br>                    function(q) {<br>                        try {<br>                            q.checkResult();<br>                            var res = q.getResponseText();<br>                            if (res === “ok”) {<br>                                treeItem.setItemText(cap);<br>                                if (isFolder) {<br>                                    treeItem.id = cap;<br>                                    showWaitDialogAutoHidden(<br>                                            1000,<br>                                            I18N<br>                                                    .getString(<br>                                                            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.dirrenameok”,<br>                                                            “文件夹重命名成功！”));<br>                                } else {<br>                                    // 更新拖拽参数、缓存中的caption以及已经拖入编辑区的组件的caption<br>                                    var dragDom = this<br>                                            ._getDragDomByItem(treeItem);<br>                                    dragDom.setAttribute(“dragparam”, JSON<br>                                            .stringify({<br>                                                object : treeItem.id,<br>                                                cap : cap<br>                                            }));<br>                                    var cache = g_dsn<br>                                            .getHtmlWidgetDefineCache();<br>                                    if (cache[treeItem.id]) {<br>                                        cache[treeItem.id].caption = cap;<br>                                        var captionattr = cache[treeItem.id].comattr[1];<br>                                        if (captionattr.name === “caption”) {<br>                                            captionattr.defattr = cap;<br>                                        }<br>                                    }<br>                                    var design = g_dsn.getDesign();<br>                                    var widgets = design.widgets;<br>                                    for ( var key in widgets) {<br>                                        var widget = widgets[key];<br>                                        if (widget[“referId”] == treeItem.id) {<br>                                            widget.caption = cap;<br>                                            widget.setCaption(cap,<br>                                                    !widget.option.caption);<br>                                        }<br>                                    }<br>                                    showWaitDialogAutoHidden(<br>                                            1000,<br>                                            I18N<br>                                                    .getString(<br>                                                            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.wtrenameok”,<br>                                                            “HTML组件重命名成功！”));<br>                                }<br>                                dlg.close();<br>                            } else {<br>                                showMessage(I18N<br>                                        .getString(<br>                                                “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.renamewrong”,<br>                                                “重命名失败，请确认该资源是否存在！”));<br>                            }<br>                        } catch (e) {<br>                            showError(e);<br>                        }<br>                    }.bind(this));<br>};</p>
<p>CoolHTMLWidgetSubPanel.prototype.cmd_cloneHtmlWidget = function(item) {<br>    var wtItem = item.getOwner()._ownerItem, basepath = this<br>            .getBasePath(wtItem);<br>    var map = new Map();<br>    map.put(“action”, “clonewidget”);<br>    map.put(“basepath”, basepath);<br>    map.put(“caption”, wtItem.getItemText());<br>    map.put(“path”, this.getHtmlTreeItemPath(wtItem));<br>    QueryObj.create(CoolHTMLWidgetSubPanel.ACTION_URL, map, function(q) {<br>        try {<br>            q.checkResult();<br>            var newInfo = q.getResponseJSON();<br>            var newId = newInfo.id, newCap = newInfo.cap;<br>            var pitem = null, beforeitem = null;<br>            if (this.isSysPath(basepath)) {<br>                pitem = this.getUserRootItem();<br>            } else {<br>                pitem = wtItem.getParentItem();<br>            }<br>            beforeitem = this.getBeforeItem(pitem, newCap, false);<br>            var childData = {<br>                cap : newCap,<br>                id : newId<br>            };<br>            this._addWidgetItem(pitem, childData, beforeitem);<br>            showWaitDialogAutoHidden(1500, I18N.getString(<br>                    “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.cloneok”,<br>                    “组件克隆成功！”));<br>        } catch (e) {<br>            showError(e);<br>        }<br>    }.bind(this));<br>};</p>
<p>CoolHTMLWidgetSubPanel.prototype.cmd_editHtmlWidget = function(menuitem) {<br>    var treeItem = menuitem.getOwner()._ownerItem;<br>    this.doEditHtmlWidget(treeItem);<br>};</p>
<p>CoolHTMLWidgetSubPanel.prototype.doEditHtmlWidget = function(treeItem) {<br>    var basepath = this.getBasePath(treeItem);<br>    // 借用保存对话框，但是保存和添加 的事件需要修改<br>    getObjectFromRootAsync(<br>            “HtmlWidgetDlg”,<br>            “<strong>HtmlWidgetDlg</strong>“,<br>            true,<br>            “xui/uibase.js;xui/xwindow.js;xui/ctrls/xdialog.js;ebi/user/coolrptdsn/dlg/htmlwidgetdlg.js”,<br>            function(dlg) {<br>                dlg.setOnSaveAs(this.saveHtmlWidget.bind(this));<br>                dlg.setOnSave(this.saveHtmlWidget.bind(this));<br>                dlg.show(treeItem, basepath);<br>            }.bind(this));<br>    return false;<br>};</p>
<p>CoolHTMLWidgetSubPanel.prototype.cmd_delHtmlWidget = function(item) {<br>    confirmDialog(null, I18N.getString(<br>            “ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.suredelwt”,<br>            “组件删除后，酷屏报表中使用此组件生成的内容会失效，确定删除组件吗？”), false, null, function() {<br>        this.doDelHtmlWidget(item);<br>    }.bind(this));<br>};<br>CoolHTMLWidgetSubPanel.prototype.doDelHtmlWidget = function(item) {<br>    var wtItem = item.getOwner()._ownerItem;<br>    var map = new Map();<br>    map.put(“action”, “deletewidget”);<br>    map.put(“basepath”, this.getBasePath(wtItem));<br>    map.put(“path”, this.getHtmlTreeItemPath(wtItem));<br>    map.put(“widgetId”, wtItem.id);<br>    QueryObj.create(CoolHTMLWidgetSubPanel.ACTION_URL, map, function(q) {<br>        try {<br>            q.checkResult();<br>            var res = q.getResponseText();<br>            wtItem.remove();<br>            if (res === “ok”) {<br>                g_dsn.updateHtmlWidgetDefineCache(wtItem.id, null);<br>            }<br>        } catch (e) {<br>            showError(e);<br>        }<br>    }.bind(this));<br>};<br>/**</p>
<ul>
<li><p>html组件导出<br><em>
</em>/<br>CoolHTMLWidgetSubPanel.prototype.cmd_exportHtmlWidget = function(item) {<br> var leftdom = item.getOwner()._ownerItem;<br> var items = this.xtree.getSelectedItems();<br> var ids = “”;<br> var ismutliselets = false;<br> if (items.length == 1 &amp;&amp; items[0].type !== “folder”) {</p>
<pre><code>ids = items[0].id + &quot;.json&quot;;
</code></pre><p> } else if (items.length == 1 &amp;&amp; items[0].type === “folder”) {</p>
<pre><code>ids = this.getHtmlTreeItemPath(items[0]);
</code></pre><p> } else {</p>
<pre><code>// for ( var i = 0; i &lt; items.length; i++) {
// ids += this.getHtmlTreeItemPath(items[i]) + &quot;,&quot;;
// }
ids = this.getSeletesItemsId(items);
ismutliselets = true;
</code></pre><p> }</p>
<p> var url = CoolHTMLWidgetSubPanel.ACTION_URL;<br> if (!this.downloadForm) {</p>
<pre><code>var htmlfact = new HtmlElementFactory(this.wnd);
this.downloadForm = htmlfact
        .form(
                getUniqueHtmlId(&quot;XFileDownloadPanel&quot;,
                        &quot;_Form4XFileDownloadPanel_&quot;),
                null,
                &quot;post&quot;,
                url,
                true,
                function(ifrm) {
                    var inner = ifrm.contentWindow.document.body.innerHTML;
                    if (inner.trim()) {
                        getObjectFromRootAsync(
                                &quot;ShowMessage&quot;,
                                &quot;__ESEN$ShowMessage__&quot;,
                                true,
                                &quot;xui/xwindow.js,xui/ctrls/xcommonctrls.js,xui/ctrls/xdialog.js&quot;,
                                function(dlg) {
                                    dlg.setHeight(180);
                                    dlg.setOnClose(function() {
                                        dlg.setHeight(150);
                                    });
                                    dlg.setParams(inner, &quot;&quot;, &quot;&quot;, &quot;&quot;);
                                    dlg.showModal();
                                });
                    }
                });
this.doc.body.appendChild(this.downloadForm);
this.downloadForm.appendChild(htmlfact.edit(&quot;&quot;, &quot;action&quot;)).value = &quot;exportwidget&quot;;
this.downloadForm.appendChild(htmlfact.edit(&quot;&quot;, &quot;items&quot;));
this.downloadForm.appendChild(htmlfact.edit(&quot;&quot;, &quot;basepath&quot;));
this.downloadForm.appendChild(htmlfact.edit(&quot;&quot;, &quot;ismutliselets&quot;));
this.downloadForm.style.display = &quot;none&quot;;
</code></pre><p> }<br> var childs = this.downloadForm.getElementsByTagName(“input”);<br> if (!childs || childs.length != 4)</p>
<pre><code>return;
</code></pre><p> childs[1].value = ids;<br> childs[2].value = this.getBasePath(leftdom);<br> childs[3].value = ismutliselets;</p>
<p> g_dsn.__notExcuteBeforeUnload = true;<br> this.downloadForm.submit();<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>结构树对象<br>*/<br>function CoolOutlinePanel(wnd, parentElement, width, height) {<br> this.search = this._initSearch(wnd, parentElement);<br> var treePnode = parentElement<pre><code>.appendChild(wnd.document.createElement(&quot;div&quot;));
</code></pre> treePnode.style.cssText += “;position:absolute;left:0px;top:30px;right:0px;bottom:0px;”;<br> this.tree = new XTree(wnd, treePnode, width, height);<br> this.conarr = [ “CHtmlWidget”, “CWidgetGrid” ];<br>}</li>
</ul>
<p>CoolOutlinePanel.prototype.dispose = function() {<br>    this.search = null;<br>    this.tree.dispose();<br>    this.tree = null;<br>};</p>
<p>/**</p>
<ul>
<li><p>绑定事件<br>*/<br>CoolOutlinePanel.prototype.bindEvent = function() {<br> this.tree.setOnSelecting(this._onSelecting.bind(this));<br> this.tree.setOnContextMenu(this._onContextMenu.bind(this));<br> var self = this;<br> this.tree.setOnClick(function(item) {</p>
<pre><code>if (item) {
    self.cleanHighClass();
    self._focusitem = item;
    // var editor = g_dsn.getDesign();
    // if(editor.pagefloat.isVisible()){
    // editor.cmd_showpagefloat();
    // }
}
</code></pre><p> });<br> /**</p>
<ul>
<li><p>展开时只加载直接子节点，属性initexpand记录当前节点item子节点是否已加载<br>*/<br>this.tree.setOnExpand(function(item) {<br> // if(!self.loaditem){<br> // self.refresh(item, false);<br> // item.userObj.initexpand = true;<br> // }<br> self.cleanHighClass();<br>});<br>this.tree.setOnCollapsed(function() {<br> self.cleanHighClass();<br>});</p>
<p>this.search.findButton.onclick = function() {<br> var editor = g_dsn.getDesign();<br> var value = self.search.findInput.value.trim();<br> var widget = $(editor.basedom).find(“#” + value)[0];<br> if (!!widget) {</p>
<pre><code>search(id);
</code></pre><p> } else {</p>
<pre><code>widget = editor.getWidget(value) || editor.getWidgetByName(value)
        || editor.getWidgetByName(value.toUpperCase());
search(!!widget ? widget.getId() : &quot;&quot;);
</code></pre><p> }</p>
<p> function search(id) {</p>
<pre><code>if (!id)
    return;
var item = self.tree.rootItem.getItemById(id) || self.bodyitem;
self.expandItem(item);
</code></pre><p> }<br>};</p>
<p>this.search.findInput.onkeydown = function(e) {<br> if (e.keyCode === 13) {</p>
<pre><code>self.search.findButton.onclick();
</code></pre><p> } else {</p>
<pre><code>return true;
</code></pre><p> }<br>};<br>eventListener.attachEvent(CoolReportPageEditor.EVENT_REPORT_LOAD</p>
<pre><code>+ &quot;.outline&quot;, this.loadAll.bind(this));
</code></pre><p>eventListener.attachEvent(CoolReportPageEditor.EVENT_WIDGETFOCUS</p>
<pre><code>+ &quot;.outline&quot;, this.selectWidget.bind(this));
</code></pre><p>eventListener.attachEvent(CoolReportPageEditor.EVENT_REMOVEWIDGET</p>
<pre><code>+ &quot;.outline&quot;, this.removeWidget.bind(this));
</code></pre><p>eventListener.attachEvent(</p>
<pre><code>CoolReportPageEditor.EVENT_ADDWIDGET + &quot;.outline&quot;, this.addWidget
        .bind(this));
</code></pre><p>eventListener.attachEvent(CoolReportPageEditor.EVENT_WIDGETUPDATE</p>
<pre><code>+ &quot;.outline&quot;, this.updateWidget.bind(this));
</code></pre><p>eventListener.attachEvent(CoolReportPageEditor.EVENT_REFRESH + “.outline”,</p>
<pre><code>this.refreshByDom.bind(this));
</code></pre><p>};</p>
</li>
</ul>
</li>
</ul>
<p>CoolOutlinePanel.prototype.unbindEvent = function() {<br>    eventListener.detachEvent(CoolReportPageEditor.EVENT_REPORT_LOAD</p>
<pre><code>        + &quot;.outline&quot;);
eventListener.detachEvent(CoolReportPageEditor.EVENT_WIDGETFOCUS
        + &quot;.outline&quot;);
eventListener.detachEvent(CoolReportPageEditor.EVENT_REMOVEWIDGET
        + &quot;.outline&quot;);
eventListener
        .detachEvent(CoolReportPageEditor.EVENT_ADDWIDGET + &quot;.outline&quot;);
eventListener.detachEvent(CoolReportPageEditor.EVENT_WIDGETUPDATE
        + &quot;.outline&quot;);
eventListener.detachEvent(CoolReportPageEditor.EVENT_REFRESH + &quot;.outline&quot;);
</code></pre><p>};</p>
<p>/**</p>
<ul>
<li>初始化结构树<br><em>
</em>/<br>CoolOutlinePanel.prototype.init = function() {<br> // 默认加载几个节点<br> this.tree<pre><code>.getRootItem()
.loadFromArray(
        [ {
            caption : I18N
                    .getString(
                            &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.editarea&quot;,
                            &quot;编辑区 &quot;),
            id : &quot;design&quot;,
            iscon : true,
            haschild : false
        } ], this.loadFinish.bind(this));
</code></pre> this.bodyitem = this.tree.rootItem.getItemById(“design”);<br> this.bodyitem.userObj = {<pre><code>pid : null,
id : &quot;design&quot;,
index : 0
</code></pre> };<br> this.bindEvent();</li>
</ul>
<p>};</p>
<p>CoolOutlinePanel.prototype._initSearch = function(wnd, parentElement) {<br>    var doc = wnd.document;<br>    var container = parentElement.appendChild(doc.createElement(“div”));<br>    container.style.cssText += “width:100%;height:30px;padding:4px 2px 4px 2px;”;<br>    container.innerHTML = “<div style="border:1px solid rgb(202, 209, 215);height:24px;">“</div></p>
<pre><code>        + &quot;&lt;input type=&apos;text&apos; id=&apos;xFindInput&apos; title=&apos;&quot;
        + I18N
                .getString(
                        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.72&quot;,
                        &quot;输入完整的组件代号定位到组件&quot;)
        + &quot;&apos;&gt;&quot;
        + &quot;&lt;a id=&apos;xFindButton&apos;&gt;&lt;span id=&apos;searchIcon&apos; style=&apos;width:10px;height:10px;&apos;&gt;&lt;/span&gt;&lt;/a&gt;&quot;
        + &quot;&lt;/div&gt;&quot;;
var findInput = doc.getElementById(&quot;xFindInput&quot;);
var findButton = doc.getElementById(&quot;xFindButton&quot;);
findInput.style.cssText += &quot;;width:100%;height:22px;border: none;font-size: 12px;padding: 1px 2px;background-color:#FFFFFF&quot;;
findButton.style.cssText += &quot;;background: transparent url(esmain/images/search.png) no-repeat center center;width: 18px;height: 18px;border: none;cursor:pointer;position: absolute;right: 6px;top:7px;&quot;;
return {
    findInput : findInput,
    findButton : findButton
};
</code></pre><p>};</p>
<p>/**</p>
<ul>
<li>装载完成<br>*</li>
<li>@param treeitem</li>
<li>@param info<br>*/<br>CoolOutlinePanel.prototype.loadFinish = function(treeitem, info) {<br> treeitem.id = info.id;<br> treeitem.iscon = info.iscon;// 是否是容器，可以包含子节点<br>};</li>
</ul>
<p>/**</p>
<ul>
<li><p>一开始只加载design节点的直接子节点<br>*/<br>CoolOutlinePanel.prototype.loadAll = function() {<br> var self = this;<br> setTimeout(function() {</p>
<pre><code>self._loadding = true;
self.loaditem = true;
var tree = self.tree;
// var item = tree.getFocusItem();
// if(item){
// tree.unSelectItem(item);
// }
if (tree) {
    var item = tree.rootItem.getItemById(&quot;design&quot;);
    item.clearChildren();
}
_init(item);
item.selectSelf(true);
delete self._loadding;
delete self.loaditem;
</code></pre><p> }, 500);</p>
<p> function _init(rootitem) {</p>
<pre><code>self.elems = 0;
self.refresh(rootitem, true);
var children = rootitem.childItems;
if (!children || children.length &lt; 1)
    return;
for ( var i = 0, len = children.length; i &lt; len; i++) {
    children[i].setExpanded(false);
}
</code></pre><p> }<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li><p>滚动到可视区<br>*/<br>CoolOutlinePanel.prototype._scrollWidgetIntoView = function(dom) {<br> if (!dom)</p>
<pre><code>return;
</code></pre><p> if (dom.id == “editor”)</p>
<pre><code>return;
</code></pre><p> var editor = g_dsn.getDesign(), pdom = editor.basedom.parentNode;<br> var pwidth = pdom.clientWidth, pheight = pdom.clientHeight;<br> if (pwidth == pdom.scrollWidth &amp;&amp; pheight == pdom.scrollHeight)</p>
<pre><code>return;
</code></pre><p> while (dom.parentNode.id != “editor”) {</p>
<pre><code>dom = dom.parentNode;
</code></pre><p> }</p>
<p> var dompos = getBoundingClientRect(dom), pdompos = getBoundingClientRect(pdom);<br> var left = dompos.left, right = dompos.right, width = right - left;<br> var top = dompos.top, bottom = dompos.bottom, height = bottom - top;<br> var pleft = pdompos.left, pright = pdompos.right, ptop = pdompos.top, pbottom = pdompos.bottom;<br> var offset = $(pdom).offset();<br> if (left &gt; pleft &amp;&amp; right &gt; pright) {// 组件在右边</p>
<pre><code>if (width &lt; pwidth) {
    pdom.scrollLeft += (right - pright);
} else {// 组件宽度大于显示区域
    pdom.scrollLeft += (left - pleft);
}
</code></pre><p> } else if (left &lt; pleft) {</p>
<pre><code>pdom.scrollLeft += (left - pleft);
</code></pre><p> }</p>
<p> if (top &gt; ptop &amp;&amp; bottom &gt; pbottom) {// 组件在下边</p>
<pre><code>if (height &lt; pheight) {
    pdom.scrollTop += (bottom - pbottom);
} else {// 组件高度大于显示区域
    pdom.scrollTop += (top - ptop);
}
</code></pre><p> } else if (top &lt; ptop) {</p>
<pre><code>pdom.scrollTop += (top - ptop);
</code></pre><p> }<br>};<br>/**</p>
</li>
<li>把dom滚动到pdom的可视区<br>*</li>
<li>@param dom</li>
<li>@param pdom</li>
<li>@param offpos<br>*/<br>CoolOutlinePanel.prototype._scrollIntoView = function(dom, pdom, offpos) {<br> // 在可视区不用滚动<br> var dompos = getBoundingClientRect(dom), pdompos = getBoundingClientRect(pdom), offtop = dom.offsetTop, offleft = dom.offsetLeft;<br> // 垂直滚动<br> if (pdom.scrollHeight &gt; pdom.clientHeight) {<pre><code>if (!(dompos.height &lt;= pdompos.height &amp;&amp; dompos.top &gt;= pdompos.top &amp;&amp; dompos.bottom &lt;= pdompos.bottom)) {
    pdom.scrollTop = offtop + offpos.top;
    offpos.top = offtop - pdom.scrollTop;
}
</code></pre> } else {<pre><code>offpos.top += dom.offsetTop;
</code></pre> }<br> // 水平滚动<br> if (pdom.scrollWidth &gt; pdom.clientWidth) {<pre><code>if (!(dompos.width &lt;= pdompos.width &amp;&amp; dompos.left &gt;= pdompos.left &amp;&amp; dompos.right &lt;= pdompos.right)) {
    pdom.scrollLeft = offleft + offpos.left;
    offpos.left = offleft - pdom.scrollLeft;
}
</code></pre> } else {<pre><code>offpos.left += offleft;
</code></pre> }<br>};</li>
</ul>
<p>CoolOutlinePanel.prototype.cleanHighClass = function() {<br>    var bodyitem = this.bodyitem, editor = g_dsn.getDesign();<br>    if (bodyitem.ishight) {<br>        removeClassName(editor.basedom, “highlight_top”);<br>        delete bodyitem.ishight;<br>    }<br>};</p>
<p>/**</p>
<ul>
<li>组件发生变化<br>*/<br>CoolOutlinePanel.prototype.updateWidget = function(wid) {<br> if (this._loadding || !wid)<pre><code>return;
</code></pre> var editor = g_dsn.getDesign(), widget = editor.getWidget(wid);<br> var item = this.tree.rootItem.getItemById(wid);<br> if (item) {<pre><code>item.setItemText(this.getItemText(widget));
</code></pre> }<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>编辑区添加了组件，树上同步添加<br>*</li>
<li>@param pid</li>
<li>父组件id或父dom</li>
<li>@param wid</li>
<li><p>添加组件id或添加html元素的dom<br>*/<br>CoolOutlinePanel.prototype.addWidget = function(pid, wid) {<br>var self = this;<br>if (this._loadding)<br>return;<br>var item = this.tree.rootItem.getItemById(pid), self = this;<br>item = _getItem(pid, wid, item);<br>if (!item)<br>return;<br>setTimeout(function() {<br>self.loaditem = true;<br>self.refresh(item, true, wid);<br>item.selectSelf(true);<br>delete self.loaditem;<br>}, 50);</p>
<p>function _getItem(pidOrdom, wid, item) {<br>if (pidOrdom instanceof HTMLElement) {<br>return self.getItemByHtmlElementDom(pidOrdom.id, pidOrdom);<br>} else if (self.isMultDroppableHtmlWidgetId(pidOrdom)) {<br>if ((wid instanceof HTMLElement) &amp;&amp; $(wid).attr(“istabpage”)) {<br>  return item;<br>}<br>var editor = g_dsn.getDesign(), tab = editor.getWidget(pidOrdom);<br>var index = self.getActiveIndexOfWidget(tab, wid);<br>var pitem = self.tree.rootItem.getItemById(pidOrdom), childitems = pitem.childItems;<br>for ( var i = 0; i &lt; childitems.length; i++) {<br>  if (i == index)</p>
<pre><code>return childitems[i];
</code></pre><p>}<br>} else {<br>return item;<br>}<br>}<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>展开当前节点及上级节点<br>*/<br>CoolOutlinePanel.prototype.expandItem = function(item) {<br> if (!item)<pre><code>return;
</code></pre> var parent = item.getParentItem();<br> while (parent &amp;&amp; parent != this.tree.rootItem) {<pre><code>if (!parent.isExpanded()) {
    parent.setExpanded(true);
}
parent = parent.getParentItem();
</code></pre> }<br> this.tree.selectItemSingleMode(item, false);<br> this._focusitem = item;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>编辑区选中了组件，然后高亮树 1. 编辑区选中dom，dom已经焦点了，现在只需处理item选中，触发此方法 2. 根据dom找到对应item 3.</li>
<li>设置item展开 4. 设置item选中：this.tree.selectItemSingleMode(item, false);</li>
<li>this.tree.selectItemSingleMode(item, false):传false是为了不触发_onSelecting<br>*</li>
<li>@param id</li>
<li>@param dom</li>
<li>选中的dom<br>*/<br>CoolOutlinePanel.prototype.selectWidget = function(id, dom) {<br>if (this._selectitem || id === “multwidget”)<br>return;<br>var self = this;<br>if (self.focustime) {<br>clearTimeout(self.focustime);<br>self.focustime = 0;<br>}<br>if (this._treeitemfocus)<br>return;<br>this.cleanHighClass();<br>self.focustime = setTimeout(function() {<br>if (isArray(id) &amp;&amp; id.length &gt;= 1)<br>id = id[0];<br>if (!id)<br>return;<br>showFocus(id, dom);<br>}, 50);<br>function showFocus(id, dom) {<br>self._widgetocus = true;<br>var item = self.getItemByHtmlElementDom(id, dom) || self.bodyitem;<br>self.expandItem(item);<br>delete self._widgetocus;<br>}<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>选中了树，高亮编辑区的组件 1. 根据item找到对应dom 2. 展开节点item 3. 将dom显示在可视区 4. 设置dom焦点</li>
<li>设置dom焦点setFocus会触发selectWidget方法，所以通过this._selectitem属性控制不执行selectWidget方法<br>*</li>
<li>@param item</li>
<li>@param e</li>
<li>@param tree<br>*/<br>CoolOutlinePanel.prototype._onSelecting = function(item, e, tree) {<br> this._selectitem = true;<br> var id = item.id;<br> if (!id)<pre><code>return;
</code></pre> var pid = item.userObj.pid, wid = id;<br> if (this.isMultDroppableHtmlWidgetId(pid))<pre><code>wid = pid;
</code></pre> var editor = g_dsn.getDesign(), dom = editor.basedom;<br> if (id.startsWith(“elem_”)) {<pre><code>dom = this.getHtmlElementParentNode(item);
</code></pre> } else {<pre><code>dom = $(dom).find(&quot;#&quot; + wid)[0];
</code></pre> }<br> this.showHtmlElementInWidget(item, dom);<br> this._scrollWidgetIntoView(dom);<br> /**<ul>
<li>ESENBI-11637 结构树中点击灰色tab页下容器可以拖动，拖出后无法还原 add by xiaoshan 2018.6.14</li>
<li>容器组件的容器让其不让选中让其拖动<br>*/<br>if (item.userObj.istabpage) {<br> var pwidget = editor.getWidget(item.userObj.pid);<br> dom = pwidget.getBaseDom();<br> id = pid;<br>}<br>if (id.startsWith(“elem_”))<br> id = “elem”;<br>editor.setFocus(true, id, dom, false);<br>delete this._selectitem;<br>};</li>
</ul>
</li>
</ul>
<p>/**</p>
<ul>
<li>展开节点 当节点没有展开，处理item展开<br>*</li>
<li>@param item</li>
<li>@param dom</li>
<li>item对应的dom<br>*/<br>CoolOutlinePanel.prototype.showHtmlElementInWidget = function(item, dom) {<br>if (!item)<br>return;<br>if (item.id == “design”)<br>return;<br>var id = item.id;<br>var parent = item, editor = g_dsn.getDesign();<br>while (id != “design”) {<br>if (this.isMultDroppableHtmlWidgetId(parent.userObj.pid)) {<br>var widget = editor.getWidget(parent.userObj.pid);<br>var curindex = widget.getActiveIndex();<br>var index = this.getActiveIndexOfWidget(widget, dom);<br>if (curindex != index) {<br>  widget.setActiveIndex(index);<br>}<br>}<br>parent = parent.getParentItem();<br>id = parent.id;<br>}<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>编辑区删除组件，树上同步删除<br>*</li>
<li>@param delitem</li>
<li>待删除的item或”elem”</li>
<li>@param indexOrdom</li>
<li>待删除dom</li>
<li>@param isreposition</li>
<li>是否是拖动组件，即组件父组件改变了，需要先删除原父组件中的组件，再在新父组件创建<br>*/<br>CoolOutlinePanel.prototype.removeWidget = function(delitem, indexOrdom,<br>isreposition) {<br>var item = this._focusitem;<br>if (indexOrdom instanceof HTMLElement)<br>item = this.getItemByHtmlElementDom(indexOrdom.id, indexOrdom);<br>if (item) {<br>var parent = item.getParentItem();<br>this.updateItemAfterRemove(parent, item);<br>item.remove(1);<br>this._checkIcon(parent, item);<br>eventListener.fireEvent(CoolDesignEditor.EVENT_FOCUS, [ “design” ]);<br>eventListener.fireEvent(CoolReportPageEditor.EVENT_WIDGETFOCUS,<br>  [ “design” ]);<br>}<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>树上删除节点 根据删除节点，找到节点对应的dom，再删除dom<br>*</li>
<li>@param treeitem</li>
<li>@param isdelfromtree</li>
<li>true表示通过从结构树上删除，false表示通过组件上点击dom删除</li>
<li>@param deldom</li>
<li>待删除dom<br>*/<br>CoolOutlinePanel.prototype.deleteWidget = function(treeitem, isdelfromtree,<br>deldom) {<br>if (!treeitem)<br>return;<br>var editor = g_dsn.getDesign();<br>editor.cmd_delWidget();<br>};<br>CoolOutlinePanel.prototype.isWidget = function(id) {<br>var widget = g_dsn.getWidgetById(id);<br>return widget ? true : false;<br>};<br>/**</li>
<li>结构树item删除后更新其他item索引<br>*</li>
<li>@param pitem</li>
<li>删除节点的父item</li>
<li>@param item</li>
<li><p>待删除的item<br>*/<br>CoolOutlinePanel.prototype.updateItemAfterRemove = function(pitem, item) {<br>// 组件的索引始终是0，不需要更新<br>if (!pitem || this.isWidget(item.id))<br>return;<br>var self = this;<br>if (pitem.id == “design” || this.isMultDroppableHtmlWidgetId(pitem.id)) {<br>var items = pitem.childItems, index = item.userObj.index;<br><em>updateIndex(items, index);<br>} else if (item.id.startsWith(“elem</em>“)) {<br>_updateItem(pitem, item);<br>}</p>
<p>function _updateIndex(items, index) {<br>for ( var i = index + 1; i &lt; items.length; i++) {<br>var child = items[i];<br>if (child &amp;&amp; !self.isCHtmlWidget(child.id)) {<br>  child.userObj.index -= 1;<br>}<br>}<br>}</p>
<p>function _updateItem(pitem, item) {<br>var count = pitem.getChildrenCount(), index = item.userObj.index;<br>for ( var i = 0; i &lt; count; i++) {<br>var child = pitem.getChildItem(i), userobj = child.userObj;<br>if (userobj.iselem &amp;&amp; userobj.index &gt; index) {<br>  userobj.index -= 1;<br>}<br>}<br>}<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>根据id或dom获取结构树item<br>*</li>
<li>@param id</li>
<li>item.id或elem</li>
<li>@param index</li>
<li>当前id为elem，index为item对应的dom，当前id为多个标签页组件id，index表示当前item的索引<br>*/<br>CoolOutlinePanel.prototype.getItemById = function(id, index) {<br>var item;<br>if (id == “elem” &amp;&amp; index instanceof HTMLElement) {<br>item = this.getItemByHtmlElementDom(id, index);<br>} else {<br>item = this.tree.rootItem.getItemById(id);<br>}<br>if (this.isMultDroppableHtmlWidgetId(id)) {<br>return item.getChildItem(index);<br>}<br>return item;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>检查图标，<br>*</li>
<li>@param rootitem</li>
<li>@param isRecursion<br>*/<br>CoolOutlinePanel.prototype.doCheckIcon = function(rootitem, isRecursion) {<br> rootitem = rootitem || this.tree.rootItem;<br> var child = rootitem.childItems;<br> if (!child)<pre><code>return;
</code></pre> for ( var i = 0, len = child.length; i &lt; len; i++) {<pre><code>var item = child[i];
if (this._checkIcon(item) &amp;&amp; isRecursion === true) {
    this.doCheckIcon(item, isRecursion);
}
</code></pre> }<br>};</li>
</ul>
<p>CoolOutlinePanel.prototype.createNewElementId = function() {<br>    if (!this.elems)<br>        this.elems = 0;<br>    this.elems++;<br>    return id = “elem_” + this.elems;<br>};</p>
<p>/**</p>
<ul>
<li>检查是否有展开图标 1.添加组件时需要检查图标，delitem为null 2.删除组件时，delitem为待删除item<br>*</li>
<li>@param item</li>
<li>父item</li>
<li>@param delitem</li>
<li>待删除的item</li>
<li>@returns<br>*/<br>CoolOutlinePanel.prototype._checkIcon = function(item, delitem) {<br> if (!item.iscon)<pre><code>return;
</code></pre> var hasicon = false;<br> if (delitem instanceof XTreeItem) {<pre><code>for ( var i = 0, count = item.getChildrenCount(); i &lt; count; i++) {
    if (item.getChildItem(i) == delitem)
        continue;
    hasicon = true;
}
</code></pre> } else {<pre><code>hasicon = this.hasChildren(item.id);
</code></pre> }<br> item.setHasChildren(hasicon);<br> return hasicon;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>判断cwidget是否需要过滤<br>*/<br>CoolOutlinePanel.prototype.isFilterCWidget = function(id, iscwidget) {<br> if (!id)<pre><code>return false;
</code></pre> if (iscwidget &amp;&amp; this.isCWidgetId(id))<pre><code>return true;
</code></pre> return false;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>是否过滤用于显示组件焦点的element<br>*/<br>CoolOutlinePanel.prototype.isFilterWidgetFocusElement = function(classname) {<br> if (!classname)<pre><code>return false;
</code></pre> if (classname.trim().startsWith(“widget_focus”))<pre><code>return true;
</code></pre> return false;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>当前设计区dom被选中，会有选中状态，是通过添加html元素实现的 添加的html元素classname是以widget_focus开头的<br>*/<br>CoolOutlinePanel.prototype.isFocusHtmlElement = function(dom) {<br> if (!(dom instanceof HTMLElement))<pre><code>return false;
</code></pre> return this.isFilterWidgetFocusElement(dom.className);<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>当拖入一个田字布局，dom的classname为”defelement widget_Multfocus”</li>
<li>拖入完成后widget_Multfocus就成多余的了，需要去掉widget_Multfocus<br>*/<br>CoolOutlinePanel.prototype.getEffectiveClassName = function(classname) {<br> classname = classname.replace(“widget_Multfocus”, “”);<br> return classname.trim();<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>过滤选中时的用于焦点的html元素,返回pnode的子节点数组<br>*/<br>CoolOutlinePanel.prototype.getEffectiveChildNodes = function(pnode) {<br> var childs = pnode.children, len = childs.length;<br> var nodes = [];<br> for ( var i = 0; i &lt; len; i++) {<pre><code>var child = childs[i];
if (this.isFocusHtmlElement(child) || this.isCWidgetId(child.id))
    continue;
nodes.push(child);
</code></pre> }<br> return nodes;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>获取目标dom在父dom中的索引<br>*</li>
<li>@param childs</li>
<li>父dom的子节点数组</li>
<li>@param target</li>
<li>目标dom<br>*/<br>CoolOutlinePanel.prototype.getHtmlElementIndex = function(childs, target) {<br>var index = 0;<br>if (childs &amp;&amp; childs.length &gt; 0) {<br>for ( var i = 0, len = childs.length; i &lt; len; i++) {<br>if (childs[i] === target)<br>  return i;<br>// if(!this.isCWidgetId(childs[i].id)) {<br>// index ++;<br>// }<br>}<br>}<br>return 0;<br>};</li>
</ul>
<p>CoolOutlinePanel.prototype.hasChildElement = function(dom) {<br>    if (!dom)<br>        return false;<br>    var childs = Array.isArray(dom) ? dom : dom.children, len = childs.length;<br>    for ( var i = 0; i &lt; len; i++) {<br>        if (this.isFocusHtmlElement(childs[i]))<br>            continue;<br>        return true;<br>    }<br>    return false;<br>};</p>
<p>/**</p>
<ul>
<li>判断id对应的item是否有子节点<br>*</li>
<li>@param id</li>
<li>item节点的id</li>
<li>@param eledom</li>
<li>当id以elem_开头，即是元素节点，elemdom表示元素节点的dom，可为空<br>*/<br>CoolOutlinePanel.prototype.hasChildren = function(id, elemdom) {<br>if (!id)<br>return false;<br>var editor = g_dsn.getDesign(), widget = editor.getWidget(id);<br>if (id == “design”) {<br>return this.hasChildElement(editor.basedom);<br>} else if (id.startsWith(“elem_”)) {<br>if (!elemdom) {<br>var item = this.tree.rootItem.getItemById(id);<br>elemdom = this.getHtmlElementParentNode(item);<br>}<br>return this.hasChildElement(elemdom);<br>}<br>if (widget) {<br>if (widget.ishtmlwidget) {<br>if (!widget.$droppabledom)<br>  return false;<br>for ( var i = 0; i &lt; widget.$droppabledom.length; i++) {<br>  if (this.hasChildElement(widget.$droppabledom[i]))<pre><code>return true;
</code></pre>}<br>return false;<br>} else {<br>return !$.isEmptyObject(widget.childnodes);<br>}<br>}<br>var dom = $(editor.basedom).find(“#” + id)[0];<br>return !!dom &amp;&amp; dom.children.length &gt; 0;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>根据id判断对应是否为cwidget组件<br>*/<br>CoolOutlinePanel.prototype.isCWidgetId = function(id) {<br> if (!id)<pre><code>return false;
</code></pre> var editor = g_dsn.getDesign(), widget = editor.getWidget(id);<br> if (widget instanceof CWidget)<pre><code>return true;
</code></pre> return false;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>根据id判断对应是否为chtmlwidget组件<br>*/<br>CoolOutlinePanel.prototype.isCHtmlWidget = function(id) {<br> if (!id)<pre><code>return false;
</code></pre> var editor = g_dsn.getDesign(), widget = editor.getWidget(id);<br> if (widget &amp;&amp; widget.ishtmlwidget)<pre><code>return true;
</code></pre> return false;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>判断是否是容器元素 如单容器，田字布局<br>*/<br>CoolOutlinePanel.prototype.isContainerElement = function(dom) {<br> return $(dom).hasClass(“defelement”)<pre><code>&amp;&amp; dom.getAttribute(&quot;droppable&quot;) == &quot;true&quot;;
</code></pre>};</li>
</ul>
<p>CoolOutlinePanel.EDITOR = “editor”;</p>
<p>CoolOutlinePanel.DESIGN = “design”;</p>
<p>/**</p>
<ul>
<li>根据id判断<br>*/<br>CoolOutlinePanel.prototype.isHtmlElementId = function(domid) {<br> if (!domid)<pre><code>return true;
</code></pre> if (domid == CoolOutlinePanel.EDITOR || domid == “editor”)<pre><code>return false;
</code></pre> var editor = g_dsn.getDesign(), widget = editor.getWidget(domid);<br> if (widget &amp;&amp; !domid.startsWith(“elem”))<pre><code>return false;
</code></pre> return true;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>根据点击的dom查找对应的item<br>*</li>
<li>@param id</li>
<li>点击dom的id或wid</li>
<li>@param dom</li>
<li>点击的dom<br>*/<br>CoolOutlinePanel.prototype.getItemByHtmlElementDom = function(id, dom) {<br>if (id == CoolOutlinePanel.DESIGN || id == “multwidget”)<br>return;<br>if (dom &amp;&amp; dom.id == “editor”)<br>return this.tree.rootItem.getItemById(CoolOutlinePanel.DESIGN);<br>if (dom &amp;&amp; this.isCWidgetId(dom.id)) {<br>var editor = g_dsn.getDesign(), widget = editor.getWidget(id);<br>if (widget.basedom == dom) {<br>return this.tree.rootItem.getItemById(id);<br>}<br>}<br>var self = this, id = id ? id : dom.id, parent = dom;<br>while (this.isHtmlElementId(id)) {<br>parent = parent.parentElement;<br>id = parent.id;<br>}<br>function _isHtmlElementDom(id) {<br>if (id == CoolOutlinePanel.EDITOR)<br>return false;<br>if (id == “”) {<br>return true;<br>} else if (self.isCHtmlWidget(id)) {<br>return false;<br>} else if (self.isContainerElement(dom)) {<br>return true;<br>}<br>return false;<br>}<br>if (id == CoolOutlinePanel.EDITOR)<br>id = CoolOutlinePanel.DESIGN;<br>var item = this.tree.rootItem.getItemById(id), count = item<br>.getChildrenCount();<br>return this.getItemByItem(item, count, dom, parent);<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>通过已知item找到dom对应的item<br>*</li>
<li>@param item</li>
<li>当前item 是dom对应item的上级节点</li>
<li>@param count</li>
<li>当前item的子节点个数</li>
<li>@param dom</li>
<li>选中的dom</li>
<li>@param parent</li>
<li>当前item对应的dom<br>*/<br>CoolOutlinePanel.prototype.getItemByItem = function(item, count, dom, parent) {<br>var target = null;<br>for ( var i = 0; i &lt; count; i++) {<br>var child = item.getChildItem(i);<br>var cdom = this.getHtmlElementDomByItem(child, parent);<br>if (cdom == dom) {<br>target = child;<br>break;<br>}<br>target = this.getItemByItem(child, child.getChildrenCount(), dom, cdom);<br>if (target)<br>return target;<br>}<br>return target;<br>};</li>
</ul>
<p>CoolOutlinePanel.prototype.getHtmlElementDomByItemId = function(itemid, basedom) {<br>    var item = this.tree.rootItem.getItemById(itemid);<br>    return this.getHtmlElementDomByItem(item, basedom);<br>};</p>
<p>/**</p>
<ul>
<li>根据结构树上item获取对应组件的basedom obj = item.userObj</li>
<li>1.obj.id存在，根据id直接获取dom，如果是html容器组件，需要找到 2.obj.classname存在，获取</li>
<li>3.obj.id和obj.classname都不存在，直接获取basedom.children，通过索引index获取<br>*</li>
<li>@param item</li>
<li>item对象</li>
<li>@param basedom</li>
<li>item对应dom的父节点<br>*/<br>CoolOutlinePanel.prototype.getHtmlElementDomByItem = function(item, basedom) {<br>var editor = g_dsn.getDesign(), userObj = item.userObj;<br>if (item.id == “design”)<br>return editor.basedom;<br>var id = userObj.id, classname = userObj.classname, index = userObj.index;<br>if (id) {<br>basedom = $(basedom).find(“#” + id)[0];<br>// var widget = editor.getWidget(id);<br>// basedom = this.getCHtmlWidgetDroppableDom(widget, basedom, index);<br>} else if (classname) {<br>basedom = this.getCHtmlWidgetDroppableDom(classname, basedom, index);<br>} else {<br>basedom = basedom.children[index];<br>}<br>return basedom;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>根据索引获取容器类html组件的子组件的dom<br>*</li>
<li>@param classname</li>
<li>子组件dom的classname</li>
<li>@param basedom</li>
<li>子组件的直接父dom</li>
<li>@param index</li>
<li>子组件在直接父dom中索引<br><em>/<br>CoolOutlinePanel.prototype.getCHtmlWidgetDroppableDom = function(classname,<br>basedom, index) {<br>var htmlwidget = g_dsn.getDesign().getWidget(basedom.id);<br>if (htmlwidget &amp;&amp; htmlwidget.ishtmlwidget) {<br>basedom = this._getCWidgetDroppableDom(htmlwidget);<br>// if(this.isMultDroppableHtmlWidget(htmlwidget)){// ESENBI-10958<br>// this.setActiveIndexForWidget(htmlwidget, index);<br>// }<br>// for(var i = 0; i &lt; basedom.length; i++){<br>// if(i == index) return basedom[i];<br>// }<br>return basedom[index];<br>} else {<br>var cnodes = this.getEffectiveChildNodes(basedom)/</em><pre><code>* , count =
* childdom.length
*/;
</code></pre>var realidx = 0;// 比较的时候要除掉组件的dom<br>for ( var i = 0, len = cnodes.length; i &lt; len; i++) {<br>var cnode = cnodes[i];<br>if ($(cnode).hasClass(classname) &amp;&amp; index === realidx) {<br>  return cnode;<br>}<br>realidx++;<br>}<br>}<br>return basedom;<br>};</li>
</ul>
<p>/*<em>
 </em></p>
<ul>
<li>@param widget</li>
<li>容器类html组件对象或父dom<br>*/<br>CoolOutlinePanel.prototype._getCWidgetDroppableDom = function(widgetOrdom,<br>iscwidget) {<br>var iswidget = widgetOrdom instanceof CHtmlWidget;<br>var dom = iswidget ? widgetOrdom.$droppabledom : widgetOrdom.children, arr = [];<br>if (!dom)<br>return arr;<br>for ( var i = 0; i &lt; dom.length; i++) {<br>var cdom = dom[i], id = cdom.id, classname = cdom.className.trim();<br>if (this.isFilterCWidget(id, iscwidget)<br>  || this.isFilterWidgetFocusElement(classname))<br>continue;<br>arr.push(dom[i]);<br>}<br>if (iswidget &amp;&amp; !this.isMultDroppableHtmlWidget(widgetOrdom)) {<br>return this._getCWidgetDroppableDom(arr[0], false);<br>}<br>return arr;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>根据item（item.id以elem_开头）查找对应dom的父节点<br>*/<br>CoolOutlinePanel.prototype.getHtmlElementParentNode = function(item) {<br> var editor = g_dsn.getDesign(), basedom = editor.basedom;<br> if (!item)<pre><code>return basedom;
</code></pre> var id = item.id, parentItem = item.getParentItem();<br> var obj = {<pre><code>tid : id
</code></pre> };<br> while (parentItem.id != “design”) {<pre><code>obj = {
    obj : obj
};
id = parentItem.id;
obj.tid = id;
if (!id.startsWith(&quot;elem_&quot;))
    break;
parentItem = parentItem.getParentItem();
</code></pre> }<br> if (parentItem.id == “design”) {<pre><code>obj = {
    obj : obj,
    tid : &quot;design&quot;
}
</code></pre> }<br> while (obj.obj) {<pre><code>id = obj.tid, obj = obj.obj;
basedom = this.getHtmlElementDomByItemId(id, basedom);
</code></pre> }<br> basedom = this.getHtmlElementDomByItemId(obj.tid, basedom);<br> return basedom;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>根据id判断当前组件是否有标签页节点item<br>*/<br>CoolOutlinePanel.prototype.isMultDroppableHtmlWidgetId = function(wid) {<br> if (!wid)<pre><code>return false;
</code></pre> var editor = g_dsn.getDesign(), widget = editor.getWidget(wid);<br> return this.isMultDroppableHtmlWidget(widget);<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>判断当前htmlwidget是否有多个标签页节点item<br>*/<br>CoolOutlinePanel.prototype.isMultDroppableHtmlWidget = function(widget) {<br> if (!(widget instanceof CWidget))<pre><code>return false;
</code></pre> if (!widget.ishtmlwidget)<pre><code>return false;
</code></pre> if (!widget.$droppabledom)<pre><code>return false;
</code></pre> if (widget.$droppabledom.length &gt; 1)<pre><code>return true;
</code></pre> var dom = widget.$droppabledom[0];<br> if ($(dom).attr(“istabpage”))<pre><code>return true;
</code></pre> return false;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>获取有多个标签页节点item的组件的激活页索引 前提 ：调用this.isMultDroppableHtmlWidget(widget)返回true<br>*</li>
<li>@param widget</li>
<li>有多标签页的组件</li>
<li>@param widordom<br>*/<br>CoolOutlinePanel.prototype.getActiveIndexOfWidget = function(widget, widordom) {<br> var droppabledoms = widget.$droppabledom, len = droppabledoms.length;<br> if (widordom &amp;&amp; !(widordom instanceof HTMLElement)<pre><code>    &amp;&amp; this.isCWidgetId(widordom)) {
var basedom = g_dsn.getDesign().basedom;
widordom = $(basedom).find(&quot;#&quot; + widordom)[0];
</code></pre> }<br> for ( var i = 0; i &lt; len; i++) {<pre><code>var droppabledom = droppabledoms[i];
if (droppabledom == widordom || $(droppabledom).find(widordom)[0])
    return i;
</code></pre> }<br> return 0;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>多标签页的组件切换标签<br>*</li>
<li>@param widget</li>
<li>多标签页的组件，如tab</li>
<li>@param index</li>
<li>激活页<br>*/<br>CoolOutlinePanel.prototype.setActiveIndexForWidget = function(widget, index) {<br>widget.setProperty(“activeTab”, index);<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>复制粘贴嵌套的组件，刷新结构树<br>*/<br>CoolOutlinePanel.prototype.refreshByDom = function(pdom) {<br> if (!pdom || pdom.children.length == 0)<pre><code>return;
</code></pre> var childs = pdom.children, len = childs.length;<br> for ( var i = 0; i &lt; len; i++) {<pre><code>var child = childs[i];
if (!child)
    continue;
var wid = child.getAttribute(&quot;wid&quot;), classname = this
        .getEffectiveClassName(child.className);
if (this.tree.rootItem.getItemById(wid))
    continue;
if (this.isFilterWidgetFocusElement(classname))
    continue;
if (child.getAttribute(&quot;idle&quot;) == &quot;true&quot;)
    continue;
if (child.tagName === &quot;WIDGET&quot; &amp;&amp; !!child.getAttribute(&quot;wid&quot;))
    continue;
if (this.getItemByHtmlElementDom(child.id, child))
    continue;
this.addWidget(pdom, child);
</code></pre> }<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>刷新、展开节点<br>*</li>
<li>@param rootitem</li>
<li>待刷新节点（父item</li>
<li>@param isRecursion</li>
<li>是否刷新rootitem的子item</li>
<li>@param wid</li>
<li><p>添加组件id或dom<br>*/<br>CoolOutlinePanel.prototype.refresh = function(rootitem, isRecursion, wid) {<br>rootitem = rootitem || this.tree.rootItem.getItemById(“design”);<br>if (rootitem.id) {<br>this.__refreshItem(rootitem, wid);<br>}<br>var self = this;<br>if (isRecursion) {<br>var children = rootitem.childItems;<br>if (!children || children.length &lt; 1)<br>return;<br>for ( var i = 0, len = children.length; i &lt; len; i++) {<br>var child = children[i];<br>if (needExpand(child, wid)) {<br>  var expand = child.isExpanded();<br>  this.refresh(child, isRecursion);<br>  if (!expand) {</p>
<pre><code>child.setExpanded(false);
</code></pre><p>  }<br>}<br>}<br>}</p>
<p>function needExpand(item, widOrdom) {<br>if (!item)<br>return false;<br>if (!widOrdom)<br>return true;<br>if (item.id == widOrdom)<br>return true;<br>if (widOrdom instanceof HTMLElement<br>  &amp;&amp; !(widOrdom.tagName === “WIDGET” &amp;&amp; !!widOrdom</p>
<pre><code>.getAttribute(&quot;wid&quot;))) {
</code></pre><p>if (item.id == widOrdom.id)<br>  return true;<br>var target = self.getItemByHtmlElementDom(widOrdom.id, widOrdom);<br>if (item.id == target.id)<br>  return true;<br>}<br>return false;<br>}<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>1、刷新这个item的图标，从无到有，或者从右到无 2、如果这个节点是展开，刷新子节点（可能被删除或者添加修改）<br>*</li>
<li>@param item</li>
<li>父item</li>
<li>@param wid</li>
<li>待添加item的wid<br>*/<br>CoolOutlinePanel.prototype.__refreshItem = function(item, wid) {<br>this._onExpand(item, wid);<br>if (item.iscon) {<br>this._checkIcon(item);<br>}<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>展开节点， 每次展开的时候都检查一下<br>*</li>
<li>@param item</li>
<li>父item</li>
<li>@param widgetid</li>
<li><p>添加组件时的组件id<br>*/<br>CoolOutlinePanel.prototype._onExpand = function(item, widgetid) {<br>var id = item.id;<br>if (!id)<br>return;<br>if (!item.iscon)<br>return;<br>var editor = g_dsn.getDesign(), widget = editor.getWidget(id);<br>var itemobj = item.userObj, pid = id;<br>var basedom = editor.basedom, childnodes = basedom.children;<br>if (widgetid) {<br>childnodes = [ _getCHtmlWidgetBaseDom(basedom, widgetid) ];<br>} else if (widget &amp;&amp; widget.ishtmlwidget) {<br>childnodes = this.<em>getCWidgetDroppableDom(widget);<br>} else if (id.startsWith(“elem</em>“)) {<br>childnodes = this.getHtmlElementParentNode(item).children;<br>} else if (id != “design”) {<br>childnodes = _getCHtmlWidgetBaseDom(basedom, id).children;<br>}<br>var infos = [], caption, icon, iselem = false, isdroppable = false, istabpage = false;<br>var len = childnodes.length;<br>if (len == 0)<br>return;<br>for ( var i = 0; i &lt; len; i++) {<br>var childnode = childnodes[i], index = i;<br>if (!childnode)<br>continue;<br>var wid = childnode.getAttribute(“wid”), classname = this<br>  .getEffectiveClassName(childnode.className);<br>if (this.tree.rootItem.getItemById(wid))<br>continue;<br>if (this.isFocusHtmlElement(childnode))<br>continue;<br>if (childnode.getAttribute(“idle”) == “true”)<br>continue;<br>if (childnode.tagName === “WIDGET” &amp;&amp; !!childnode.getAttribute(“wid”))<br>continue;<br>if (this.getItemByHtmlElementDom(childnode.id, childnode))<br>continue;</p>
<p>if (wid &amp;&amp; wid != “elem”) {<br>var cw = editor.getWidget(wid);<br>caption = this.getItemText(cw);<br>icon = cw.ishtmlwidget ? (cw.$droppabledom != null) : false;<br>} else if (childnode instanceof HTMLElement) {<br>wid = this.createNewElementId();<br>if (this.isMultDroppableHtmlWidget(widget)) {<br>  caption = I18N</p>
<pre><code>.getString(
        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.tabpages&quot;,
        &quot;容器&quot;);
</code></pre><p>  icon = true;<br>  index = this.getIndexByItem(item, i);<br>  istabpage = true;<br>} else if ($(childnode).hasClass(“defelement”)) {<br>  caption = I18N</p>
<pre><code>.getString(
        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.onecontrainer&quot;,
        &quot;单容器&quot;);
</code></pre><p>  icon = true;<br>  index = this.getIndexByItem(item, i, childnode);<br>  iselem = true;<br>  isdroppable = true;<br>} else {<br>  caption = childnode.id || “”;<br>  caption = I18N</p>
<pre><code>.getString(
        &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.htmlelement&quot;,
        &quot;HTML元素&quot;)
+ (!!caption ? (&quot; （&quot; + caption + &quot;）&quot;) : &quot;&quot;);
</code></pre><p>  icon = childnode.children.length &gt; 0;<br>  index = this.getIndexByItem(item, i, childnode);<br>  iselem = true;<br>}<br>}<br>var info = {<br>caption : caption,<br>id : wid,<br>iscon : icon,<br>haschild : this.hasChildren(wid, childnode),<br>userObj : {<br>  pid : pid,<br>  id : childnode.id,<br>  classname : classname,<br>  index : index,<br>  iselem : iselem,<br>  isdroppable : isdroppable,<br>  istabpage : istabpage,<br>  initexpand : true<br>}<br>};<br>infos.push(info);<br>}<br>// _clear(childitem);<br>item.loadFromArray(infos, this.loadFinish.bind(this));</p>
<p>function _clear(arr) {<br>for ( var i = 0, len = arr.length; i &lt; len; i++) {<br>if (arr[i]) {<br>  arr[i].remove();<br>}<br>}<br>}<br>function _indexOfId(arr, id) {<br>for ( var i = 0, len = arr.length; i &lt; len; i++) {<br>if (arr[i].id == id) {<br>  arr.splice(i, 1);<br>  return true;<br>}<br>}<br>return false;<br>}</p>
<p>function <em>getChildItems(item) {<br>var arr = item.childItems ? item.childItems.slice(0) : [];<br>for ( var i = arr.length - 1; i &gt;= 0; i–) {<br>if (arr[i] &amp;&amp; arr[i].id.startsWith(“elem</em>“)) {<br>  arr.splice(i, 1);<br>}<br>}<br>return arr;<br>}</p>
<p>function _isHtmlDom(dom, id) {<br>if (!id)<br>return false;<br>var editor = g_dsn.getDesign, basedom = $(editor.basedom)<br>  .find(“#” + id)[0];<br>if (basedom != dom)<br>return true;<br>return false;<br>}<br>;</p>
<p>function _getCHtmlWidgetBaseDom(basedom, id) {<br>if (id instanceof HTMLElement)<br>return id;<br>var dom = $(basedom).find(“#” + id)[0];<br>if (dom)<br>return dom;<br>return document.getElementById(id);<br>}</p>
</li>
</ul>
<p>};</p>
<p>/**</p>
<ul>
<li>获取待创建item对应的dom在父item对应的dom中的索引 1.item是tab组件，index就是其索引, htmldom为null</li>
<li>2.item是一般的cwidget组件，因为有id, 索引为0 3.item为htmlelement, htmldom就是对应的dom,</li>
<li>需要获取htmldom在父元素中索引<br>*</li>
<li>@param item</li>
<li>父item</li>
<li>@param index</li>
<li>默认的索引</li>
<li>@param htmldom<br>*/<br>CoolOutlinePanel.prototype.getIndexByItem = function(item, index, htmldom) {<br> if (!index)<pre><code>index = 0;
</code></pre> if (!item)<pre><code>return index;
</code></pre> if (htmldom/<em> &amp;&amp; $(htmldom).hasClass(“defelement”) </em>/) {<pre><code>var parent = htmldom.parentElement;
var childs = this.getEffectiveChildNodes(parent);
return this.getHtmlElementIndex(childs, htmldom);
</code></pre> }<br> var count = item.getChildrenCount();<br> if (count == 0)<pre><code>return index;
</code></pre> return count;<br>};</li>
</ul>
<p>CoolOutlinePanel.prototype.getItemText = function(widget) {<br>    if (!widget)<br>        return “”;<br>    var caption = “”;<br>    if (widget.ishtmlwidget) {<br>        caption = widget.getCaption();<br>        if (!caption) {<br>            caption = widget.getPptCaption();<br>        }<br>    } else {<br>        var wid = widget.id;<br>        wid = /[A-Za-z]+/.exec(wid)[0];<br>        caption = this.getCaption(wid, widget);<br>    }<br>    return caption + “ （” + widget.getName() + “）”;<br>};</p>
<p>CoolOutlinePanel.prototype.getCaption = function(wid, widget) {<br>    var caption = widget.tagname;<br>    switch (wid) {<br>    case “CWidgetGrid”:<br>        caption = I18N.getString(<br>                “ebi.user.coolrptdsn.reporteditor.coolproppanel.js.gird”,<br>                “可视化表格”);<br>        break;<br>    case “CWidgetChart”:<br>        caption = I18N.getString(<br>                “ebi.user.coolrptdsn.reporteditor.coolproppanel.js.chart”,<br>                “统计图”);<br>        break;<br>    case “CWidgetMap”:<br>        caption = I18N.getString(<br>                “ebi.user.coolrptdsn.reporteditor.coolproppanel.js.ditu”, “地图”);<br>        break;<br>    case “CWidgetMiniChart”:<br>        caption = I18N.getString(<br>                “ebi.user.coolrptdsn.reporteditor.coolproppanel.js.minichart”,<br>                “迷你图”);<br>        break;<br>    }<br>    return caption;<br>};</p>
<p>/**</p>
<ul>
<li>右键菜单<br>*</li>
<li>@param item</li>
<li>@param e</li>
<li><p>@param tree<br>*/<br>CoolOutlinePanel.prototype._onContextMenu = function(item, e, tree) {<br> this._onSelecting(item, e, tree);<br> if (!this.menu) {</p>
<pre><code>this.menu = new XPopupMenu(this.wnd);
this.menu.deleteitem = this.menu
        .addXMenuItem(
                I18N
                        .getString(
                                &quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.contextmenu.delete&quot;,
                                &quot;删除&quot;), null);
// this.menu.refreshitem =
// this.menu.addXMenuItem(I18N.getString(&quot;ebi.user.coolrptdsn.reporteditor.cooltabpanel.js.contextmenu.refresh&quot;,&quot;刷新&quot;),
// null);
</code></pre><p> }<br> var id = item.id, editor = g_dsn.getDesign();</p>
<p> if (id == “design” || item.userObj.istabpage || !editor.isVisible()) {</p>
<pre><code>this.menu.deleteitem.setVisible(false);
</code></pre><p> } else {</p>
<pre><code>this.menu.deleteitem.setVisible(true);
this.menu.deleteitem.setOnClick(this.deleteWidget.bind(this, item));
</code></pre><p> }<br> // if(!item.iscon){<br> // this.menu.refreshitem.setVisible(false);<br> // }else{<br> // this.menu.refreshitem.setVisible(true);<br> // this.menu.refreshitem.setOnClick(this.refresh.bind(this, item, false));<br> // }<br> this.menu.popupAtCursor(e);<br>};</p>
</li>
</ul>
<p>CoolOutlinePanel.ICONS = {<br>    “chtmlwidget” : “ebi/user/coolrptdsn/images/widget/inner.png”,<br>    “cwidgetgrid” : “ebi/user/reportpagedsn/images/tplgrid.png”<br>};</p>
<p>/**</p>
<ul>
<li>报表模板的资源树,是一颗动态树，采用actontree设置action 即可，后台形成此树内容<br>*</li>
<li>@param wnd</li>
<li>@param parentElement</li>
<li>@param width</li>
<li>@param height</li>
<li>@param xmlconfig<br>*/<br>function CoolSourcePanel(wnd, parentElement, width, height) {<br> if (_biInPrototype)<pre><code>return;
</code></pre> this.xTree = new XTree(wnd, parentElement, width, height);<br>}</li>
</ul>
<p>/**</p>
<ul>
<li><p>初始化资源树<br><em>
</em>/<br>CoolSourcePanel.prototype.init = function() {<br> this.xTree.setOnExpand(this._getChildNode.bind(this));<br> this.xTree</p>
<pre><code>.getRootItem()
.loadFrom(
        [
                {
                    // caption : &quot;维表&quot;,
                    caption : I18N
                            .getString(
                                    &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.14&quot;,
                                    &quot;维表&quot;),
                    img0 : &quot;ebi/images/lefttree/codemgr.gif&quot;,
                    userObj : {
                        id : &quot;EBI$5$&quot;
                                + g_dwSubjectSet.getOwnerGroupId()
                    },
                    haschild : true
                }, {
                    caption : g_dwSubjectSet.getCaption(),
                    img0 : &quot;ebi/images/lefttree/tsk.gif&quot;,
                    userObj : {
                        id : g_dwSubjectSet.getResourceId()
                    },
                    haschild : true
                } ]);
</code></pre><p> /**</p>
<ul>
<li>添加数据源的节点<br>*/<br>this.datasourceTree = this.xTree<pre><code>.getRootItem()
.appendChild(
        I18N
                .getString(
                        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.15&quot;,
                        &quot;自定义数据源&quot;));
</code></pre>this.datasourceTree.id = “datasource”;<br>this.datasourceTree<pre><code>.setItemImage(&quot;ebi/user/reportpagedsn/images/datasource.gif&quot;);
</code></pre>/*</li>
<li>ISSUE:ESENBI-3946 add by RX 2015.01.09</li>
<li><p>没有执行SQL数据源的权限的用户查看或编辑表样时，不能让其看到新增和编辑sql数据源的权限，否则可能泄露数据信息，认为数据是有价值、高敏感的<br>*/<br>// this.datasourceTree.setVisible(g_showsql);<br>this.sqlds = this.datasourceTree.appendChild(I18N.getString(</p>
<pre><code>&quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.16&quot;,
&quot;sql数据源&quot;));
</code></pre><p>this.sqlds.id = “sqlroot”;<br>this.sqlds.setItemImage(“ebi/user/reportpagedsn/images/sqlds.gif”);</p>
<p>this.oltpds = this.datasourceTree.appendChild(I18N.getString(</p>
<pre><code>&quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.17&quot;,
&quot;oltp数据源&quot;));
</code></pre><p>this.oltpds.id = “oltproot”;<br>this.oltpds.setItemImage(“ebi/user/reportpagedsn/images/oltpds.gif”);<br>// ESENBI-235， add by zqj 2014.12.04 oltp数据源功能前台界面隐藏掉<br>this.oltpds.setVisible(false);</p>
<p>this.aliasds = this.datasourceTree.appendChild(I18N.getString(</p>
<pre><code>&quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.18&quot;,
&quot;引用主题表&quot;));
</code></pre><p>this.aliasds.id = “aliasftroot”;<br>this.aliasds.setItemImage(“ebi/user/reportpagedsn/images/aliasds.gif”);</p>
<p>// 给数据源的树添加右键菜单<br>var self = this;<br>this.xTree.setOnContextMenu(function(item, e, obj) {<br> self.__oncontextMenuResourceTree(item, e, obj);<br>});</p>
<p>this.xTree.setOnDblClick(function(item, e) {<br> self.__onDblClick(item, e);<br>});</p>
<p>// 绑定拖拽事件<br>this.bindEvent();<br>};</p>
</li>
</ul>
</li>
</ul>
<p>CoolSourcePanel.prototype.bindEvent = function() {<br>    this._onmousedown = this.onDragSatrt.bind(this);<br>    addEvent(this.xTree.treeDiv, “mousedown”, this._onmousedown, false);<br>};</p>
<p>/**</p>
<ul>
<li>绑定拖拽事件<br>*</li>
<li>@param evt<br>*/<br>CoolSourcePanel.prototype.onDragSatrt = function(evt) {<br> var designobj = g_dsn.getDesign();<br> if (designobj &amp;&amp; designobj.isVisible()) {<pre><code>designobj.dragStart(evt);
return;
</code></pre> }<br> var getdataobj = g_dsn.getGetData();<br> if (getdataobj &amp;&amp; getdataobj.isVisible()) {<pre><code>getdataobj.dragStart(evt);
return;
</code></pre> }<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>根据dom获得item<br>*/<br>CoolSourcePanel.prototype.getItemByDom = function(dom) {<br> var item = undefined, id;<br> for ( var i = 0; i &lt; 5; i++) {<pre><code>id = dom.getAttribute(&quot;id&quot;);
if (id) {
    item = this.xTree.getItemObj(id);
    if (item)
        break;
}
dom = dom.parentNode;
</code></pre> }<br> return item;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>获得资源树<br>*/<br>CoolSourcePanel.prototype.getResourceTree = function() {<br> return this.xTree;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>左边栏数据源树上添加右键菜单<br>*</li>
<li>@param item</li>
<li>@param e</li>
<li><p>@param obj<br>*/<br>CoolSourcePanel.prototype.__oncontextMenuResourceTree = function(item, e, obj) {<br> if (!item)</p>
<pre><code>return;
</code></pre><p> var self = this;<br> this.toolMenu = new XPopupMenu(this.wnd);<br> if (item.getParentItem().id == “datasource”) {</p>
<pre><code>// 自定义数据源下面几个节点，右键存在“新建”菜单
// this.toolMenu_newdef =
// this.toolMenu.addXMenuItem(&quot;新建&quot;,null,function(){
this.toolMenu_newdef = this.toolMenu.addXMenuItem(I18N.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.19&quot;,
        &quot;新建&quot;), null, function() {
    if (item.id == &quot;sqlroot&quot;) {
        self.showSqlEditor(item, 0);
    } else if (item.id == &quot;oltproot&quot;) {
        self.showOltpEditor(item, 0);
    } else if (item.id == &quot;aliasftroot&quot;) {
        self.showAliasEditor(item, 0);
    }
});
</code></pre><p> } else if (item.type == “sql” || item.type == “oltp”</p>
<pre><code>    || item.type == &quot;aliasft&quot;) {
// 数据源下面的子节点存在“编辑”“删除”菜单
// this.toolMenu_newgroup =
// this.toolMenu.addXMenuItem(&quot;编辑&quot;,null,function(){
this.toolMenu_newgroup = this.toolMenu.addXMenuItem(I18N.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.20&quot;,
        &quot;编辑&quot;), null, function() {
    if (item.type == &quot;sql&quot;) {
        self.showSqlEditor(item, 1);
    } else if (item.type == &quot;oltp&quot;) {
        self.showOltpEditor(item, 1);
    } else if (item.type == &quot;aliasft&quot;) {
        self.showAliasEditor(item, 1);
    }
});
// this.toolMenu_deldef =
// this.toolMenu.addXMenuItem(&quot;删除&quot;,null,function(){self.deleteDataSource(item);});
this.toolMenu_deldef = this.toolMenu.addXMenuItem(I18N.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.21&quot;,
        &quot;删除&quot;), null, function() {
    self.deleteDataSource(item);
});
// 如果是sql数据源添加设置属性的对话框
if (item.type == &quot;sql&quot;) {
    // this.toolMenu_attrdef =
    // this.toolMenu.addXMenuItem(&quot;属性&quot;,null,function(){self.showAttrDlg(item);});
    this.toolMenu_attrdef = this.toolMenu
            .addXMenuItem(
                    I18N
                            .getString(
                                    &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.22&quot;,
                                    &quot;属性&quot;), null, function() {
                        self.showAttrDlg(item);
                    });
}
</code></pre><p> } else if (item.type == “sqlColunm”) {</p>
<pre><code>// sql数据源的字段节点上绑定右键设置维表的菜单
// this.toolMenu_dimdef =
// this.toolMenu.addXMenuItem(&quot;设置维表&quot;,null,function(){self.showDimsDlg(item);});
this.toolMenu_dimdef = this.toolMenu.addXMenuItem(I18N.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.23&quot;,
        &quot;设置维表&quot;), null, function() {
    self.showDimsDlg(item);
});
</code></pre><p> }</p>
<p> if (item.getParentItem().id == “ztdatasource”) {</p>
<pre><code>// 自定义数据源下面几个节点，右键存在“新建”菜单
// this.toolMenu_newdef =
// this.toolMenu.addXMenuItem(&quot;新建&quot;,null,function(){
this.toolMenu_newdef = this.toolMenu.addXMenuItem(I18N.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.19&quot;,
        &quot;新建&quot;), null, function() {
    if (item.id == &quot;bbq&quot;) {
        self.showSqlEditor(item, 0);
    } else if (item.id == &quot;filter&quot;) {
        self.showOltpEditor(item, 0);
    }
});
</code></pre><p> } else if (item.type == “filter” || item.type == “bbq”) {</p>
<pre><code>// 数据源下面的子节点存在“编辑”“删除”菜单
// this.toolMenu_newgroup =
// this.toolMenu.addXMenuItem(&quot;编辑&quot;,null,function(){
this.toolMenu_newgroup = this.toolMenu.addXMenuItem(I18N.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.20&quot;,
        &quot;编辑&quot;), null, function() {
    if (item.getParentItem().id == &quot;bbq&quot;) {
        self.showSqlEditor(item, 1);
    } else if (item.getParentItem().id == &quot;filter&quot;) {
        self.showOltpEditor(item, 1);
    }
});
// this.toolMenu_deldef =
// this.toolMenu.addXMenuItem(&quot;删除&quot;,null,function(){self.deleteDataSource(item);});
this.toolMenu_deldef = this.toolMenu.addXMenuItem(I18N.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.21&quot;,
        &quot;删除&quot;), null, function() {
    self.deleteDataSource(item);
});
</code></pre><p> }<br> this.toolMenu.popupAtCursor(e);<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>初始化自定义数据源的节点<br>*</li>
<li><p>@param item<br>*/<br>CoolSourcePanel.prototype.fromJsonToDs = function(json) {<br> for ( var elem in json) {</p>
<pre><code>var data = {};
data[elem] = json[elem];
if (json[elem].tagname == &quot;sql&quot;) {
    var obj = this.sqlds.appendChild(elem);
    obj.setUserObj(data);
    obj.name = elem;
    obj.type = &quot;sql&quot;;
    obj.setItemImage(&quot;ebi/user/reportpagedsn/images/sql.gif&quot;);
    // 添加列的子节点
    this.appendSqlColunm(json[elem].sqlcolunm, obj);

} else if (json[elem].tagname == &quot;oltp&quot;) {
    var obj = this.oltpds.appendChild(elem);
    obj.setUserObj(data);
    obj.name = elem;
    obj.type = &quot;oltp&quot;;
    obj.setItemImage(&quot;ebi/user/reportpagedsn/images/olap.gif&quot;);
} else if (json[elem].tagname == &quot;factTableAlias&quot;) {
    var obj = this.aliasds.appendChild(elem);
    obj.setUserObj(data);
    obj.name = elem;
    obj.type = &quot;aliasft&quot;;
    obj.setItemImage(&quot;ebi/user/reportpagedsn/images/alias.gif&quot;);
}
</code></pre><p> }<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>根据主题表的资源id在分析表中查找它的别名，如果该主题表不是它的引用主题表则返回null。<br>*</li>
<li>@param id<br>*/<br>CoolSourcePanel.prototype.getFactTableAliasName = function(id) {<br> // ESENBI-1774 add by zqj 2014.09.11 getName方法不支持，<br> // 因前段时间改分析组件的sql数据源时改过结构而引起的这个问题<br> var aliasarr = this.aliasds.getAllChildItem();<br> for ( var i = 0; i &lt; aliasarr.length; i++) {<pre><code>var obj = aliasarr[i].getUserObj();
var name = aliasarr[i].name;
var resourceid = obj[name].factTableAliasContent.resourceid;
/**
 * resourceid有两种格式，可能是后面带.fact也可能不带，所以为了判断的更准确先将判断的字符串
 * 用点分割成数组，然后比较第一个元素是否相等 add by mxm at 20100708
 */
if (id.split(&apos;.&apos;)[0] == resourceid.split(&apos;.&apos;)[0]) {
    return name;
}
</code></pre> }<br> return null;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>当操作数据源后，设置界面的状态为修改状态 ESENBI-1207 操作数据源后关闭时没有提示已修改的信息 add by zqj 2014.08.05<br>*/<br>CoolSourcePanel.prototype.setChangedState = function() {<br> var editor = g_dsn.getDesign();<br> if (!editor.hasChanged)<pre><code>editor.hasChanged = true;
</code></pre>};</li>
</ul>
<p>/**</p>
<ul>
<li>数据源的删除操作<br>*</li>
<li>@param item<br>*/<br>CoolSourcePanel.prototype.deleteDataSource = function(item) {<br> var self = this;<br> // confirmDialog(“提示”,”确定删除？”, false, null, function() {<br> confirmDialog(<pre><code>I18N
        .getString(
                &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.12&quot;,
                &quot;提示&quot;),
I18N
        .getString(
                &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.24&quot;,
                &quot;确定删除？&quot;), false, null, function() {
    item.remove();
    // 设置界面为修改状态
    self.setChangedState();
});
</code></pre>};</li>
</ul>
<p>/**</p>
<ul>
<li>sql数据源定义框<br>*</li>
<li>@param item</li>
<li>父节点</li>
<li>@param status</li>
<li>0-新建 1-编辑<br>*/<br>CoolSourcePanel.prototype.showSqlEditor = function(item, status) {<br>var self = this;<br>// ESENBI-252,编辑后关闭一张表，打开另一张表在编辑没反应<br>getObjectFromRootAsync(“OltpSqlEditor”, “_SqlDlg_Imp”, true,<br>“xdialog,ebi/user/reportpagedsn/dlg/sqleditor.js”, function(dlg) {<br>  dlg.setOnOk(function(v) {<pre><code>self.onSqlFinish(v, item);
</code></pre>  });<br>  if (status == 1) {<pre><code>// 编辑，加载内容
dlg.loadFromObj(item.getUserObj(), null);
</code></pre>  } else {<pre><code>// 新建，初始化名称
dlg.loadFromObj(null, self._getUniqueDataSourceName(&quot;rs&quot;));
// 新建时，设置默认的连接池是主题集的默认连接池
// ESENBI-2045 add by zqj 2014.10.10
dlg.setSqlDataSource(g_dwSubjectSet.getResourceId());
</code></pre>  }<br>  dlg.open(true);<br>});<br>};</li>
</ul>
<p>/*</p>
<ul>
<li>将之前设置的SQL源额外属性（关联维表、关联特殊字段等）合并到新的树节点自定义对象上 合并策略是如果相同名字的字段仍存在，则保留到新对象上</li>
<li>newUserObj和userObj是树节点上依附的对象，具体内容格式见sqltableset.js#export2obj及sqleditor.js#SqlResultSet&amp;jsonToSqlRs</li>
<li>sqldsName为正在编辑的SQL数据源名字<br>*/<br>CoolSourcePanel.prototype._mergeSqlAdditionalSetting = function(newUserObj,<pre><code>userObj, sqldsName) {
</code></pre> if (!userObj) {<pre><code>return;
</code></pre> }<br> var newSqlJson = newUserObj[sqldsName];<br> // 新的SQL列列表，是老设置中关联字段是否需要保留的参考依据<br> var newSqlColumns = newSqlJson[“sqlcolunm”];<br> var newColumnArr = newSqlColumns.split(“;”);<br> var newColumnsObj = {};<br> var newcolnum = newColumnArr.length;<br> for ( var i = 0; i &lt; newcolnum; i++) {<pre><code>var acol = newColumnArr[i];
if (!!acol) {
    newColumnsObj[acol] = true;
}
</code></pre> }<br> var sqlJson = userObj[sqldsName];<br> if (!sqlJson)<pre><code>return;
</code></pre> if (!!sqlJson[“option”]) {<pre><code>var option = sqlJson.option;
var newoption = {};
var mid = option[&quot;mid&quot;];
if (!!mid &amp;&amp; newColumnsObj[mid]) {
    newoption[&quot;mid&quot;] = mid;
}
var pid = option[&quot;pid&quot;];
if (!!pid &amp;&amp; newColumnsObj[pid]) {
    newoption[&quot;pid&quot;] = pid;
}
var bbqfield = option[&quot;bbqfield&quot;];
if (!!bbqfield &amp;&amp; newColumnsObj[bbqfield]) {
    newoption[&quot;bbqfield&quot;] = bbqfield;
}
var frombbq = option[&quot;frombbq&quot;];
if (!!frombbq &amp;&amp; newColumnsObj[frombbq]) {
    newoption[&quot;frombbq&quot;] = frombbq;
}
var tobbq = option[&quot;tobbq&quot;];
if (!!tobbq &amp;&amp; newColumnsObj[tobbq]) {
    newoption[&quot;tobbq&quot;] = tobbq;
}
if (!isEmptyJson(newoption)) {
    if (!!newoption[&quot;bbqfield&quot;] || !!newoption[&quot;frombbq&quot;]
            || !!newoption[&quot;tobbq&quot;]) {
        newoption[&quot;bbqkind&quot;] = option[&quot;bbqkind&quot;];
        newoption[&quot;bbqtype&quot;] = option[&quot;bbqtype&quot;];
    }
    newoption[&quot;mid&quot;] = newoption[&quot;mid&quot;] || &quot;&quot;;
    newoption[&quot;pid&quot;] = newoption[&quot;pid&quot;] || &quot;&quot;;
    newSqlJson[&quot;option&quot;] = newoption;
}
</code></pre> }<br> if (!!sqlJson[“dimcolunm”]) {<pre><code>var dimcolumn = sqlJson.dimcolunm;
var newdimcolsObj = {};
for ( var col in dimcolumn) {
    var dim = dimcolumn[col];
    if (!!dim &amp;&amp; newColumnsObj[col]) {
        newdimcolsObj[col] = dim;
    }
}
if (!isEmptyJson(newdimcolsObj)) {
    newSqlJson[&quot;dimcolunm&quot;] = newdimcolsObj;
}
</code></pre> }<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>sql数据源定义框按“确定”按钮后的处理<br>*</li>
<li>@param v</li>
<li>obj对象，包含name,json,colunm字段</li>
<li>@param item</li>
<li><p>树节点<br>*/<br>CoolSourcePanel.prototype.onSqlFinish = function(v, item) {</p>
<p>// 设置界面为修改状态<br>this.setChangedState();</p>
<p>// 判断是新建还是编辑<br>var obj;<br>// 将SQL数据源树节点原来绑定的对象备份起来，供后面合并属性使用<br>var bkUserObj = item.getUserObj();<br>if (!item.type) { // 新建<br>// 判断是否重名<br>if (this._equalDataSourceName(v.name)) {<br>showMessage(I18N</p>
<pre><code>.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.25&quot;,
        &quot;存在同名的数据源！&quot;));
</code></pre><p>return;<br>}<br>obj = item.appendChild(v.name);<br>} else {// 编辑<br>obj = item;<br>// 判断是否重名<br>if (obj.name != v.name) {<br>if (this._equalDataSourceName(v.name)) {<br>  showMessage(I18N</p>
<pre><code>.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.25&quot;,
        &quot;存在同名的数据源！&quot;));
</code></pre><p>  return;<br>}<br>}<br>// 判断编辑是否有改动，数据源名和sql语句和连接池都没有改动，则不需要重新加载字段子节点<br>// 需要比较字节点是否一样，不一样仍需重新加载<br>if ((obj.name == v.name)) {<br>var startObj = item.getUserObj()[obj.name];<br>var startSql = startObj[“sqlcontent”].trim();<br>var startdb = startObj[“dbserver”];<br>var startcolunm = startObj[“sqlcolunm”];<br>var endObj = v.toJson;<br>var endSql = endObj[“sqlcontent”].trim();<br>var enddb = endObj[“dbserver”];<br>var endcolunm = endObj[“sqlcolunm”];<br>if (startSql == endSql</p>
<pre><code>&amp;&amp; startdb == enddb
&amp;&amp; compareJson(startObj[&quot;macros&quot;] || {}, endObj[&quot;macros&quot;]
        || {}) &amp;&amp; startcolunm == endcolunm) {
</code></pre><p>  return;<br>}<br>}<br>obj.setItemText(v.name);<br>obj.clearChildren();<br>}<br>// 在树上更新节点<br>var userObj = {};<br>userObj[v.name] = v.toJson;<br>obj.setUserObj(userObj);<br>obj.name = v.name;<br>obj.type = “sql”;<br>obj.setItemImage(“ebi/user/reportpagedsn/images/sql.gif”);<br>// 从原设置中的option/dimcolunm合并仍存在的字段设置<br>this._mergeSqlAdditionalSetting(userObj, bkUserObj, v.name);</p>
<p>// 解析sql语句，更新节点<br>this.appendSqlColunm(v.colunm, obj);<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>给sql数据源添加列的子节点<br>*</li>
<li>@param colunms</li>
<li>@param item<br>*/<br>CoolSourcePanel.prototype.appendSqlColunm = function(colunms, item) {<br> var colunm = colunms.split(“;”);<br> var userObj = item.getUserObj();<br> var name = item.name;<br> var dimcolunm = userObj[name].dimcolunm;<br> for ( var i = 0; i &lt; colunm.length; i++) {<pre><code>var child = colunm[i];
if (child != &quot;&quot; &amp;&amp; child != &quot;&quot;) {
    var colobj = item.appendChild(child);
    colobj.colunm = child;
    colobj.name = item.name;
    colobj.type = &quot;sqlColunm&quot;;
    if (dimcolunm &amp;&amp; dimcolunm[child]) {
        colobj.setItemText(child + &quot;--&gt;&quot; + dimcolunm[child]);
        colobj.dimname = dimcolunm[child];
    }
    this.appendSqlColunmEvent(colobj);
}
</code></pre> }<br> item.setExpanded(false);<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>sql数据源在树上添加指标拖拽事件<br>*</li>
<li>@param item<br>*/<br>CoolSourcePanel.prototype.appendSqlColunmEvent = function(item) {<br> var dragDom = item.getItemDom().parentNode.firstChild;<br> var dragparam = {<pre><code>sqldim : item.name + &quot;.&quot; + item.colunm
</code></pre> };<br> dragDom.setAttribute(“dragtype”, “ds_sqldim”);<br> dragDom.setAttribute(“dragparam”, JSON.stringify(dragparam));<br> item.nodeTable.setAttribute(“id”, dragparam[“sqldim”]);<br> item.id = dragparam[“sqldim”];</li>
</ul>
<p>};</p>
<p>/**</p>
<ul>
<li>sql数据源右键属性的方法 弹出设置属性的对话框<br>*</li>
<li><p>@param item<br>*/<br>CoolSourcePanel.prototype.showAttrDlg = function(item) {<br> var obj = item.getUserObj();<br> var name = item.name;<br> var self = this;<br> // ESENBI-3998 add by zqj 2015.01.07<br> // sql数据源的属性框和主题集属性中的数据表映射对话框都是全局的对话框，不同的js对象实现的，之前两个id重复了，导致一个打开后，另一个就报错<br> getObjectFromRootAsync(“OltpThemeDlg”, “__SqlPro”, true,</p>
<pre><code>&quot;xui/ctrls/xcombobox.js,ebi/user/reportpagedsn/dlg/sqltableset.js&quot;,
function(otd) {
    otd.loadFrom(obj[name].option);
    otd.loadColunms(obj[name].sqlcolunm);
    otd.setIconStyle(&quot;window-titleicon_edit&quot;);
    otd.setOnOk(function(option) {
        // 将设置的属性值存储到左树上
        obj[name].option = option;
        item.setUserObj(obj);

        // 设置界面为修改状态
        self.setChangedState();
    });
    otd.open(true);
});
</code></pre><p>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>sql数据源字段节点上的右键设置维表的方法 弹出维表选择下拉框<br>*</li>
<li><p>@param item<br>*/<br>CoolSourcePanel.prototype.showDimsDlg = function(item) {</p>
<p> var self = this;<br> getObjectFromRootAsync(“ShowDimsDlg”, “_ShowDimsDlgPro”, true,</p>
<pre><code>&quot;ebi/user/reportpagedsn/dlg/sqltableset.js&quot;, function(otd) {
    // 获得维表数据，及初始化值，进行设置
    var dnm = item.dimname;
    g_dwSubjectSet.dimsMgr = null;
    g_dwSubjectSet.getTaskDims(function(dims) {
        otd.setDims(dims, dnm);
    });
    // 设置确定后的回调函数，修改树上显示的文字，将设置的维表存储起来
    otd.setOnOk(function(dimName) {
        // 将设置的对应维度绑定到树的节点上
        var caption = item.colunm;
        if (dnm == dimName)
            return;
        item.setItemText(dimName ? (caption + &quot;--&gt;&quot; + dimName)
                : caption);
        item.dimname = dimName;
        // 更新父节点存储的json格式
        var pitem = item.getParentItem();
        var userObj = pitem.getUserObj();
        var name = item.name;
        var dimcolunm = userObj[name].dimcolunm;
        if (!dimcolunm) {
            dimcolunm = {};
        }
        // 如果设置了维表，添加一个属性，如果清空维表，这将改属性清空
        if (dimName) {
            dimcolunm[caption] = dimName;
        } else {
            if (dimcolunm[caption]) {
                delete dimcolunm[caption];
            }
        }
        userObj[name].dimcolunm = dimcolunm;
        pitem.getUserObj(userObj);

        // 设置界面为修改状态
        self.setChangedState();
    });
    // 打开对话框
    otd.open(true);
});
</code></pre><p>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>OLTP数据源定义框<br>*</li>
<li>@param item</li>
<li>父节点</li>
<li>@param status</li>
<li>0-新建 1-编辑<br>*/<br>CoolSourcePanel.prototype.showOltpEditor = function(item, status) {<br>var self = this;<br>getObjectFromRootAsync(<br>“OltpThemeDlg”,<br>“_OltpDlg_Imp”,<br>true,<br>“ebi/user/reportpagedsn/dlg/oltpeditor.js”,<br>function(dlg) {<br>  dlg.setOnOk(function(o) {<pre><code>self.onOltpFinish(o, item);
</code></pre>  });<br>  var theme = dlg.getOltpTheme();<br>  theme.setVisibleDbLink(true);<br>  theme.setThemeReadOnly(false);<br>  if (status == 1) {<pre><code>// 编辑，加载内容
theme.loadFrom(item.getUserObj());
</code></pre>  } else {<pre><code>// 新建，初始化名称
theme.loadFrom(null);
theme.setOltpName(self._getUniqueDataSourceName(&quot;olt&quot;));
</code></pre>  }<br>  theme<pre><code>.setThemeNameCaption(I18N
        .getString(
                &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.48&quot;,
                &quot;数据源名称：&quot;));
</code></pre>  dlg<pre><code>.setCaption(I18N
        .getString(
                &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.49&quot;,
                &quot;OLTP数据源&quot;));
</code></pre>  dlg.open(true);<br>});<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>OLTP数据源定义框 按“确定”按钮后的操作<br>*</li>
<li>@param v</li>
<li>obj对象，包含name,json字段</li>
<li>@param item</li>
<li><p>父节点<br>*/<br>CoolSourcePanel.prototype.onOltpFinish = function(v, item) {</p>
<p>// 设置界面为修改状态<br>this.setChangedState();</p>
<p>// 判断是新建还是编辑<br>var obj;<br>if (!item.type) { // 新建<br>// 判断是否重名<br>if (this._equalDataSourceName(v.name)) {<br>showMessage(I18N</p>
<pre><code>.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.25&quot;,
        &quot;存在同名的数据源！&quot;));
</code></pre><p>return;<br>}<br>obj = item.appendChild(v.name);<br>} else {// 编辑<br>obj = item;<br>// 判断是否重名<br>if (obj.name != v.name) {<br>if (this._equalDataSourceName(v.name)) {<br>  showMessage(I18N</p>
<pre><code>.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.25&quot;,
        &quot;存在同名的数据源！&quot;));
</code></pre><p>  return;<br>}<br>}<br>obj.setItemText(v.name);<br>obj.clearChildren();<br>}</p>
<p>// 树上节点更新<br>var userObj = {};<br>userObj[v.name] = v.toJson;<br>obj.setUserObj(userObj);<br>obj.name = v.name;<br>obj.type = “oltp”;<br>obj.setItemImage(“ebi/user/reportpagedsn/images/oltp.gif”);<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>引用主题表定义框<br>*</li>
<li>@param item</li>
<li>父节点</li>
<li>@param status</li>
<li>0-新建 1-编辑<br>*/<br>CoolSourcePanel.prototype.showAliasEditor = function(item, status) {<br>var self = this;<br>getObjectFromRootAsync(“AliasFTEditor”, “_AliasFTDlg_Imp”, true,<br>“xdialog,ebi/user/reportpagedsn/dlg/aliasfteditor.js”,<br>function(dlg) {<br>  dlg.setTaskid(g_dwSubjectSet.getTaskId());<br>  if (status == 1) {<pre><code>// 编辑，加载内容
dlg.loadJson(item.getUserObj());
</code></pre>  } else {<pre><code>// 新建，初始化名称
dlg.setAliasName(self._getUniqueDataSourceName(&quot;aft&quot;));
</code></pre>  }<br>  dlg.onClickOk = function(v) {<pre><code>if (dlg.clickOK()) {
    self.onAliasFinish(v, item);
}
</code></pre>  };<br>  dlg.show();<br>});<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>引用主题表定义框 按“确定”按钮后的操作<br>*</li>
<li>@param v</li>
<li>obj对象，包含name,json字段</li>
<li>@param item</li>
<li><p>父节点<br>*/<br>CoolSourcePanel.prototype.onAliasFinish = function(v, item) {</p>
<p>// 设置界面为修改状态<br>this.setChangedState();</p>
<p>// 判断是新建还是编辑<br>var obj;<br>if (!item.type) { // 新建<br>// 判断是否重名<br>if (this._equalDataSourceName(v.name)) {<br>showMessage(I18N</p>
<pre><code>.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.25&quot;,
        &quot;存在同名的数据源！&quot;));
</code></pre><p>return;<br>}<br>obj = item.appendChild(v.name);<br>} else {// 编辑<br>obj = item;<br>// 判断是否重名<br>if (obj.name != v.name) {<br>if (this._equalDataSourceName(v.name)) {<br>  showMessage(I18N</p>
<pre><code>.getString(
        &quot;ebi.user.report.pagedsn.template.rpt_reporttemplate.js.25&quot;,
        &quot;存在同名的数据源！&quot;));
</code></pre><p>  return;<br>}<br>}<br>obj.setItemText(v.name);<br>obj.clearChildren();<br>}</p>
<p>// 在树上更新节点<br>var userObj = {};<br>userObj[v.name] = v.toJson;<br>obj.setUserObj(userObj);<br>obj.name = v.name;<br>obj.type = “aliasft”;<br>obj.setItemImage(“ebi/user/reportpagedsn/images/alias.gif”);<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li><p>双击事件 sql和oltp双击打开编辑界面 引用主题表，在bottomworkspace中打开主题表<br>*/<br>CoolSourcePanel.prototype.__onDblClick = function(item, e) {</p>
<p> if (item.type == “sql”) {</p>
<pre><code>this.showSqlEditor(item, 1);
</code></pre><p> } else if (item.type == “oltp”) {</p>
<pre><code>this.showOltpEditor(item, 1);
</code></pre><p> } else if (item.type == “aliasft”) {</p>
<pre><code>var json = item.getUserObj();
var name = item.name;
var rptid = json[name].factTableAliasContent.resourceid;

if (rptid) {
    var ws = getWorkspace();
    /**
     * ISSUE:http://192.168.1.200/jira/browse/WTAP-1119
     * 调用了setCellContentStyle(&quot;pickname&quot;)后处于拾取状态才会显示字段名
     */
    if (ws) {
        ws.showTaskbook(rptid, null, function(wnd) {
            wnd.taskbook.setCellContentStyle(&quot;pickname&quot;);
        }, null, g_dsn.getAsidePlaceInWorkspace());
    }
}
</code></pre><p> }<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>清空数据源，在装入本地文件前要清空数据源的树 ESENBI-1693 add by zqj 2014.09.10<br>*/<br>CoolSourcePanel.prototype.clearDataSource = function() {<br> this.sqlds.clearChildren();<br> this.oltpds.clearChildren();<br> this.aliasds.clearChildren();<br>};</li>
</ul>
<p>/**</p>
<ul>
<li><p>获得数据源树上的自定义数据源的json格式<br>*/<br>CoolSourcePanel.prototype.getDataSource = function() {<br> var datasourceJson = {};<br> // sql数据源<br> var sqlarr = this.sqlds.getAllChildItem();<br> for ( var i = 0; i &lt; sqlarr.length; i++) {</p>
<pre><code>var item = sqlarr[i];
$.extend(datasourceJson, item.getUserObj());
</code></pre><p> }</p>
<p> // oltp数据源<br> var oltparr = this.oltpds.getAllChildItem();<br> for ( var i = 0; i &lt; oltparr.length; i++) {</p>
<pre><code>var item = oltparr[i];
$.extend(datasourceJson, item.getUserObj());
</code></pre><p> }</p>
<p> // 主题表数据源<br> var aliasarr = this.aliasds.getAllChildItem();<br> for ( var i = 0; i &lt; aliasarr.length; i++) {</p>
<pre><code>var item = aliasarr[i];
$.extend(datasourceJson, item.getUserObj());
</code></pre><p> }<br> return datasourceJson;<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>根据数据源的名字，获得数据源信息 表格中的打点提示信息会使用到，需要根据数据源的名字，获得相应的字段 add by zqj 2015.02.10<br>*</li>
<li><p>@param name<br>*/<br>CoolSourcePanel.prototype.getDataSourceByName = function(name) {<br> var datasourceJson = null;</p>
<p> // 获得数据源数组<br> var sqlarr = this.sqlds.getAllChildItem();<br> var oltparr = this.oltpds.getAllChildItem();<br> var aliasarr = this.aliasds.getAllChildItem();<br> var arr = [];<br> arr.putAll(sqlarr);<br> arr.putAll(oltparr);<br> arr.putAll(aliasarr);</p>
<p> // 循环数组，查找数据源<br> for ( var i = 0; i &lt; arr.length; i++) {</p>
<pre><code>var item = arr[i];
if (name.equalsIgnoreCase(item.name)) {
    datasourceJson = item.getUserObj();
    break;
}
</code></pre><p> }</p>
<p> return datasourceJson;<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>判断数据源名字是否重名<br>*</li>
<li>@param name</li>
<li>需要判断的数据源名字</li>
<li>@returns {Boolean} 重名返回true<br>*/<br>CoolSourcePanel.prototype._equalDataSourceName = function(name) {<br> var datasourceName = this.getDataSourceName();<br> if (datasourceName) {<pre><code>var p = datasourceName.toUpperCase();
var m = name.toUpperCase();
return (p == m) || p.startsWith(m + &quot;,&quot;) || p.endsWith(&quot;,&quot; + m)
        || (p.indexOf(&quot;,&quot; + m + &quot;,&quot;) &gt; -1);
</code></pre> }<br> return false;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>获取某数据源的唯一名称，用于新建的时候初始化到数据源编辑框中 tag 名称前缀 rs olt aft return 名字<br>*/<br>CoolSourcePanel.prototype._getUniqueDataSourceName = function(tag) {<br> var i = 1;<br> var nm = “”;<br> while (i &lt; 200) {// 防止死循环<pre><code>nm = tag + i;
if (!this._equalDataSourceName(nm)) {
    break;
}
i++;
</code></pre> }<br> return nm;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>获得数据源的名字，用，分割<br>*</li>
<li><p>@returns {String}<br>*/<br>CoolSourcePanel.prototype.getDataSourceName = function() {<br> var name = “”;<br> // sql数据源<br> var sqlarr = this.sqlds.getAllChildItem();<br> for ( var i = 0; i &lt; sqlarr.length; i++) {</p>
<pre><code>name += sqlarr[i].name + &quot;,&quot;;
</code></pre><p> }</p>
<p> // oltp数据源<br> var oltparr = this.oltpds.getAllChildItem();<br> for ( var i = 0; i &lt; oltparr.length; i++) {</p>
<pre><code>name += oltparr[i].name + &quot;,&quot;;
</code></pre><p> }</p>
<p> // 主题表数据源<br> var aliasarr = this.aliasds.getAllChildItem();<br> for ( var i = 0; i &lt; aliasarr.length; i++) {</p>
<pre><code>name += aliasarr[i].name + &quot;,&quot;;
</code></pre><p> }</p>
<p> // 获得主题表名称<br> if (!this.factTableFlag) {</p>
<pre><code>this.getFactTableName();
</code></pre><p> }<br> if (this.factTableName) {</p>
<pre><code>name += this.factTableName;
</code></pre><p> }</p>
<p> return name;<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>获取指定类型的数据源名称，多个数据源名称用逗号分隔<br>*</li>
<li>@param dstype</li>
<li>数据源类型，sql/oltp/olap/facts等<br>*/<br>CoolSourcePanel.prototype.getDataSourceNames = function(dstype) {<br>if (!dstype)<br>return this.getDataSourceName();<br>var dstypeL = dstype.toLowerCase();<br>var dsname = “”;<br>if (“sql” === dstypeL) {<br>// sql数据源<br>var sqlarr = this.sqlds.getAllChildItem();<br>for ( var i = 0; i &lt; sqlarr.length; i++) {<br>dsname += sqlarr[i].name + “,”;<br>}<br>} else if (“oltp” == dstypeL) {<br>// oltp数据源<br>var oltparr = this.oltpds.getAllChildItem();<br>for ( var i = 0; i &lt; oltparr.length; i++) {<br>dsname += oltparr[i].name + “,”;<br>}<br>} else if (“facts” == dstypeL) {<br>// 主题表数据源<br>var aliasarr = this.aliasds.getAllChildItem();<br>for ( var i = 0; i &lt; aliasarr.length; i++) {<br>dsname += aliasarr[i].name + “,”;<br>}<br>}<br>dsname = dsname.substring(0, dsname.length - 1);<br>return dsname;<br>};</li>
</ul>
<p>/**</p>
<ul>
<li><p>获得主题表名称 建数据源时使用，数据源名不能和主题表名相同<br>*/<br>CoolSourcePanel.prototype.getFactTableName = function() {<br> var name = “”;<br> var self = this;<br> var params = new Map();<br> var taskid = g_dwSubjectSet.getTaskId();<br> params.put(“rid”, “EBI$11$” + taskid + “$/“);<br> QueryObj.create(“/panelrestree.do”, params, function(query) {</p>
<pre><code>try {
    query.checkResult();
    if (query.isResultOk()) {
        var result = query.getResponseJSON();
        for ( var i = 0; i &lt; result.length; i++) {
            var data = result[i];
            name += data.caption.split(&quot; &quot;)[0] + &quot;,&quot;;
        }

        self.factTableName = name;
        self.factTableFlag = true;
    }
} catch (e) {
    showError(e);
}
</code></pre><p> });</p>
</li>
</ul>
<p>};</p>
<p>/**</p>
<ul>
<li>展开时请求服务器获取子节点<br>*</li>
<li>@param item<br>*/<br>CoolSourcePanel.prototype._getChildNode = function(item) {<br> if (item.getChildrenCount() != 0) {<pre><code>return;
</code></pre> }<br> var self = this;<br> var params = new Map();<br> params.put(“rid”, item.getUserObj().id);<br> QueryObj.create(“/panelrestree.do”, params, function(query) {<pre><code>try {
    query.checkResult();
    if (query.isResultOk()) {
        var result = query.getResponseJSON();
        item.loadFrom(result, self._onLoadFinish.bind(self));
    }
} catch (e) {
    showError(e);
}
</code></pre> });<br>};</li>
</ul>
<p>/**</p>
<ul>
<li>展开后对节点的处理<br>*</li>
<li>@param item<br>*/<br>CoolSourcePanel.prototype._onLoadFinish = function(item) {<br> var dragtype = item.userObj.dragtype;<br> if (dragtype) {<pre><code>var dragDom = item.getItemDom().parentNode.firstChild;
var nodetable = item.nodeTable;
var id = undefined;
if (dragtype == &quot;ds_zb&quot;) {
    var dragparam = {
        zb : item.getParentItem().itemText.split(&quot; &quot;)[0] + &quot;.&quot;
                + item.itemText.split(&quot; &quot;)[0],
        userObj : item.userObj
    };
    dragDom.setAttribute(&quot;dragtype&quot;, dragtype);
    dragDom.setAttribute(&quot;dragparam&quot;, JSON.stringify(dragparam));
    id = dragparam[&quot;zb&quot;];
} else if (dragtype == &quot;ds_dim&quot;) {
    var dragparam = {
        name : item.userObj.dimname ? item.userObj.dimname : item
                .getParentItem().itemText,
        level : item.userObj.level,
        userObj : item.userObj
    };
    dragDom.setAttribute(&quot;dragtype&quot;, dragtype);
    dragDom.setAttribute(&quot;dragparam&quot;, JSON.stringify(dragparam));
    id = (item.userObj[&quot;id&quot;] || item.getParentItem().id)
            + (dragparam[&quot;level&quot;] || &quot;&quot;);
}
if (id) {
    nodetable.setAttribute(&quot;id&quot;, id);
    item.id = id;
}
</code></pre> }<br>};<br>CoolWidgetPanel.prototype.onHover = function(evt) {<br> var target = evt.target, id = target.id, cls = target.className;<br> var htmlWidgetPanel = this.htmlWidgetPanel;<br> evt.preventDefault();<br> evt.stopPropagation();<br> htmlWidgetPanel.cmd_previewHtmlWidgetForSave(evt);// 鼠标悬浮图片用<br> /*<ul>
<li>var design = g_dsn.getDesign(); if(design &amp;&amp; design.isVisible()){</li>
<li>design.dragStart(evt); }<br>*/<br>};<br>/**</li>
</ul>
</li>
<li><p>鼠标悬浮html组件图片专用<br>*/<br>CoolHTMLWidgetSubPanel.prototype.cmd_previewHtmlWidgetForSave = function(e) {<br> if (!this.previewpanel) {</p>
<pre><code>this.previewpanel = $(
        &quot;&lt;div class=&apos;preview_panel&apos;&gt;&lt;iframe frameborder=&apos;0&apos; width=&apos;100%&apos;, height=&apos;100%&apos;&gt;&lt;/iframe&gt;&lt;/div&gt;&quot;)
        .appendTo(this.doc.body)[0];
</code></pre><p> }<br> var body = this.panel.getContentDom();<br> this.previewpanel.style.cssText += “;left:” + (body.offsetWidth + 2)</p>
<pre><code>+ &quot;px;display:block;&quot;;
</code></pre><p> var widgetPath = e.target;<br> if (widgetPath.nodeName == “SPAN” &amp;&amp; widgetPath.getAttribute(“dragparam”)) {</p>
<pre><code>widgetPath = getXComponentByDom(e.target).id;
</code></pre><p> } else {</p>
<pre><code>this.previewpanel.style.display = &quot;none&quot;;
return false;
</code></pre><p> }<br> var wigId = widgetPath;<br> this.checkPosition(e);<br> var date = (new Date()).getTime();<br> // ?”+date+”<br> var self = this;<br> if (self.previewpanel) {</p>
<pre><code>self.previewpanel.style.display = &quot;none&quot;;
</code></pre><p> }<br> this._timer = setTimeout(</p>
<pre><code>function() {
    self.previewpanel.style.display = &quot;block&quot;;
    var imgPath = &quot;vfs&quot; + self.typepath + &quot;coolwidgetimg/&quot; + wigId
            + &quot;.png&quot;;
    if (self._timestamp) {
        imgPath += &quot;?&quot; + self._timestamp + &quot;&quot;;
    }

    self.previewpanel.innerHTML = &quot;&lt;img src=&apos;&quot;
            + imgPath
            + &quot;&apos; &quot;
            + &quot;style=&apos;display: inline-block;height: auto;max-width: 100%;max-height: 100%;&apos; /&gt;&quot;;
    $(self.previewpanel).addClass(&apos;preview_images&apos;);
}, 1000);
</code></pre><p> return false;<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li><p>重新加载（刷新）<br>*/<br>CoolHTMLWidgetSubPanel.prototype.cmd_reload = function(item) {<br> var self = this;<br> var map = new Map();<br> map.put(“action”, “reload”);<br> map.put(“basepath”, this.typepath);<br> QueryObj.create(CoolHTMLWidgetSubPanel.ACTION_URL, map, function(query) {</p>
<pre><code>try {
    query.checkResult();
    if (query.isResultOk()) {

        // 刷新内置组件
        var sysItem = self.getSysRootItem();
        sysItem.clearChildren();
        sysItem._loaded = false;
        self._onExpandTreeItem(sysItem);

        // 刷新自定义组件
        var usrItem = self.getUserRootItem();
        usrItem.clearChildren();
        usrItem._loaded = false;
        self._onExpandTreeItem(usrItem);
        self._timestamp = (new Date()).getTime();// 记录刷新的时间戳,悬浮图片专用
    }
} catch (e) {
    showError(e);
}
</code></pre><p> });<br>};</p>
</li>
</ul>
<p>/**</p>
<ul>
<li>检查鼠标位置,悬浮图片用<br><em>/<br>CoolHTMLWidgetSubPanel.prototype.checkPosition = function(e) {<br> var parentHeight = this.previewpanel.parentElement.offsetHeight;<br> if ((parentHeight </em> 0.5 + getCursorPosition(e, this.wnd).y) &gt; parentHeight) {<pre><code>this.previewpanel.style.top = &quot;auto&quot;;
this.previewpanel.style.cssText += &quot;;bottom:&quot; + 3 + &quot;px;left:&quot;
        + (this.panel.getContentDom().offsetWidth + 2)
        + &quot;px;display:block;&quot;;
</code></pre> } else {<pre><code>this.previewpanel.style.cssText += &quot;;top:&quot;
        + getCursorPosition(e, this.wnd).y + &quot;px;left:&quot;
        + (this.panel.getContentDom().offsetWidth + 2)
        + &quot;px;display:block;&quot;;
</code></pre> }<br>};<br>/**</li>
<li>判断请求的图片资源是否存在<br>*/<br>CoolHTMLWidgetSubPanel.prototype.CheckImgExists = function(imgurl) {<br> var ImgObj = new Image(); // 判断图片是否存在<br> ImgObj.src = imgurl;<br> // 没有图片，则返回-1<br> if (ImgObj.fileSize &gt; 0 || (ImgObj.width &gt; 0 &amp;&amp; ImgObj.height &gt; 0)) {<pre><code>return true;
</code></pre> } else {<pre><code>return false;
</code></pre> }<br>}<br>/**</li>
<li>销毁方法<br>*/<br>CoolSourcePanel.prototype.dispose = function() {<br> this.xTree.dispose();<br> this.factTableName = null;<br>};</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/18/java 解析xml文件/" rel="next" title="解析xml">
                <i class="fa fa-chevron-left"></i> 解析xml
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/15/api文档/" rel="prev" title="Pshare api文档">
                Pshare api文档 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://avatars1.githubusercontent.com/u/18373908?s=400&u=026b7daa8652066dead5a989dd5e14fca44ee5dd&v=4"
                alt="DEMO" />
            
              <p class="site-author-name" itemprop="name">DEMO</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">351</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jack00000" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i></a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#2019-1-20"><span class="nav-number">1.</span> <span class="nav-text">2019-1-20</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-代码比较啦一下-又全改啦"><span class="nav-number">1.1.</span> <span class="nav-text">1.代码比较啦一下  又全改啦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-测试生成-其他-主题集-的代码"><span class="nav-number">1.2.</span> <span class="nav-text">2.测试生成 其他 主题集 的代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#需求"><span class="nav-number">1.3.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#需求-1"><span class="nav-number">1.4.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#需求-2"><span class="nav-number">1.5.</span> <span class="nav-text">需求</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">DEMO</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v6.0.6</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
  







  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.6"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.6"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.6"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.6"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.6"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'oE8EtVBE3BRVVm3BrVTOfvEa-gzGzoHsz',
        appKey: 'q0zNeBPiVHGUwVwXEsSwWxmn',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=6.0.6"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=6.0.6"></script>


  

</body>
</html>
